/*!
 * Jslet Javascript Framework v4.0.0
 * https://github.com/jslet/jslet/
 *
 * Copyright 2016 Jslet Team
 * Released under GNU AGPL v3.0 license
 */
 
"use strict";!function(e,t){"function"==typeof define?define.amd?define("jslet-data",["jquery","jslet-locale"],t):define(function(require,e,a){var r=require("jslet-locale"),l=require("jquery");a.exports=t(l,r)}):t(window.jQuery,window.jsletlocale)}(this,function(jQuery,jsletlocale){if(void 0!==window.jslet&&void 0!==jslet||(window.jslet=function(e){var t=jQuery(e)[0];return t&&t.jslet?t.jslet:null}),void 0!==window.jslet&&void 0!==jslet||(window.jslet=function(e){"string"==typeof e&&"#"!=e[0]&&(e="#"+e);var t=jQuery(e)[0];return t&&t.jslet?t.jslet:null}),!jslet.rootUri){var ohead=window.document.getElementsByTagName("head")[0],uri=ohead.lastChild.src;uri&&(uri=uri.substring(0,uri.lastIndexOf("/")+1),jslet.rootUri=uri)}return jslet.global={version:"4.0.0",changeStateField:"rs",selectStateField:"_sel_",auditLogField:"al",valueSeparator:",",defaultRecordClass:null,defaultFocusKeyCode:9,defaultCharWidth:12,debugMode:!0},jslet.global.serverErrorHandler=function(e,t){return!1},jslet.global.beforeSubmit=function(e){return e},jslet.global.afterInstall=function(e){},jslet.global.importDialog={onQuerySchema:null,onSubmitSchema:null},jslet.global.exportDialog={onQuerySchema:null,onSubmitSchema:null},jslet.global.dataset={onDatasetCreating:function(e,t){},onDatasetCreated:function(e){}},jslet.toArray=function(e){if(!e)return[];if("toArray"in Object(e))return e.toArray();for(var t=e.length||0,a=new Array(t);t--;)a[t]=e[t];return a},jslet.extend=function(e,t){for(var a in t)e[a]=t[a];return e},jslet.emptyFunction=function(){},jslet.keys=function(e){var t=[];if("object"!=typeof e)return t;for(var a in e)e.hasOwnProperty(a)&&t.push(a);return t},jslet.extend(Function.prototype,function(){function e(e,t){for(var a=e.length,r=t.length;r--;)e[a+r]=t[r];return e}function t(t,a){return t=u.call(t,0),e(t,a)}function a(){var e=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=e.length||e[0]?e:[]}function r(e){if(arguments.length<2&&"undefined"==typeof arguments[0])return this;var a=this,r=u.call(arguments,1);return function(){var l=t(r,arguments);return a.apply(e,l)}}function l(t){var a=this,r=u.call(arguments,1);return function(l){var i=e([l||window.event],r);return a.apply(t,i)}}function i(){if(!arguments.length)return this;var e=this,a=u.call(arguments,0);return function(){var r=t(a,arguments);return e.apply(this,r)}}function s(e){var t=this,a=u.call(arguments,1);return e=1e3*e,window.setTimeout(function(){return t.apply(t,a)},e)}function n(){var t=e([.01],arguments);return this.delay.apply(this,t)}function o(t){var a=this;return function(){var r=e([a.bind(this)],arguments);return t.apply(this,r)}}function d(){if(this._methodized)return this._methodized;var t=this;return this._methodized=function(){var a=e([this],arguments);return t.apply(null,a)},this._methodized}var u=Array.prototype.slice;return{argumentNames:a,bind:r,bindAsEventListener:l,curry:i,delay:s,defer:n,wrap:o,methodize:d}}()),jslet.Class=function(){function e(){}function t(){function t(){this.initialize.apply(this,arguments)}var a=null,r=jslet.toArray(arguments);jslet.isFunction(r[0])&&(a=r.shift()),jslet.extend(t,jslet.Class.Methods),t.superclass=a,t.subclasses=[],a&&(e.prototype=a.prototype,t.prototype=new e,a.subclasses.push(t));for(var l=0,i=r.length;i>l;l++)t.addMethods(r[l]);return t.prototype.initialize||(t.prototype.initialize=jslet.emptyFunction),t.prototype.constructor=t,t}function a(e){var t=this.superclass&&this.superclass.prototype,a=jslet.keys(e);r&&(e.toString!=Object.prototype.toString&&a.push("toString"),e.valueOf!=Object.prototype.valueOf&&a.push("valueOf"));for(var l=jslet.isFunction,i=0,s=a.length;s>i;i++){var n=a[i],o=e[n];if(t&&l(o)&&"$super"==o.argumentNames()[0]){var d=o;o=function(e){return function(){return t[e].apply(this,arguments)}}(n).wrap(d),o.valueOf=d.valueOf.bind(d),o.toString=d.toString.bind(d)}this.prototype[n]=o}return this}var r=function(){for(var e in{toString:1})if("toString"===e)return!1;return!0}();return{create:t,Methods:{addMethods:a}}}(),jslet._AUTOID=0,jslet.nextId=function(){return"jslet"+jslet._AUTOID++},jslet.data||(jslet.data={}),jslet.temp||(jslet.temp={}),Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0,a=this.length;a>t;t++)if(this[t]==e)return t;return-1}),String.prototype.trim||(String.prototype.trim=function(){this.replace(/^\s+/,"").replace(/\s+$/,"")}),String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.lastIndexOf(e,0)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){var t=this.length-e.length;return t>=0&&this.indexOf(e,t)===t}),FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(e){var t=this,a="",r=new FileReader;r.onload=function(e){for(var l=new Uint8Array(r.result),i=l.byteLength,s=0;i>s;s++)a+=String.fromCharCode(l[s]);t.content=a,jQuery(t).trigger("onload")},r.readAsArrayBuffer(e)}),jslet.trim=function(e){return jQuery.trim(e)},jslet.debounce=function(e,t,a){var r;return function(){var a=this,l=arguments;if(!t)return void e.apply(a,l);var i=function(){r=null,e.apply(a,l)};r&&clearTimeout(r),r=setTimeout(i,t)}},jslet.deepClone=function(e){if(void 0===e||null===e||e===!0||e===!1)return e;if(jslet.isString(e)||jslet.isNumber(e))return e;if(jslet.isDate(e))return new Date(e.getTime());var t;if(jslet.isArray(e)){t=[];for(var a=0,r=e.length;r>a;a++)t[a]=jslet.deepClone(e[a]);return t}t=e.constructor==Object?new e.constructor:new e.constructor(e.valueOf());for(var l in e)t[l]!=e[l]&&("object"==typeof e[l]?t[l]=jslet.deepClone(e[l]):t[l]=e[l]);return t},jslet.formatMessage=function(e,t){if(jslet.Checker.test("jslet.formatMessage#msg",e).required().isString(),void 0===t||null===t)return e;t===!1&&(t="false"),t===!0&&(t="true");var a,r,l=e;if(jslet.isArray(t))for(a=t.length,r=0;a>r;r++)l=l.replace("{"+r+"}",t[r]);else{if(!jslet.isObject(t))return e.replace("{0}",t);for(var i in t)l=l.replace("{"+i+"}",t[i])}return l},jslet.formatString=function(e,t){if(!t||!e)return e;jslet.Checker.test("jslet.formatString#displayFormat",t).isString();for(var a,r,l=e.length,i=t.length,s=i-1,n=-1,o="",d=0;i>d;d++)if(a=t[d],"\\"===a&&s>d&&(r=t[d+1],"#"===r))o+="#",d++;else if("#"===a){if(n++,n===l)break;o+=e[n]}else o+=a;return o},jslet._SCALEFACTOR="100000000000000000000000000000000000",jslet.formatNumber=function(e,t){if(!e&&0!==e)return"";if(!t)return e+"";var a,r,l="";for(r=0;r<t.length;r++)if(a=t.substr(r,1),"#"==a||"0"==a||","==a){r>0&&(l=t.substr(0,r),t=t.substr(r));break}var i="";for(r=t.length-1;r>=0;r--)if(a=t.substr(r,1),"#"==a||"0"==a||","==a){r>0&&(i=t.substr(r+1),t=t.substr(0,r+1));break}var s=t?t.split("."):[""],n=0;s.length>1&&(n=s[1].length);var o=e?e.toString().split("."):["0"],d=0;if(o.length>1&&(d=o[1].length),d>n){var u=parseInt(jslet._SCALEFACTOR.substring(0,n+1));e=Math.round(e*u)/u,o=e?e.toString().split("."):["0"]}var c="",f=o[0],h=f[0];"-"===h||"+"===h?f=f.substring(1):h=null;var v,_=s[0],g=!1,p=f.length-1;for(v=_.length-1;v>=0;v--)switch(_.substr(v,1)){case"#":p>=0&&(c=f.substr(p--,1)+c);break;case"0":c=p>=0?f.substr(p--,1)+c:"0"+c;break;case",":g=!0,c=","+c}if(p>=0)if(g)for(var F=f.length;p>=0;p--)c=f.substr(p,1)+c,p>0&&(F-p)%3===0&&(c=","+c);else c=f.substr(0,p+1)+c;c=c.replace(/^,+/,""),f=o.length>1?o[1]:"",_=s.length>1?s[1]:"",p=0;var j="";for(v=0;v<_.length;v++)switch(_.substr(v,1)){case"#":p<f.length&&(j+=f.substr(p++,1));break;case"0":j+=p<f.length?f.substr(p++,1):"0"}return j&&(c=c+"."+j),h&&(c=h+c),l+c+i},jslet.formatDate=function(e,t){if(!e)return"";jslet.Checker.test("jslet.formatDate#date",e).isDate(),jslet.Checker.test("jslet.formatDate#format",t).required().isString();var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in a)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[r]:("00"+a[r]).substr((""+a[r]).length)));return t},jslet.parseDate=function(e,t){if(!e)return null;jslet.Checker.test("jslet.parseDate#strDate",e).isString(),jslet.Checker.test("jslet.parseDate#format",t).required().isString();for(var a,r,l=null,i=-1,s=0,n={y:0,M:0,d:0,h:0,m:0,s:0,S:0},o=0,d=t.length;d>o;o++)if(a=t.charAt(o),a!=l){if(l&&void 0!==n[l]&&i>=0){if(s=o,r=parseInt(e.substring(i,s)),isNaN(r))throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidDate,[t]));n[l]=r}i=o,l=a}if(i>=0){if(r=parseInt(e.substring(i)),isNaN(r))throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidDate,[t]));n[a]=r}var u=n.y;100>u&&(u+=2e3);var c=new Date(u,n.M-1,n.d,n.h,n.m,n.s,n.S);return c},Date.prototype.toJSON=function(){return jslet.formatDate(this,"yyyy-MM-ddThh:mm:ss")},jslet.convertISODate=function(e){if(!e)return null;if(jslet.isDate(e))return e;var t=e.substr(10,1);if(10===e.length||"T"==t){var a=e.substr(0,4),r=e.substr(5,2),l=e.substr(8,2),i=e.substr(11,2),s=e.substr(14,2),n=e.substr(17,2);return"Z"==e.substr(-1,1)?new Date(Date.UTC(+a,+r-1,+l,+i,+s,+n)):new Date(+a,+r-1,+l,+i,+s,+n)}return e},jslet._currentPattern={},jslet._convertToJsPattern=function(e,t){if(jslet._currentPattern.pattern==e&&jslet._currentPattern.escapeChar==t)return jslet._currentPattern.result;jslet._currentPattern.pattern=e,jslet._currentPattern.escapeChar=t;var a,r,l=[],i=e.length-1,s=0,n=i,o=!1,d=!1;"%"==e.charAt(0)&&(s=1,o=!0),"%"==e.charAt(i)&&(n=i-1,d=!0),o&&d?l.push(".*"):d&&l.push("^");for(var u=s;n>=u;u++)if(a=e.charAt(u),(t&&t==a||"\\"==a)&&i>u){if(r=e.charAt(u+1),"%"==r||"_"==r){l.push(r),u++;continue}}else"_"==a?l.push("."):("."!=a&&"*"!=a&&"["!=a&&"]"!=a&&"{"!=a&&"}"!=a&&"+"!=a&&"("!=a&&")"!=a&&"\\"!=a&&"?"!=a&&"$"!=a&&"^"!=a||l.push("\\"),l.push(a));return o&&d||d?l.push(".*"):o&&l.push("$"),jslet._currentPattern.result=new RegExp(l.join(""),"ig"),jslet._currentPattern.result},jslet.like=function(e,t,a){if(!e||!t)return!1;if(0===t.length)return!1;a||(a="\\");var r=jslet._convertToJsPattern(t,a);return jslet.isString(e)||(e+=""),null!==e.match(r)},jslet.between=function(e,t,a){if(arguments.length<=1)return!1;var r=!0,l=!0;return null!==t&&void 0!==t&&(r=jslet.compareValue(e,t)>=0),null!==a&&void 0!==a&&(l=jslet.compareValue(e,a)<=0),r&&l},jslet.inlist=function(e,t){var a=arguments.length;if(2>a)return!1;for(var r=1;a>r;r++)if(0===jslet.compareValue(e,arguments[r]))return!0;return!1},jslet.inArray=function(e,t){if(!e||!t)return!1;for(var a=0,r=t.length;r>a;a++)if(0===jslet.compareValue(e,t[a]))return!0;return!1},jslet.isArray=function(e){return null===e||void 0===e||"[object Array]"===Object.prototype.toString.apply(e)},jslet.isDate=function(e){return null===e||void 0===e||e.constructor==Date},jslet.isString=function(e){return null===e||void 0===e||"string"==typeof e},jslet.isFunction=function(e){return jQuery.isFunction(e)},jslet.isPromise=function(e){return e&&e.done&&jslet.isFunction(e.done)},jslet.isNumber=function(e){return null===e||void 0===e||jQuery.isNumeric(e)},jslet.isObject=function(e){return null===e||void 0===e||"object"==jQuery.type(e)},jslet.isHTMLElement=function(e){return null===e||void 0===e||e instanceof HTMLElement},jslet.isEmpty=function(e){if(null===e||void 0===e||""===e)return!0;if(jslet.isArray(e)){for(var t=e,a=!0,r=0,l=t.length;l>r;r++)if(!jslet.isEmpty(t[r])){a=!1;break}return a}return!1},jslet.setTimeout=function(e,t,a){jslet.delayFunc=function(){t.call(e)},setTimeout(jslet.delayFunc,a)},jslet.compareValue=function(e,t,a,r){if(e=void 0===e?null:e,t=void 0===t?null:t,e===t)return 0;if(null===e&&null!==t)return-1;if(null===t&&null!==e)return 1;var l=jslet.isString(e),i=jslet.isString(t);if(!l&&!i)return jslet.isDate(e)&&(e=e.getTime(),t=t.getTime()),e==t?0:t>e?-1:1;if(l||(e+=""),i||(t+=""),a||(e=e.toLowerCase(),t=t.toLowerCase()),void 0===r||r){var s=e.localeCompare(t);return 0===s?0:0>s?-1:1}return e==t?0:t>e?-1:1},jslet.htmlEncode=function(e){return e?jQuery("<div />").text(e).html():""},jslet.htmlDecode=function(e){return e?jQuery("<div />").html(e).text():""},jslet.getArrayValue=function(e,t){if(!e)return null;if(jslet.isArray(e)){var a=e.length;return a>t?e[t]:null}return e},jslet.Checker={varName:null,varValue:null,test:function(e,t){return this.varName=e,this.varValue=t,this},testValue:function(e){return this.varValue=e,this},required:function(){if(null===this.varValue||void 0===this.varValue||""===this.varValue)throw new Error(jslet.formatMessage(jsletlocale.Checker.required,[this.varName]));return this},isBoolean:function(){if(null!==this.varValue&&void 0!==this.varValue&&""!==this.varValue&&0!==this.varValue&&this.varValue!==!0&&this.varValue!==!1)throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredBooleanValue,[this.varName]));return this},isString:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isString(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredStringValue,[this.varName,this.varValue]));return this},isDate:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isDate(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredDateValue,[this.varName,this.varValue]));return this},isNumber:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jQuery.isNumeric(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredNumbericValue,[this.varName,this.varValue]));return this},isGTZero:function(){if(this.isNumber(),null===this.varValue||void 0===this.varValue)return this;if(this.varValue<=0)throw new Error(jslet.formatMessage(jsletlocale.Checker.greatThanZero,[this.varName,this.varValue]));return this},isGTEZero:function(){if(this.isNumber(),null===this.varValue||void 0===this.varValue)return this;if(this.varValue<0)throw new Error(jslet.formatMessage(jsletlocale.Checker.greatThanEqualZero,[this.varName,this.varValue]));return this},between:function(e,t){if(null===this.varValue||void 0===this.varValue)return this;var a=null!==e&&void 0!==e,r=null!==t&&void 0!==t;if(a&&r&&(this.varValue<e||this.varValue>t))throw new Error(jslet.formatMessage(jsletlocale.Checker.betweenValue,[this.varName,this.varValue,e,t]));if(!a&&r&&this.varValue>t)throw new Error(jslet.formatMessage(jsletlocale.Checker.lessThanMaxValue,[this.varName,this.varValue,t]));if(a&&!r&&this.varValue<e)throw new Error(jslet.formatMessage(jsletlocale.Checker.betweenValue,[this.varName,this.varValue,e]));return this},isArray:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isArray(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredArrayValue,[this.varName,this.varValue]));return this},isObject:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&"object"!==jQuery.type(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredObjectValue,[this.varName,this.varValue]));return this},isPlanObject:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jQuery.isPlainObject(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredPlanObjectValue,[this.varName,this.varValue]));return this},isHTMLElement:function(){if(null!==this.varValue&&void 0!==this.varValue&&!jslet.isHTMLElement(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredHtmlElement,[this.varName,this.varValue]));return this},isFunction:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isFunction(this.varValue))throw new Error(jslet.formatMessage(jsletlocale.Checker.requiredFunctionValue,[this.varName,this.varValue]));return this},isClass:function(e){if(this.isObject(),null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&this.varValue.className!=e)throw new Error(jslet.formatMessage(jsletlocale.Checker.instanceOfClass,[this.varName,this.varValue,e]));return this},isDataType:function(e){return"S"==e&&this.isString(),"N"==e&&this.isNumber(),"D"==e&&this.isDate(),this},inArray:function(e){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&e.indexOf(this.varValue)<0)throw new Error(jslet.formatMessage(jsletlocale.Checker.inArray,[this.varName,this.varValue,e.join(",")]));return this}},jslet.JSON={normalize:function(e){var t,a=[],r=!1,l=!1,i=!0,s="",n=null,o=!1;t=e.charAt(0),"{"!=t&&"["!=t&&(a.push('{"'),o=!0);for(var d=0,u=e.length;u>d;d++)t=e.charAt(d),n?t==n?(n=null,a.push('"'),s='"'):a.push(t):("["==t&&(l=!0,i=!1),"]"!=t&&"{"!=t||(l=!1,i=!0),(!r||" "!=t&&"\b"!=t)&&(!i||"{"!=t&&","!=t?("{"!=s&&","!=s||a.push('"'),r&&"'"==t?a.push('"'):(":"==t&&(r=!1,'"'!=s&&a.push('"')),r||"'"!=t&&'"'!=t?(s=t,a.push(t)):(n=t,a.push('"')))):(r=!0,a.push(t),s=t)));return o&&a.push("}"),a.join("")},parse:function(e){try{return JSON.parse(e)}catch(t){throw new Error(jslet.formatMessage(jsletlocale.Common.jsonParseError,[e]))}},stringify:function(e,t,a){return JSON.stringify(e,t,a)}},jslet.getFunction=function(e,t){if(!e)return null;if(jslet.isFunction(e))return e;t||(t=window);var a=t[e];return a||console.warn("NOT found function:"+e),a},jslet.cutString=function(e,t){if(!e||!t)return e;var a=new RegExp(t,"g");return e.replace(a,"")},jslet.getYear=function(e){return e&&jslet.isDate(e)?e.getFullYear():0},jslet.getMonth=function(e){return e&&jslet.isDate(e)?e.getMonth()+1:0},jslet.getYearMonth=function(e){return e&&jslet.isDate(e)?100*e.getFullYear()+e.getMonth()+1:0},jslet.removeHtmlTag=function(e){return e?e.indexOf("<")<0?e:e.replace(/<(?:.|\s)*?>/g,""):e},jslet.showError=function(e,t){var a;a="string"==typeof e?e:e.message,jslet.ui&&jslet.ui.error?jslet.ui.error(a,null,t):window.alert(a)},jslet.showInfo=function(e,t,a){var r;r="string"==typeof e?e:e.message,jslet.ui&&jslet.ui.info?jslet.ui.info(r,null,t,a):window.alert(r)},jslet.urlUtil={getDomain:function(e){return e.replace(/([^:]+:\/\/[^\/]+).*/,"$1")},addParam:function(e,t){if(jslet.Checker.test("addParam#url",e).required().isString(),!t)return e;jslet.Checker.test("addParam#param",t).isPlanObject();var a="",r=e.indexOf("#");r>=0&&(a=e.substring(r),e=e.substring(0,r));var l=jslet.urlUtil.getParams(e)||{};for(var i in t)l[i]=escape((t[i]+"").trim());var s="";r=0;for(i in l)s+=(r++?"&":"")+i+"="+l[i];return r=e.indexOf("?"),r>=0&&(e=e.substring(0,r)),e+="?"+s+a},addHash:function(e,t){if(jslet.Checker.test("addUrlParam#url",e).required().isString(),!t)return e;var a=e.indexOf("#");return e=e+(a>=0?"":"#")+t},getParams:function(e){if(jslet.Checker.test("getParams#url",e).required().isString(),t=e.indexOf("?"),0>t)return null;var e=e.substr(t+1),t=e.indexOf("#");t>=0&&(e=e.substring(0,t));for(var a=e.split("&"),r={},l=0;l<a.length;l++){var i=a[l].split("=");r[i[0]]=i[1]}return r},getParam:function(e,t){jslet.Checker.test("getParam#paramName",t).required().isString();var a=this.getParams(e);return a?a[t]:null},getHash:function(e){jslet.Checker.test("getHash#url",e).required().isString();var t=e.indexOf("#");if(0>t)return null;var a=e.substring(t+1);return t=a.indexOf("?"),t>=0&&(a=a.substring(0,t)),a}},jslet.StepProcessor=function(e,t,a){jslet.Checker.test("jslet.StepProcessor#count",e).isGTZero(),jslet.Checker.test("jslet.StepProcessor#processingFn",t).isFunction(),jslet.Checker.test("jslet.StepProcessor#steps",a).isNumber().between(1,100);var e=e,r=[],l=0;if(a||(a=10),a>=e)r.push([0,e-1,100]);else for(var i,s,n,o=Math.ceil(e/a),d=Math.ceil(e/o),u=d-1,c=parseInt(100/a),f=0;u>=f;f++)i=f*o,s=(f+1)*o-1,s>=e&&(s=e-1),n=u>f?(f+1)*c:100,r.push([i,s,n]);var h=function(){var e=r[l++],a=t(e[0],e[1],e[2]);if(a!==!1&&l!=r.length){window.setTimeout(function(){h()},2)}};this.run=function(){l=0,h()}},jslet.Synchronizer=function(e,t){jslet.Checker.test("Synchronizer#taskCount",e).required().isGTEZero(),jslet.Checker.test("Synchronizer#doneFn",t).required().isFunction(),this._taskCount=e,this._doneFn=t},jslet.Synchronizer.prototype={endTask:function(){this._taskCount--,0===this._taskCount&&this._doneFn()}},jslet.data.ContextRule=function(e){var t=this;t._name="",t._description="",t._status=void 0,t._selected=void 0,t._condition=void 0,t._rules=null,t._otherwise=null,t._create(e)},jslet.data.ContextRule.className="jslet.data.ContextRule",jslet.data.ContextRule.prototype={className:jslet.data.ContextRule.className,dataStatus:["insert","update","other"],_create:function(e){function t(e){var t=new jslet.data.ContextRuleItem(e.field);return void 0!==e.meta&&t.meta(a(e.meta)),void 0!==e.value&&t.value(e.value),void 0!==e.lookup&&t.lookup(r(e.lookup)),void 0!==e.customized&&t.customized(e.customized),t}function a(e){var t=new jslet.data.ContextRuleMeta;return void 0!==e.label&&t.label(e.label),void 0!==e.tip&&t.tip(e.tip),void 0!==e.nullText&&t.nullText(e.nullText),void 0!==e.required&&t.required(e.required),void 0!==e.disabled&&t.disabled(e.disabled),void 0!==e.readOnly&&t.readOnly(e.readOnly),void 0!==e.visible&&t.visible(e.visible),void 0!==e.formula&&t.formula(e.formula),void 0!==e.scale&&t.scale(e.scale),void 0!==e.required&&t.required(e.required),void 0!==e.displayFormat&&t.displayFormat(e.displayFormat),void 0!==e.editMask&&t.editMask(e.editMask),void 0!==e.editControl&&t.editControl(e.editControl),void 0!==e.range&&t.range(e.range),void 0!==e.regularExpr&&t.regularExpr(e.regularExpr),void 0!==e.valueCountLimit&&t.valueCountLimit(e.valueCountLimit),void 0!==e.validChars&&t.validChars(e.validChars),void 0!==e.customValidator&&t.customValidator(e.customValidator),t}function r(e){var t=new jslet.data.ContextRuleLookup;return void 0!==e.dataset&&t.dataset(e.dataset),void 0!==e.filter&&t.filter(e.filter),void 0!==e.fixedFilter&&t.fixedFilter(e.fixedFilter),void 0!==e.criteria&&t.criteria(e.criteria),void 0!==e.displayFields&&t.displayFields(e.displayFields),void 0!==e.onlyLeafLevel&&t.onlyLeafLevel(e.onlyLeafLevel),t}jslet.Checker.test("ContextRule.contextRuleConfig",e).required().isPlanObject();var l=this;void 0!==e.status&&l.status(e.status),void 0!==e.selected&&l.selected(e.selected),void 0!==e.condition&&l.condition(e.condition);var i,s,n,o=e.rules;if(void 0!==o)for(jslet.Checker.test("ContextRule.rules",o).isArray(),n=[],l.rules(n),i=0,s=o.length;s>i;i++)n.push(t(o[i]));var d=e.otherwise;if(void 0!==d)for(jslet.Checker.test("ContextRule.otherwise",d).isArray(),n=[],l.otherwise(n),i=0,s=d.length;s>i;i++)n.push(t(d[i]))},name:function(e){return void 0===e?this._name:(jslet.Checker.test("ContextRule.name",e).isString(),this._name=jQuery.trim(e),this)},status:function(e){if(void 0===e)return this._status;if(jslet.Checker.test("ContextRule.status",e).isArray(),e)for(var t,a,r=0,l=e.length;l>r;r++)t=jQuery.trim(e[r]),a=jslet.Checker.test("ContextRule.status"+r,t).isString().required(),t=t.toLowerCase(),a.testValue(t).inArray(this.dataStatus),e[r]=t;return this._status=e,this},selected:function(e){return void 0===e?this._selected:void(this._selected=!!e)},condition:function(e){return void 0===e?this._condition:(jslet.Checker.test("ContextRule.condition",e).isString(),this._condition=jQuery.trim(e),this)},rules:function(e){return void 0===e?this._rules:(jslet.Checker.test("ContextRule.rules",e).isArray(),this._rules=e,this)},otherwise:function(e){return void 0===e?this._otherwise:(jslet.Checker.test("ContextRule.otherwise",e).isArray(),this._otherwise=e,this)}},jslet.data.ContextRuleItem=function(e){var t=this;jslet.Checker.test("ContextRule.field",e).isString(),e=jQuery.trim(e),jslet.Checker.test("ContextRule.field",e).required(),t._field=e,t._meta=void 0,t._value=void 0,t._lookup=void 0,t._customized=void 0},jslet.data.ContextRuleItem.className="jslet.data.ContextRuleItem",jslet.data.ContextRuleItem.prototype={className:jslet.data.ContextRuleItem.className,field:function(){return this._field},meta:function(e){return void 0===e?this._meta:(jslet.Checker.test("ContextRuleItem.meta",e).isClass(jslet.data.ContextRuleMeta.className),this._meta=e,this)},lookup:function(e){return void 0===e?this._lookup:(jslet.Checker.test("ContextRuleItem.lookup",e).isClass(jslet.data.ContextRuleLookup.className),this._lookup=e,this)},value:function(e){return void 0===e?this._value:(this._value=e,this)},customized:function(e){return void 0===e?this._customized:(jslet.Checker.test("ContextRuleItem.customized",e).isFunction(),this._customized=e,this)}},jslet.data.ContextRuleMeta=function(){var e=this;e._label=void 0,e._tip=void 0,e._nullText=void 0,e._required=void 0,e._disabled=void 0,e._readOnly=void 0,e._visible=void 0,e._formula=void 0,e._scale=void 0,e._defaultValue=void 0,e._displayFormat=void 0,e._editMask=void 0,e._editControl=void 0,e._range=void 0,e._regularExpr=void 0,e._valueCountLimit=void 0,e._validChars=void 0,e._customValidator=void 0},jslet.data.ContextRuleMeta.className="jslet.data.ContextRuleMeta",jslet.data.ContextRuleMeta.prototype={className:jslet.data.ContextRuleMeta.className,properties:["label","tip","nullText","required","disabled","readOnly","visible","formula","scale","defaultValue","displayFormat","editMask","editControl","range","regularExpr","valueCountLimit","validChars","customValidator"],label:function(e){return void 0===e?this._label:(jslet.Checker.test("ContextRuleMeta.label",e).isString(),this._label=e,this)},tip:function(e){return void 0===e?this._tip:(jslet.Checker.test("ContextRuleMeta.tip",e).isString(),this._tip=e,this)},nullText:function(e){return void 0===e?this._nullText:(jslet.Checker.test("ContextRuleMeta.nullText",e).isString(),this._nullText=jQuery.trim(e),this)},required:function(e){var t=this;return void 0===e?t._required:(t._required=!!e,this)},visible:function(e){var t=this;return void 0===e?t._visible:(t._visible=!!e,this)},disabled:function(e){var t=this;return void 0===e?t._disabled:(t._disabled=!!e,this)},readOnly:function(e){var t=this;return void 0===e?t._readOnly:(t._readOnly=!!e,this)},editMask:function(e){var t=this;return void 0===e?t._editMask:(t._editMask=e,this)},scale:function(e){var t=this;return void 0===e?t._scale:(jslet.Checker.test("ContextRuleMeta.scale",e).isNumber(),t._scale=parseInt(e),this)},formula:function(e){var t=this;return void 0===e?t._formula:(jslet.Checker.test("ContextRuleMeta.formula",e).isString(),t._formula=jQuery.trim(e),this)},displayFormat:function(e){var t=this;return void 0===e?t._displayFormat:(jslet.Checker.test("ContextRuleMeta.format",e).isString(),t._displayFormat=jQuery.trim(e),this)},editControl:function(e){var t=this;return void 0===e?t._editControl:void(t._editControl="string"==typeof e?{type:e}:e)},defaultValue:function(e){var t=this;return void 0===e?t._defaultValue:(t._defaultValue=e,this)},range:function(e){var t=this;return void 0===e?t._range:(jslet.isString(e)?t._range=new Function("return "+e):t._range=e,this)},regularExpr:function(e){var t=this;return void 0===e?t._regularExpr:(jslet.isString(e)?t._regularExpr=new Function("return "+e):t._regularExpr=e,this)},valueCountLimit:function(e){var t=this;return void 0===e?t._valueCountLimit:(jslet.Checker.test("ContextRuleMeta.valueCountLimit",e).isNumber(),t._valueCountLimit=parseInt(e),this)},customValidator:function(e){var t=this;return void 0===e?t._customValidator:(jslet.Checker.test("ContextRuleMeta.customValidator",e).isFunction(),t._customValidator=e,this)},validChars:function(e){var t=this;return void 0===e?t._validChars:(jslet.Checker.test("ContextRuleMeta.validChars",e).isString(),void(t._validChars=jQuery.trim(e)))}},jslet.data.ContextRuleLookup=function(){var e=this;e._dataset=void 0,e._filter=void 0,e._fixedFilter=void 0,e._criteria=void 0,e._displayFields=void 0,e._onlyLeafLevel=void 0},jslet.data.ContextRuleLookup.className="jslet.data.ContextRuleLookup",jslet.data.ContextRuleLookup.prototype={className:jslet.data.ContextRuleLookup.className,properties:["dataset","filter","fixedFilter","criteria","displayFields","onlyLeafLevel"],dataset:function(e){var t=this;return void 0===e?t._dataset:(jslet.Checker.test("ContextRuleLookup.dataset",e).isString(),void(t._dataset=jQuery.trim(e)))},filter:function(e){var t=this;return void 0===e?t._filter:(jslet.Checker.test("ContextRuleLookup.filter",e).isString(),void(t._filter=jQuery.trim(e)))},fixedFilter:function(e){var t=this;return void 0===e?t._fixedFilter:(jslet.Checker.test("ContextRuleLookup.fixedFilter",e).isString(),void(t._fixedFilter=jQuery.trim(e)))},criteria:function(e){var t=this;return void 0===e?t._criteria:(jslet.Checker.test("ContextRuleLookup.criteria",e).isString(),void(t._criteria=jQuery.trim(e)))},displayFields:function(e){var t=this;return void 0===e?t._displayFields:(jslet.Checker.test("ContextRuleLookup.displayFields",e).isString(),void(t._displayFields=jQuery.trim(e)))},onlyLeafLevel:function(e){var t=this;return void 0===e?t._onlyLeafLevel:void(t._onlyLeafLevel=!!e)}},jslet.data.ContextRuleEngine=function(e){this._dataset=e,this._matchedRules=[],this._ruleEnv={}},jslet.data.ContextRuleEngine.prototype={compile:function(){for(var e=this._dataset.contextRules(),t=0,a=e.length;a>t;t++)this._compileOneRule(e[t])},evalRule:function(e){var t,a=this._dataset.contextRules();this._matchedRules=[],this._ruleEnv={};for(var r=0,l=a.length;l>r;r++)t=a[r],this._evalOneRule(t,e);this._syncMatchedRules(e)},_compileOneRule:function(e){e.condition;this._compileExpr(e,"condition",!0);for(var t=e.rules(),a=0,r=t.length;r>a;a++)this._compileRuleItem(t[a])},_compileRuleItem:function(e){this._compileExpr(e,"value");var t,a,r,l,i=e.meta();if(i)for(t=i.properties,l=t.length,r=0;l>r;r++)a=t[r],this._compileExpr(i,a);var s=e.lookup();if(s)for(t=s.properties,l=t.length,r=0;l>r;r++)a=t[r],this._compileExpr(s,a)},_compileExpr:function(e,t,a){var r=e[t].call(e),l=t+"Expr";null!==r&&void 0!==r&&jslet.isString(r)&&(0===r.indexOf("expr:")&&(r=r.substring(5),a=!0),a&&(e[l]=new jslet.data.Expression(this._dataset,r)))},_evalOneRule:function(e,t){var a=!1,r=e.conditionExpr,l=null,i=!1;if(r){if(l=r.mainFields(),t&&l&&l.indexOf(t)<0)return;a=r.eval(),i=!0}if(!i||a){var s=e.status();if(void 0!==s){var n="other",o=this._dataset.changedStatus();o==jslet.data.DataSetStatus.INSERT?n="insert":o==jslet.data.DataSetStatus.UPDATE&&(n="update"),i||(a=!0),a=a&&s.indexOf(n)>=0,i=!0}var d=e.selected();void 0!==d&&(i||(a=!0),a=a&&d===!!this._dataset.selected())}if(l)for(var u,c=0,f=l.length;f>c;c++)u=l[c],void 0===this._ruleEnv[u]&&(this._ruleEnv[u]=this._dataset.getFieldValue(u));this._evalRuleItems(a?e.rules():e.otherwise(),!!t)},_evalRuleItems:function(e,t){if(e)for(var a,r,l,i=0,s=e.length;s>i;i++){r=e[i],a=r.field(),l=new jslet.data.ContextRuleItem(a);var n=r.meta();n&&(l.meta(new jslet.data.ContextRuleMeta),this._copyProperties(n,l.meta()));var o=r.lookup();o&&(l.lookup(new jslet.data.ContextRuleLookup),this._copyProperties(o,l.lookup())),t&&void 0!==r.value()&&l.value(this._evalExpr(r,"value"));var d=r.customized();d&&l.customized(d),this._matchedRules.push(l)}},_copyProperties:function(e,t){for(var a,r,l=e.properties,i=0,s=l.length;s>i;i++)a=l[i],r=this._evalExpr(e,a),void 0!==r&&t[a].call(t,r)},_evalExpr:function(e,t){var a=e[t+"Expr"];return a?a.eval():e[t].call(e)},_syncMatchedRules:function(e){for(var t,a,r,l=this._matchedRules,i=0,s=l.length;s>i;i++)if(t=l[i],a=t.field(),r=this._dataset.getField(a)){this._syncMatchedRuleMeta(r,t.meta()),this._syncMatchedRuleLookup(r,t.lookup()),this._syncMatchedRuleValue(r,t.value());var n=t.customized();n&&n(r,e)}},_syncMatchedRuleMeta:function(e,t){if(t)for(var a,r,l=t.properties,i=0,s=l.length;s>i;i++)a=l[i],r=t[a].call(t),void 0!==r&&e[a].call(e,r)},_syncMatchedRuleLookup:function(e,t){if(t){var a=e.lookup();if(a){var r=t.dataset();r&&a.dataset(r);var l=a.dataset();l.autoRefreshHostDataset(!0);var i,s=t.filter();if(void 0!==s){for(i in this._ruleEnv)s=s.replace("${"+i+"}",this._ruleEnv[i]);l.filter(s),l.filtered(!0)}if(s=t.fixedFilter(),void 0!==s){for(i in this._ruleEnv)s=s.replace("${"+i+"}",this._ruleEnv[i]);l.fixedFilter(s),l.filtered(!0)}var n=t.criteria();void 0!==n&&l.query(n);
var o=t.displayFields();void 0!==o&&a.displayFields(o);var d=t.onlyLeafLevel();void 0!==d&&a.onlyLeafLevel(d)}}},_syncMatchedRuleValue:function(e,t){void 0!==t&&e.setValue(t)}},jslet.data.dataModule={},jslet.data.getDataset=function(e){return e?jslet.isString(e)?jslet.data.dataModule[e]||null:e:null},jslet.data.DatasetType={NORMAL:0,LOOKUP:1,DETAIL:2},jslet.data.onCreatingDataset=function(e,t,a,r){},jslet.data.DataType={NUMBER:"N",STRING:"S",DATE:"D",TIME:"T",BOOLEAN:"B",DATASET:"V",CROSS:"C",PROXY:"P",EXTEND:"X",ACTION:"A",EDITACTION:"E"},jslet.data.FieldValueStyle={NORMAL:0,BETWEEN:1,MULTIPLE:2},jslet.data.RecordRange={ALL:0,SELECTED:1,CURRENT:2,CHANGED:3},jslet.data.EditMask=function(e,t,a){jslet.Checker.test("jslet.data.EditMask#mask",e).required().isString(),this.mask=e,void 0===t&&(t=!0),this.keepChar=!!t,this.transform=!!a,this.clone=function(){return new jslet.data.EditMask(this.mask,this.keepChar,this.transform)}},jslet.data.DatasetEvent={BEFORESCROLL:"beforescroll",AFTERSCROLL:"afterscroll",BEFOREINSERT:"beforeinsert",AFTERINSERT:"afterinsert",BEFOREUPDATE:"beforeupdate",AFTERUPDATE:"afterupdate",BEFOREDELETE:"beforedelete",AFTERDELETE:"afterdelete",BEFORECONFIRM:"beforeconfirm",AFTERCONFIRM:"afterconfirm",BEFORECANCEL:"beforecancel",AFTERCANCEL:"aftercancel",BEFORESELECT:"beforeselect",AFTERSELECT:"afterselect",BEFORESELECTALL:"beforeselectall",AFTERSELECTALL:"afterselectall"},jslet.data.DataSetStatus={BROWSE:0,INSERT:1,UPDATE:2,DELETE:3},jslet.data.RefreshEvent={updateRecordEvent:function(e){return{eventType:jslet.data.RefreshEvent.UPDATERECORD,fieldName:e}},updateColumnEvent:function(e){return{eventType:jslet.data.RefreshEvent.UPDATECOLUMN,fieldName:e}},updateAllEvent:function(){return this._updateAllEvent},changeMetaEvent:function(e,t,a){var r={eventType:jslet.data.RefreshEvent.CHANGEMETA,metaName:e,fieldName:t};return void 0!==a&&(r.changeAllRows=a),r},beforeScrollEvent:function(e){return{eventType:jslet.data.RefreshEvent.BEFORESCROLL,recno:e}},scrollEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.SCROLL,prevRecno:t,recno:e}},insertEvent:function(e,t,a){return{eventType:jslet.data.RefreshEvent.INSERT,prevRecno:e,recno:t,updateAll:a}},deleteEvent:function(e){return{eventType:jslet.data.RefreshEvent.DELETE,recno:e}},selectRecordEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.SELECTRECORD,recno:e,selected:t}},selectAllEvent:function(e){return{eventType:jslet.data.RefreshEvent.SELECTALL,selected:e}},changePageEvent:function(){return this._changePageEvent},errorEvent:function(e){return{eventType:jslet.data.RefreshEvent.ERROR,message:e}},lookupEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.UPDATELOOKUP,fieldName:e,isMetaChanged:t}},aggregatedEvent:function(){return{eventType:jslet.data.RefreshEvent.AGGREGATED}}},jslet.data.RefreshEvent.CHANGEMETA="changeMeta",jslet.data.RefreshEvent.UPDATEALL="updateAll",jslet.data.RefreshEvent.UPDATERECORD="updateRecord",jslet.data.RefreshEvent.UPDATECOLUMN="updateColumn",jslet.data.RefreshEvent.BEFORESCROLL="beforescroll",jslet.data.RefreshEvent.SCROLL="scroll",jslet.data.RefreshEvent.SELECTRECORD="selectRecord",jslet.data.RefreshEvent.SELECTALL="selectAll",jslet.data.RefreshEvent.INSERT="insert",jslet.data.RefreshEvent.DELETE="delete",jslet.data.RefreshEvent.CHANGEPAGE="changePage",jslet.data.RefreshEvent.UPDATELOOKUP="updateLookup",jslet.data.RefreshEvent.AGGREGATED="aggregated",jslet.data.RefreshEvent.ERROR="error",jslet.data.RefreshEvent._updateAllEvent={eventType:jslet.data.RefreshEvent.UPDATEALL},jslet.data.RefreshEvent._changePageEvent={eventType:jslet.data.RefreshEvent.CHANGEPAGE},jslet.data.record2Json=function(e,t){function a(e,a){if("_jl_"!=e){if(t)for(var r,l=0,i=t.length;i>l;l++)if(r=t[l],e==r)return;return a}}return window.JSON&&JSON?(t&&jslet.Checker.test("record2Json#excludeFields",t).isArray(),JSON.stringify(e,a)):void console.error("Your browser does not support JSON!")},jslet.data.getRecInfo=function(e){jslet.Checker.test("jslet.data.getRecInfo#record",e).required();var t=e._jl_;return t||(t={},e._jl_=t),t},jslet.data.DatasetRelationManager=function(){var e=[];this.addRelation=function(t,a,r,l){for(var i=0,s=e.length;s>i;i++){var n=e[i];if(n.hostDataset==t&&n.hostField==a&&n.lookupDataset==r)return}e.push({hostDataset:t,hostField:a,lookupOrDetailDataset:r,relationType:l})},this.removeRelation=function(t,a,r){for(var l=e.length-1;l>=0;l--){var i=e[l];i.hostDataset==t&&i.hostField==a&&i.lookupOrDetailDataset==r&&e.splice(l,1)}},this.removeDataset=function(t){for(var a=e.length-1;a>=0;a--){var r=e[a];r.hostDataset!=t&&r.lookupOrDetailDataset!=t||e.splice(a,1)}},this.changeDatasetName=function(t,a){if(t&&a)for(var r=0,l=e.length;l>r;r++){var i=e[r];i.hostDataset==t&&(i.hostDataset=a),i.lookupOrDetailDataset==t&&(i.lookupOrDetailDataset=a)}},this.refreshLookupHostDataset=function(t){if(t)for(var a,r,l=0,i=e.length;i>l;l++)if(a=e[l],a.lookupOrDetailDataset==t&&a.relationType==jslet.data.DatasetType.LOOKUP){if(r=jslet.data.getDataset(a.hostDataset),!r)throw new Error("NOT found Host dataset: "+a.hostDataset);r.handleLookupDatasetChanged(a.hostField)}},this.getHostFieldObject=function(t){if(t)for(var a,r,l=0,i=e.length;i>l;l++)if(a=e[l],a.lookupOrDetailDataset==t&&a.relationType==jslet.data.DatasetType.DETAIL){if(r=jslet.data.getDataset(a.hostDataset))return r.getField(a.hostField);throw new Error("NOT found Host dataset: "+a.hostDataset)}}},jslet.data.datasetRelationManager=new jslet.data.DatasetRelationManager,jslet.EmptyPromise=function(e){var e=e;this.done=function(t){return"done"==e&&t&&t(),this},this.fail=function(t){return"fail"==e&&t&&t(),this},this.always=function(e){return e&&e(),this}},jslet.data.displayOrderComparator=function(e,t){var a=e.displayOrder(),r=t.displayOrder();return a-r},jslet.data.GlobalDataHandler=function(){var e=this;e._datasetMetaChanged=null,e._fieldMetaChanged=null,e._fieldValueChanged=null},jslet.data.GlobalDataHandler.prototype={datasetCreated:function(e){var t=this;return void 0===e?t._datasetCreated:(jslet.Checker.test("globalDataHandler.datasetCreated",e).isFunction(),void(t._datasetCreated=e))},datasetMetaChanged:function(e){var t=this;return void 0===e?t._datasetMetaChanged:(jslet.Checker.test("globalDataHandler.datasetMetaChanged",e).isFunction(),void(t._datasetMetaChanged=e))},fieldMetaChanged:function(e){var t=this;return void 0===e?t._fieldMetaChanged:(jslet.Checker.test("globalDataHandler.fieldMetaChanged",e).isFunction(),void(t._fieldMetaChanged=e))},fieldValueChanged:function(e){var t=this;return void 0===e?t._fieldValueChanged:(jslet.Checker.test("globalDataHandler.fieldValueChanged",e).isFunction(),void(t._fieldValueChanged=e))}},jslet.data.globalDataHandler=new jslet.data.GlobalDataHandler,jslet.data.DatasetCreatingManager=function(){this._maxCreatingLevels={},this._creatingDatasets=[],this._doDatasetCreatedDebounce=jslet.debounce(this._doDatasetCreated,100)},jslet.data.DatasetCreatingManager.prototype={setMaxCreateLevel:function(e,t){t&&(this._maxCreatingLevels[e]=t)},startCreateDataset:function(e,t,a){var r;if(t&&(r=this._getDsCfg(t),r||(r={name:t,level:0,relative:[]},this._creatingDatasets.push(r)),!this._getDsCfg(e))){var l=r.relative;l||(r.relative=[],l=r.relative),l.push({name:e,level:a?r.level+1:0,parent:r})}},endCreateDataset:function(){jslet.global.dataset.onDatasetCreated&&this._doDatasetCreatedDebounce.call(this)},allowCreatingDataset:function(e){var t=this._getDsCfg(e);if(!t)return!0;for(var a=t,r=0;;){if(!a.parent){r=this._maxCreatingLevels[a.name];break}a=a.parent}return!r||t.level!==r},_checkAllCreated:function(e){for(var t,a=!0,r=e.relative,l=0,i=r.length;i>l;l++){if(t=r[l],!jslet.data.getDataset(t.name))return!1;if(t.relative&&(a=this._checkAllCreated(t),!a))return!1}return!0},_getDsCfg:function(e,t){if(!e)return null;var t,a;void 0===t&&(t=this._creatingDatasets);for(var r=0,l=t.length;l>r;r++){if(a=t[r],a.name==e)return a;if(a.relative&&(a=this._getDsCfg(e,a.relative)))return a}return null},_doDatasetCreated:function(){for(var e,t,a=this._creatingDatasets,r=!0,l=a.length-1;l>=0;l--){if(e=a[l],t=e.name,!this._checkAllCreated(e)){r=!1;break}a.splice(l,1),delete this._maxCreatingLevels[t]}r&&jslet.global.dataset.onDatasetCreated()}},jslet.data.defaultDatasetCreatingManager=new jslet.data.DatasetCreatingManager,jslet.data.Dataset=function(e){var t=this;t._name=null,t._description=null,t._recordClass=jslet.global.defaultRecordClass,t._records=null,t._oriRecords=null,t._fields=[],t._fieldsMap={},t._oriFields=null,t._normalFields=[],t._recno=-1,t._filteredRecnoArray=null,t._unitConvertFactor=1,t._unitName=null,t._aborted=!1,t._valueFollowEnabled=!0,t._status=0,t._proxyFields=null,t._fixedFilter=null,t._filter=null,t._filtered=!1,t._innerFilter=null,t._findCondition=null,t._innerFindCondition=null,t._innerFormularFields=null,t._bof=!1,t._eof=!1,t._igoreEvent=!1,t._logChanges=!0,t._auditLogEnabled=!0,t._validationEnabled=!0,t._modiObject=null,t._inputtingRecord={},t._lockCount=0,t._fixedIndexFields=null,t._innerFixedIndexFields=[],t._indexFields=null,t._innerIndexFields=[],t._sortingFields=null,t._convertDestFields=null,t._innerConvertDestFields=null,t._masterDataset=null,t._masterField=null,t._detailDatasetFields=null,t._linkedControls=[],t._linkedLabels=[],t._silence=0,t._keyField=null,t._codeField=null,t._nameField=null,t._parentField=null,t._levelOrderField=null,t._selectField=null,t._statusField=null,t._contextRules=null,t._contextRuleEngine=null,t._contextRuleEnabled=!1,t._dataProvider=jslet.data.DataProvider?new jslet.data.DataProvider:null,t._queryCriteria=null,t._queryUrl=null,t._submitUrl=null,t._pageSize=500,t._pageNo=0,t._pageCount=0,t._ignoreFilter=!1,t._ignoreFilterRecno=0,t._fieldValidator=new jslet.data.FieldValidator,t._onFieldChanged=null,t._onFieldFocusing=null,t._isFireGlobalEvent=!0,t._onCheckSelectable=null,t._onDataQuerying=null,t._onDataQueried=null,t._onDataSubmitted=null,t._datasetListener=null,t._datasetEventHandler=null,t._designMode=!1,t._autoShowError=!0,t._autoRefreshHostDataset=!1,t._readOnly=!1,t._aggregatedValues=null,t._afterScrollDebounce=jslet.debounce(t._innerAfterScrollDebounce,30),t._calcAggregatedValueDebounce=jslet.debounce(t.calcAggregatedValue,100),t.selection=new jslet.data.DataSelection(t),t._changeLog=new jslet.data.ChangeLog(t),t._dataTransformer=new jslet.data.DataTransformer(t),t._followedValues=null,t._focusedFields=null,t._canFocusFields=null,t._lastFindingValue=null,t._inContextRule=!1,t._aggregatedFields=null,t._aggregatingCount=0,t.createdByFactory=!1,t._isEnum=!1,this._create(e)},jslet.data.Dataset.className="jslet.data.Dataset",jslet.data.Dataset.prototype={className:jslet.data.Dataset.className,_create:function(e){function t(t){var a=e[t];void 0!==a&&s[t](a)}function a(t){var a=e[t];void 0!==a&&s[t](parseInt(a))}function r(t){var a=e[t];void 0!==a&&(jslet.isString(a)&&a&&(a="0"!=a&&"false"!=a),s[t](!!a))}var l,i=e.name;jslet.Checker.test("createDataset#datasetName",i).required().isString();var s=this;return s.name(i),s.createdByFactory=e.createdByFactory,s._isEnum=e.isEnum,s._isEnum?(l=[{name:"code",type:"S",length:20,displayWidth:10,label:jsletlocale.EnumDataset.code},{name:"name",type:"S",length:100,displayWidth:16,label:jsletlocale.EnumDataset.name}],s.createFields(l),s.keyField("code"),s.codeField("code"),s.nameField("name"),void 0!==e.indexFields&&s.indexFields(e.indexFields),void(e.records&&s.records(e.records))):(l=e.fields,s.createFields(l),t("keyField"),t("codeField"),t("nameField"),t("parentField"),t("levelOrderField"),t("selectField"),t("statusField"),t("recordClass"),t("description"),t("queryUrl"),t("submitUrl"),a("pageNo"),a("pageSize"),t("fixedIndexFields"),t("indexFields"),t("fixedFilter"),t("filter"),r("filtered"),r("autoShowError"),r("autoRefreshHostDataset"),r("readOnly"),r("logChanges"),r("auditLogEnabled"),r("isFireGlobalEvent"),t("datasetListener"),t("onFieldChange"),t("onFieldChanged"),t("onFieldChanging"),t("onCheckSelectable"),t("contextRules"),void(e.records&&s.records(e.records)))},name:function(e){var t=this;if(void 0===e)return t._name;jslet.Checker.test("Dataset.name",e).required().isString(),e=jslet.trim(e);var a=this._name;return a&&(jslet.data.dataModule[a]=null,jslet.data.datasetRelationManager.changeDatasetName(a,e)),jslet.data.dataModule[e]=this,this._name=e,this},description:function(e){return void 0===e?this._description||this._name:(this._description=e,this)},recordClass:function(e){var t=this;return void 0===e?t._recordClass:(jslet.Checker.test("Dataset.recordClass",e).isString(),t._recordClass=e?e.trim():null,this)},clone:function(e,t){var a=this;e||(e=a._name+"_clone");var r=new jslet.data.Dataset({name:e,fields:[]});r._datasetListener=a._datasetListener,r._unitConvertFactor=a._unitConvertFactor,r._unitName=a._unitName,r._fixedFilter=a._fixedFilter,r._filter=a._filter,r._filtered=a._filtered,r._logChanges=a._logChanges,r._fixedIndexFields=a._fixedIndexFields,r._indexFields=a._indexFields;var l=a._keyField,i=a._codeField,s=a._nameField,n=a._parentField,o=a._levelOrderField,d=a._selectField,u=a._statusField;t&&(l=l&&t.indexOf(l)>=0?l:null,i=i&&t.indexOf(i)>=0?i:null,s=s&&t.indexOf(s)>=0?s:null,n=n&&t.indexOf(n)>=0?n:null,o=o&&t.indexOf(o)>=0?o:null,d=d&&t.indexOf(d)>=0?d:null,u=u&&t.indexOf(u)>=0?u:null),r._keyField=l,r._codeField=i,r._nameField=s,r._parentField=n,r._levelOrderField=o,r._selectField=d,r._statusField=u,r._contextRules=a._contextRules;for(var c,f,h=0,v=a._fields.length;v>h;h++)c=a._fields[h],f=c.name(),t&&t.indexOf(f)<0||r.addField(c.clone(f,r));return r},cloneRecord:function(e,t){for(var a,r,l,i,s=t||{},n=this.getNormalFields(),o=0,d=n.length;d>o;o++)if(r=n[o],a=r.name(),l=e[a],void 0!==l){if(l&&jslet.isArray(l)){i=[];for(var u=0,c=l.length;c>u;u++)i.push(l[u])}else i=l;s[a]=i}return jslet.data.FieldValueCache.removeCache(s),s},readOnly:function(e){var t=this;if(void 0===e)return t._readOnly;t._readOnly=!!e;for(var a,r=t.getNormalFields(),l=0,i=r.length;i>l;l++)a=r[l],a._fireMetaChangedEvent("readOnly");return this},pageSize:function(e){return void 0===e?this._pageSize:(jslet.Checker.test("Dataset.pageSize#pageSize",e).isGTEZero(),this._pageSize=e,this)},pageNo:function(e){return void 0===e?this._pageNo:(jslet.Checker.test("Dataset.pageNo#pageNo",e).isGTEZero(),this._pageNo=e,this)},pageCount:function(){return this._pageCount},masterDataset:function(e){return void 0===e?this._masterDataset?jslet.data.getDataset(this._masterDataset):null:(this._masterDataset=e,this)},masterField:function(e){return void 0===e?this._masterField:(jslet.Checker.test("Dataset.masterField",e).isString(),this._masterField=e,this)},getMasterFieldObject:function(){return this._masterField?this.masterDataset().getField(this._masterField):null},designMode:function(e){return void 0===e?this._designMode:(this._designMode=!!e,this)},autoShowError:function(e){return void 0===e?this._autoShowError:(this._autoShowError=!!e,this)},autoRefreshHostDataset:function(e){return void 0===e?this._autoRefreshHostDataset:(this._autoRefreshHostDataset=!!e,this)},unitConvertFactor:function(e,t){var a=this;if(0===arguments.length)return a._unitConvertFactor;jslet.Checker.test("Dataset.unitConvertFactor#factor",e).isGTZero(),jslet.Checker.test("Dataset.unitConvertFactor#unitName",t).isString(),e>0?a._unitConvertFactor=e:a._unitConvertFactor=1,a._unitName=t;for(var r,l=0,i=a._normalFields.length;i>l;l++)if(r=a._normalFields[l],r.getType()==jslet.data.DataType.NUMBER&&r.unitConverted()){var s=r.name();jslet.data.FieldValueCache.clearAll(a,s);var n=jslet.data.RefreshEvent.updateColumnEvent(s);a.refreshControl(n)}return a},valueFollowEnabled:function(e){return void 0===e?this._valueFollowEnabled:(this._valueFollowEnabled=e,this)},datasetListener:function(e){return 0===arguments.length?this._datasetListener:(this._datasetListener=e,this)},on:function(e,t){jslet.Checker.test("Dataset.on#eventName",e).isString().required(),jslet.Checker.test("Dataset.on#eventHanlder",t).required();var a=this,r=a._datasetEventHandler;r||(r={},a._datasetEventHandler=r);var l=r[e];l||(l=[],r[e]=l),l.push(t)},off:function(e,t){var a=this._datasetEventHandler;if(a){if(!e&&!t)return void(this._datasetEventHandler=null);if(e){var r=a[e];if(r)if(t)for(var l,i=0,s=r.length;s>i;i++)l=r[i],t===l&&r.splice(i,1);else a[e]=null,delete a[e]}}},onCheckSelectable:function(e){return void 0===e?this._onCheckSelectable:(this._onCheckSelectable=e,this)},onDataQuerying:function(e){return void 0===e?this._onDataQuerying:(this._onDataQuerying=e,this)},onDataQueried:function(e){return void 0===e?this._onDataQueried:(this._onDataQueried=e,this)},onDataSubmitted:function(e){return void 0===e?this._onDataSubmitted:(this._onDataSubmitted=e,this)},fieldValidator:function(){return this._fieldValidator},onFieldChanged:function(e){return void 0===e?this._onFieldChanged:(this._onFieldChanged=e,this)},onFieldChange:function(e){return void 0===e?this._onFieldChanged:(this._onFieldChanged=e,this)},onFieldFocusing:function(e){return void 0===e?this._onFieldFocusing:(this._onFieldFocusing=e,this)},isFireGlobalEvent:function(e){return void 0===e?this._isFireGlobalEvent:(this._isFireGlobalEvent=!!e,this)},getFields:function(){return this._fields},getNormalFields:function(){return this._normalFields},getEditableFields:function(){for(var e,t=this._normalFields,a=[],r=0,l=t.length;l>r;r++)e=t[r],!e.visible()||e.disabled()||e.readOnly()||a.push(e.name());return a},getFirstFocusField:function(){var e=this,t=e.mergedFocusedFields();return t&&t.length>0?t[0]:(t=e.getEditableFields(),t&&t.length>0?t[0]:void 0)},setVisibleFields:function(e){if(!e)return this;jslet.isString(e)&&(e=e.split(",")),jslet.Checker.test("Dataset.setVisibleFields#fieldNameArray",e).isArray(),this._travelField(this._fields,function(e){return e.visible(!1),!1});for(var t=0,a=e.length;a>t;t++){var r=jslet.trim(e[t]),l=this.getField(r);l&&l.visible(!0)}return this},_travelField:function(e,t){if(t&&e){for(var a=!1,r=0,l=e.length;l>r;r++){var i=e[r];if(a=t(i))break;var s=i.children();if(s&&s.length>0&&(a=this._travelField(i.children(),t)))break}return a}},_cacheNormalFields:function(){var e=this._normalFields=[];this._travelField(this._fields,function(t){var a=t.children(),r=t.dataType();return a&&0!==a.length||r===jslet.data.DataType.ACTION||r===jslet.data.DataType.EDITACTION||e.push(t),!1}),this._normalFields=e,this.calcFocusedFields()},addFields:function(e){jslet.Checker.test("Dataset.addFields#arrFldObj",e).required().isArray();var t=this,a=e.length;if(0===a)return t;for(var r=0;a>r;r++)t.addField(e[r],!0);return t.refreshDisplayOrder(),t.refreshAggregatedFields(),this},addField:function(e,t){function a(e,t){var l=t.children();if(!l||0===l.length)return r._fieldsMap[e]=t,void r.addInnerFormulaField(e,t.formula());for(var i,s=0,n=l.length;n>s;s++)i=l[s],a(i.name,i)}jslet.Checker.test("Dataset.addField#fldObj",e).required().isClass(jslet.data.Field.className);var r=this,l=e.name();r.getField(l)&&r.removeField(l),e.dataset(r),r._fields.push(e);var i=e.displayOrder();i||0===i||e.displayOrder(r._fields.length);var s=e.dataType();return s==jslet.data.DataType.DATASET&&(r._detailDatasetFields||(r._detailDatasetFields=[]),r._detailDatasetFields.push(e)),s==jslet.data.DataType.PROXY&&(r._proxyFields||(r._proxyFields=[]),r._proxyFields.push(e)),a(l,e),t||(r.refreshDisplayOrder(),r.refreshAggregatedFields()),this},addFieldFromDataset:function(e,t){jslet.Checker.test("Dataset.addFieldFromDataset#srcDataset",e).required().isClass(jslet.data.Dataset.className),jslet.Checker.test("Dataset.addFieldFromDataset#fieldNames",t).isArray();for(var a,r,l=this,i=e.getFields(),s=0,n=i.length;n>s;s++)a=i[s],r=a.name(),t&&t.indexOf(r)<0||this.addField(a.clone(r,this),!0);return l.refreshDisplayOrder(),l.refreshAggregatedFields(),this},refreshDisplayOrder:function(){return this._fields.sort(jslet.data.displayOrderComparator),this._cacheNormalFields(),this},moveField:function(e,t){var a=this,r=a.getField(e),l=a.getField(t),i=r.parent(),s=l.parent();if(!r||!l||i!=s)return this;var n;n=i?i.children():a._fields;var o,d,u=(r.displayOrder(),l.displayOrder(),n.indexOf(r)),c=n.indexOf(l),f=a.designMode();a.designMode(!1);try{if(r.displayOrder(l.displayOrder()),c>u)for(d=u+1;c>=d;d++)o=n[d],o.displayOrder(o.displayOrder()-1);else for(d=c;u>d;d++)o=n[d],o.displayOrder(o.displayOrder()+1)}finally{a.designMode(f)}if(a.refreshDisplayOrder(),a.designMode()&&a.isFireGlobalEvent()){var h=jslet.data.globalDataHandler.fieldMetaChanged();h&&h.call(this,a,null,"displayOrder")}return this},removeField:function(e){function t(e,r){var l=r.children();if(!l||0===l.length)return delete a._fieldsMap[e],a.removeInnerFormulaField(e),this;for(var i,s=0,n=l.length;n>s;s++)i=l[s],t(i.name(),i)}jslet.Checker.test("Dataset.removeField#fldName",e).required().isString(),e=jslet.trim(e);var a=this,r=a.getField(e);if(r){if(r.dataType()==jslet.data.DataType.DATASET){var l=a._detailDatasetFields.indexOf(r);l>=0&&a._detailDatasetFields.splice(l,1)}var i=a._fields.indexOf(r);i>=0&&a._fields.splice(i,1),r.dataset(null),a._cacheNormalFields(),jslet.data.FieldValueCache.clearAll(a,e),t(e,r),a.refreshAggregatedFields()}var s=r.parent();if(s){var n=s.children(),l=n.indexOf(r);n.splice(l,1)}return this},clearFields:function(e){e||(e=this._fields);for(var t=e.length-1,a=t;a>=0;a--){var r=e[a],l=r.children();l&&l.length>0&&this.clearFields(l),this.removeField(r.name())}return this},refreshAggregatedFields:function(){var e=this;e._aggregatedFields=null;for(var t,a=e.getNormalFields(),r=[],l=0,i=a.length;i>l;l++)t=a[l],t.aggregated()&&r.push(t);return r.length>0&&(e._aggregatedFields=r),this},getField:function(e){jslet.Checker.test("Dataset.getField#fldName",e).isString().required(),e=jslet.trim(e);var t=e.split("."),a=t[0],r=!0,l=this._fieldsMap[a];if(l||(r=!1,this._travelField(this._fields,function(e){var t=!1;return e.name()==a&&(l=e,t=!0),t})),!l)return null;if(r||(this._fieldsMap[a]=l),1==t.length)return l;t.splice(0,1);var i=l.lookup();if(i){var s=i.dataset();if(s)return s.getField(t.join("."))}else{var n=l.detailDataset();if(n)return n.getField(t.join("."))}return null},getTopField:function(e){jslet.Checker.test("Dataset.getField#fldName",e).isString().required(),e=jslet.trim(e);var t=this.getField(e);if(t)for(;;){if(null===t.parent())return t;t=t.parent()}return null},sortFunc:function(e,t){var a,r,l,i,s=jslet.temp.sortDataset,n=s._sortingFields,o=[];for(l=0,i=n.length;i>l;l++)r=n[l],a=r.fieldName,(r.useTextToSort||s.getField(a).getType()===jslet.data.DataType.STRING)&&o.push(a);var d,u,c=1;for(l=0,i=n.length;i>l;l++)if(r=n[l],a=r.fieldName,r.useTextToSort?(d=s.getFieldTextByRecord(e,a),u=s.getFieldTextByRecord(t,a)):(d=s.getFieldValueByRecord(e,a),u=s.getFieldValueByRecord(t,a)),d!=u)return null!==d&&null!==u?o.indexOf(a)>=0?(d=d.toLowerCase(),u=u.toLowerCase(),c=d.localeCompare(u)<0?-1:1):c=u>d?-1:1:null===d&&null!==u?c=-1:null!==d&&null===u&&(c=1),c*r.order;return 0},fixedIndexFields:function(e){var t=this;if(void 0===e)return t._fixedIndexFields;jslet.Checker.test("Dataset.fixedIndexFields",e).isString(),t._fixedIndexFields=e?jslet.trim(e):null,t._innerFixedIndexFields=e?t._parseIndexFields(e):[];for(var a,r,l=t._innerIndexFields.length-1;l>=0;l--){a=t._innerIndexFields[l];for(var i=0,s=t._innerFixedIndexFields.length;s>i;i++)r=t._innerFixedIndexFields[i],a.fieldName===r.fieldName&&t._innerIndexFields.splice(l,1)}return t._sortByFields(),t},indexFields:function(e){var t=this;if(void 0===e)return t._indexFields;if(jslet.Checker.test("Dataset.indexFields",e).isString(),e=e?jslet.trim(e):null,!e&&!t._indexFields&&!t._fixedIndexFields)return this;t._indexFields=e,t._innerIndexFields=e?t._parseIndexFields(e):[];for(var a,r,l=t._innerIndexFields.length-1;l>=0;l--){a=t._innerIndexFields[l];for(var i=0,s=t._innerFixedIndexFields.length;s>i;i++)r=t._innerFixedIndexFields[i],a.fieldName===r.fieldName&&(r.order=a.order,t._innerIndexFields.splice(l,1))}return t._sortByFields(),t},mergedIndexFields:function(){var e,t,a=this,r=[];for(e=0,t=a._innerFixedIndexFields.length;t>e;e++)r.push(a._innerFixedIndexFields[e]);for(e=0,t=a._innerIndexFields.length;t>e;e++)r.push(a._innerIndexFields[e]);return r},toggleIndexField:function(e,t){var a,r,l=this,i=!1;for(r=l._innerFixedIndexFields.length-1;r>=0;r--)if(a=l._innerFixedIndexFields[r],a.fieldName===e){a.order=1===a.order?-1:1,i=!0;break}if(i)return t&&(l._innerIndexFields=[]),void l._sortByFields();for(i=!1,r=l._innerIndexFields.length-1;r>=0;r--)if(a=l._innerIndexFields[r],a.fieldName===e){a.order=1===a.order?-1:1,i=!0;break}i?t&&(l._innerIndexFields=[],l._innerIndexFields.push(a)):(t&&(l._innerIndexFields=[]),a={fieldName:e,order:1},l._innerIndexFields.push(a)),l._sortByFields()},_parseIndexFields:function(e){for(var t,a,r=e.split(","),l=1,i=[],s=0,n=r.length;n>s;s++)t=jslet.trim(r[s]),a=t.split(" "),l=1==a.length?1:"asce"==a[1].toLowerCase()?1:-1,i.push({fieldName:a[0],order:l});return i},_sortByFields:function(){var e=this;if(e.hasRecord()){e.selection.removeAll(),e._sortingFields=[];var t,a,r;for(a=0,r=e._innerFixedIndexFields.length;r>a;a++)t=e._innerFixedIndexFields[a],e._createIndexCfg(t.fieldName,t.order);for(a=0,r=e._innerIndexFields.length;r>a;a++)t=e._innerIndexFields[a],e._createIndexCfg(t.fieldName,t.order);if(0!==e._sortingFields.length){var l=e.getRecord(),i=e.isContextRuleEnabled();i&&e.disableContextRule(),e.disableControls(),jslet.temp.sortDataset=e;try{e.records().sort(e.sortFunc),e._refreshInnerRecno()}finally{jslet.temp.sortDataset=null,e.moveToRecord(l),i&&e.enableContextRule(),e.enableControls()}}}},_createIndexCfg:function(e,t){var a=this,r=e;if(jslet.isString(e)&&(r=a.getField(e)),r){if(r.dataset()!==a)return void a._combineIndexCfg(e,t);var l=r.children();if(l&&0!==l.length)for(var i=0,s=l.length;s>i;i++)a._createIndexCfg(l[i],t);else{var n=!0;"N"!==r.getType()||r.lookup()||(n=!1),a._combineIndexCfg(r.name(),t,n)}}},_combineIndexCfg:function(e,t,a){for(var r=0,l=this._sortingFields.length;l>r;r++)this._sortingFields[r].fieldName==e&&this._sortingFields.splice(r,1);var i={fieldName:e,order:t,useTextToSort:a};this._sortingFields.push(i)},_getWholeFilter:function(){var e=this,t=e._fixedFilter;if(t){if(e._filter)return"("+t+") && ("+e._filter+")"}else t=e._filter;return t},fixedFilter:function(e){var t=this;if(void 0===e)return t._fixedFilter;jslet.Checker.test("dataset.fixedFilter",e).isString(),e&&(e=jslet.trim(e));var a=t._getWholeFilter();t._fixedFilter=e;var r=t._getWholeFilter();if(r){if(a==r)return this;t._innerFilter=new jslet.data.Expression(t,r)}else t._innerFilter=null,t._filtered=!1,t._filteredRecnoArray=null;return t._filtered&&t._doFilterChanged(),this},filter:function(e){var t=this;if(void 0===e)return t._filter;jslet.Checker.test("dataset.filter#filterExpr",e).isString(),e&&(e=jslet.trim(e));var a=t._getWholeFilter();t._filter=e;var r=t._getWholeFilter();if(r){if(a==r)return this;t._innerFilter=new jslet.data.Expression(t,r),t._filtered&&t._doFilterChanged()}else{t._innerFilter=null;var l=t._filtered;t._filtered=!1,t._filteredRecnoArray=null,l&&t._doFilterChanged()}return this},filtered:function(e){var t=this;if(void 0===e)return t._filtered;var a=t._getWholeFilter(),r=t._filtered;return e&&!a?t._filtered=!1:t._filtered=!!e,r==t._filtered?this:(this._doFilterChanged(),this)},_doFilterChanged:function(){var e=this;e.selection.removeAll();var t=e.isContextRuleEnabled();t&&e.disableContextRule(),e.disableControls();try{e._filtered?e._refreshInnerRecno():e._filteredRecnoArray=null}finally{t&&e.enableContextRule(),e.enableControls()}return e.first(),e._calcAggregatedValueDebounce.call(e),e.refreshLookupHostDataset(),this},_filterData:function(){var e=this,t=e._getWholeFilter();if(!e._filtered||!t||e._status==jslet.data.DataSetStatus.INSERT||e._status==jslet.data.DataSetStatus.UPDATE)return!0;var a=e._innerFilter.eval();return a},_refreshInnerRecno:function(){var e=this;if(!e.hasData())return void(e._filteredRecnoArray=null);if(e._filteredRecnoArray=null,e._filtered){var t=[],a=e._recno;try{for(var r=0,l=e.records().length;l>r;r++)e._recno=r,e._filterData()&&t.push(r)}finally{e._recno=a}e._filteredRecnoArray=t}},_innerAfterScrollDebounce:function(){var e=this,t=jslet.getFunction(e._datasetListener);t&&t.call(e,jslet.data.DatasetEvent.AFTERSCROLL)},_fireDatasetEvent:function(e){var t=this;if(!t._silence&&!t._igoreEvent){if(t._datasetListener)if(e==jslet.data.DatasetEvent.AFTERSCROLL)t._afterScrollDebounce.call(t);else{var a=jslet.getFunction(t._datasetListener);a&&a.call(t,e)}var r=t._datasetEventHandler;if(r){var l=r[e];if(l)for(var i=0,s=l.length;s>i;i++){var a=jslet.getFunction(l[i]);a&&a.call(t)}}}},recordCount:function(){var e=this.records();return e?this._filteredRecnoArray?this._filteredRecnoArray.length:e.length:0},hasRecord:function(){return this.recordCount()>0},hasData:function(){var e=this.records();return e&&e.length>0},recno:function(e){var t=this;return void 0===e?t.recordCount()>0?t._recno:-1:(jslet.Checker.test("dataset.recno#recno",e).isGTEZero(),e=parseInt(e),t.hasRecord()?e==t._recno?!0:(t.confirm(),t._gotoRecno(e),t._bof=t._eof=!1,!0):(t._bof=t._eof=!0,!0))},recnoSilence:function(e){var t=this;if(void 0===e)return t.recordCount()>0?t._recno:-1;0>e&&(e=0);var a=t.recordCount()-1;return e>a&&(e=a),t._recno=e>a?a:e,this},_gotoRecno:function(e){var t=this,a=t.recordCount();if(0===a)return!1;if(e>=a?e=a-1:0>e&&(e=0),t._recno==e)return!1;var r;if(!t._silence){t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESCROLL),t._aborted)return!1}finally{t._aborted=!1}t._lockCount||(r=jslet.data.RefreshEvent.beforeScrollEvent(t._recno),t.refreshControl(r))}var l=t._recno;if(t._recno=e,t._recno!=l&&t._detailDatasetFields&&t._detailDatasetFields.length>0)for(var i,s,n=0,o=t._detailDatasetFields.length;o>n;n++)i=t._detailDatasetFields[n],s=i.detailDataset(),s&&s._initialize(!0);return t._refreshProxyField(null,t._silenc),t._contextRuleEnabled&&this.calcContextRule(),t._silence||(t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),t._lockCount||(r=jslet.data.RefreshEvent.scrollEvent(t._recno,l),t.refreshControl(r))),!0},abort:function(){return this._aborted=!0,this},aborted:function(){return this._aborted},_moveCursor:function(e){var t=this;t.confirm(),t._gotoRecno(e)},moveToRecord:function(e){var t=this;if(t.confirm(),!t.hasRecord()||!e)return!1;jslet.Checker.test("dataset.moveToRecord#recordObj",e).isObject();var a=t.records().indexOf(e);return 0>a?!1:t._filteredRecnoArray&&(a=t._filteredRecnoArray.indexOf(a),0>a)?!1:(t._gotoRecno(a),!0)},startSilenceMove:function(e){var t=this,a={};return e?a.recno=-999:a.recno=t._recno,t._silence++,a},endSilenceMove:function(e){var t=this;e&&-999!=e.recno&&e.recno!=t._recno&&t._gotoRecno(e.recno),t._silence--},isBof:function(){return this._bof},isEof:function(){return this._eof},first:function(){var e=this;return e.hasRecord()?(e._moveCursor(0),e._bof=e._eof=!1,this):void(e._bof=e._eof=!0)},next:function(){var e=this,t=e.recordCount();return 0===t?void(e._bof=e._eof=!0):e._recno==t-1?(e._bof=!1,void(e._eof=!0)):(e._bof=e._eof=!1,e._moveCursor(e._recno+1),this)},prior:function(){var e=this;return e.hasRecord()?0===e._recno?(e._bof=!0,void(e._eof=!1)):(e._bof=e._eof=!1,e._moveCursor(e._recno-1),this):void(e._bof=e._eof=!0)},last:function(){var e=this;return e.hasRecord()?(e._bof=e._eof=!1,e._moveCursor(e.recordCount()-1),e._bof=e._eof=!1,this):void(e._bof=e._eof=!0)},firstError:function(){return this._moveToError(0)},nextError:function(){return this._moveToError(this.recno()+1)},priorError:function(){return this._moveToError(this.recno()-1,!0)},lastError:function(){return this._moveToError(this.recordCount()-1,!0)},_moveToError:function(e,t){var a,r=this,l=r.recordCount()-1;if(0>l)return!1;if(t){for(e>l&&(e=l),a=e;a>=0;a--)if(r.existRecordError(a))return r._moveCursor(a),!0}else for(0>e&&(e=0),a=e;l>=a;a++)if(r.existRecordError(a))return r._moveCursor(a),!0;return!1},checkStatusByCancel:function(){this._status!=jslet.data.DataSetStatus.BROWSE&&this.cancel();
},insertChild:function(e){var t=this;if(!t._parentField||!t.keyField())throw new Error(jsletlocale.Dataset.parentFieldNotSet);if(!t.hasRecord())return t.innerInsert(),this;var a=t.startSilenceMove(!0);try{if(t.expanded(!0),e){if(!t.findByKey(e))return this}else e=t.keyValue();for(var r=t.parentField(),l=t.getFieldValue(r);;){if(t.next(),t.isEof())break;if(l==t.getFieldValue(r)){t.prior();break}}}finally{t.endSilenceMove(a)}return t.innerInsert(function(a){a[t._parentField]=e}),this},insertSibling:function(){var e=this;if(!e._parentField||!e._keyField)throw new Error(jsletlocale.Dataset.parentFieldNotSet);if(!e.hasRecord())return e.innerInsert(),this;var t,a=e.getFieldValue(e.parentField()),r=e.startSilenceMove(!0),l=!1,i=[],s=e.keyValue(),n=s;try{for(e.next();!e.isEof();){if(t=e.parentValue(),t==s)i.push(s),n=s;else if(n!=t&&i.indexOf(t)<0){e.prior(),l=!0;break}s=t,e.next()}l||e.last()}finally{e.endSilenceMove(r)}return e.innerInsert(function(t){t[e._parentField]=a}),this},insertRecord:function(){return this.innerInsert(),this},appendRecord:function(){var e=this;e._silence++;try{e.last()}finally{e._silence--}return e.insertRecord(),this},status:function(e){return void 0===e?this._status:(this._status=e,this)},expanded:function(e){return this.expandedByRecno(this.recno(),e)},expandedByRecno:function(e,t){jslet.Checker.test("dataset.expandedByRecno",e).required().isNumber();var a=this.getRecord(e),r=jslet.data.getRecInfo(a);if(void 0===t){var l=r&&r.expanded;return!!l}return null===r?this:(r.expanded=t,this)},insertedByRecno:function(e,t){if(void 0===t)return this.changedStatusByRecno(e)===jslet.data.DataSetStatus.INSERT;var a=this.getRecord(e);return t?(this.changedStatusByRecno(e,jslet.data.DataSetStatus.INSERT),this._changeLog.log(a)):(this.changedStatusByRecno(e,jslet.data.DataSetStatus.BROWSE),this._changeLog.unlog(a)),this},updatedByRecno:function(e,t){if(void 0===t)return this.changedStatusByRecno(e)===jslet.data.DataSetStatus.UPDATE;var a=this.getRecord(e);return t?(this.changedStatusByRecno(e,jslet.data.DataSetStatus.UPDATE),this._changeLog.log(a)):(this.changedStatusByRecno(e,jslet.data.DataSetStatus.BROWSE),this._changeLog.unlog(a)),this},changedStatus:function(e){return void 0===e?this.changedStatusByRecno(this._recno,e):(this.changedStatusByRecno(this._recno,e),this)},changedStatusByRecno:function(e,t){var a,r,l=this;if(void 0===t)return(a=l.getRecord(e))?(r=jslet.data.getRecInfo(a),r?r.status:jslet.data.DataSetStatus.BROWSE):null;if(l._logChanges){if(a=l.getRecord(e),!a)return null;if(r=jslet.data.getRecInfo(a),t===jslet.data.DataSetStatus.DELETE)return void(r.status=t);var i=r.status;i!==jslet.data.DataSetStatus.INSERT&&i!=t&&(r.status=t,l._contextRuleEnabled&&l.calcContextRule())}},innerInsert:function(e){var t=this;t.confirm(),t.selection.removeAll();var a=t.masterDataset();a&&(a.hasRecord()?a.editRecord():a.appendRecord()),t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREINSERT),t._aborted)return}finally{t._aborted=!1}var r=t.records();null===r&&(r=[],t._masterField?t.masterDataset().setFieldValue(t._masterField,r):t._records=r);var l,i=t.recno();l=t.hasRecord()?r.indexOf(this.getRecord())+1:0;var s={};if(r.splice(l,0,s),t._filteredRecnoArray&&t._filteredRecnoArray.length>0)for(var n=t._filteredRecnoArray.length-1;n>=0;n--){if(t._filteredRecnoArray[n]<l){t._filteredRecnoArray.splice(n+1,0,l),t._recno=l;break}t._filteredRecnoArray[n]+=1}else t._filteredRecnoArray&&(t._filteredRecnoArray[0]=l),t._recno=l;t.status(jslet.data.DataSetStatus.INSERT),t.changedStatus(jslet.data.DataSetStatus.INSERT),t._lockCount++;try{t._calcDefaultValue(),e&&e(s),t._contextRuleEnabled&&t.calcContextRule(),t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERINSERT),t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL)}finally{t._lockCount--}var o=jslet.data.RefreshEvent.insertEvent(i,t.recno(),t._recno<t.recordCount()-1);t.refreshControl(o)},insertDataset:function(e){var t=this,a=t.filtered(),r=t.startSilenceMove(!0),l=e.startSilenceMove(!0);try{for(t.filtered(!1),e.first();!e.isEof();)t.insertRecord(),t.cloneRecord(e.getRecord(),t.getRecord()),t.confirm(),e.next()}finally{e.endSilenceMove(l),t.filtered(a),t.endSilenceMove(r)}return this},appendDataset:function(e){var t=this;t._silence++;try{t.last()}finally{t._silence--}return t.insertDataset(e),this},batchAppendRecords:function(e,t){jslet.Checker.test("dataset.records",e).required().isArray();var a=this;a.confirm(),a.selection.removeAll(),a.disableControls();try{for(var r,l,i,s=a.keyField(),n=0,o=e.length;o>n;n++)if(r=e[n],l=!1,s&&(i=r[s],i&&a.findByKey(i)&&(l=!0)),l){if(!t)continue;a.editRecord(),a.cloneRecord(r,a.getRecord()),a.confirm()}else a.appendRecord(),a.cloneRecord(r,a.getRecord()),a.confirm()}finally{a.enableControls(),a.refreshControl(jslet.data.RefreshEvent._updateAllEvent),a.refreshLookupHostDataset()}return this},_calcDefaultValue:function(){for(var e,t,a,r,l=this,i=0,s=l._normalFields.length;s>i;i++)if(e=l._normalFields[i],r=e.name(),e.getType()!=jslet.data.DataType.DATASET){if(l._valueFollowEnabled&&e.valueFollow()&&l._followedValues){var n=l._followedValues[r];if(null!==n&&void 0!==n){e.setValue(n);continue}}if(a=e.defaultValue(),void 0===a||null===a||""===a){if(t=e.defaultExpr(),!t)continue;a=window.eval(t)}else e.getType()===jslet.data.DataType.NUMBER&&(a=e.scale()>0?parseFloat(a):parseInt(a));var o=e.valueStyle();a&&jslet.isDate(a)&&(a=new Date(a.getTime())),o==jslet.data.FieldValueStyle.BETWEEN?a=a?[a,a]:[null,null]:o==jslet.data.FieldValueStyle.MULTIPLE&&(a=[a]),l.setFieldValue(r,a)}},checkAggregated:function(e){var t=this,a=t._aggregatedFields;if(!a||0===a.length)return!1;if(!e)return!0;for(var r=0,l=a.length;l>r;r++)if(a[r].name()===e)return!0;return!1},disableAggregating:function(){return this._aggregatingCount++,this},enableAggregating:function(){var e=this;return e._aggregatingCount>0&&(e._aggregatingCount--,0===e._aggregatingCount&&e._calcAggregatedValueDebounce.call(e)),this},calcAggregatedValue:function(e){function t(e){if(e.indexOf(",")<0)return l.getFieldValue(e);for(var t=e.split(","),a=[],r=0,i=t.length;i>r;r++)a.push(l.getFieldValue(t[r]));return a.join(",")}function a(e){var a,r,l;for(var i in e)a=e[i],l=a.values,r=t(a.aggregatedBy),void 0===l[r]?(l[r]=null,a.exists=!1):a.exists=!0}function r(e,t){var a;for(var r in e)return a=e[r],a.exists;return console.warn("Not found aggregatedBy value!"),!1}var l=this;if(!(l._aggregatingCount>0)&&l.checkAggregated(e)){var i,s,n,o,d,u=l._aggregatedFields,c={},f=null,h=[];for(o=0,d=u.length;d>o;o++)i=u[o],s=i.aggregatedBy(),n=i.getType()===jslet.data.DataType.NUMBER,(!n||n&&i.lookup())&&!s&&(f||(f={}),e=i.name(),f[e]={count:l.recordCount(),sum:0},h.push(e)),s&&!c[s]&&(c[s]={aggregatedBy:s,values:{},exists:!1});if(u.length===h.length)return void l.aggregatedValues(f);f||(f={});var v,_,g=l.recnoSilence(),p=u.length;try{for(var F=0,j=l.recordCount();j>F;F++)for(l.recnoSilence(F),a(c),o=0;p>o;o++)if(i=u[o],e=i.name(),!(h.indexOf(e)>=0||(s=i.aggregatedBy(),s&&r(c,s)||(_=f[e],_||(_={count:0,sum:0},f[e]=_),_.count=_.count+1,i.getType()!==jslet.data.DataType.NUMBER)))){if(v=l.getFieldValue(e)||0,jslet.isString(v))throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidNumberFieldValue,[e,v]));_.sum=_.sum+v}}finally{l.recnoSilence(g)}var m;for(o=0;p>o;o++){i=u[o],e=i.name(),m=i.scale()||0,_=f[e],_||(_={count:0,sum:0},f[e]=_);var y=_.sum;if(y){var C=Math.pow(10,m);y=Math.round(y*C)/C,_.sum=y}}l.aggregatedValues(f)}},aggregatedValues:function(e){var t=this;if(void 0===e)return t._aggregatedValues;if(t._aggregatedValues=e,t._aggregatedValues||e){var a=jslet.data.RefreshEvent.aggregatedEvent();return t.refreshControl(a),this}},getRecord:function(e){var t,a=this;if(void 0===e||null===e)e=a._recno>=0?a._recno:0;else if(0>e||e>=a.recordCount())return null;if(!a.hasData())return null;var r=a.records();return a._ignoreFilter?r[a._ignoreFilterRecno||0]:0===a.recordCount()?null:(t=a._filteredRecnoArray?a._filteredRecnoArray[e]:e,r[t])},setRecord:function(e,t){if(!e)return this;var a=this;a.disableControls();try{t&&a.recno(t);for(var r in e)"_jl_"!=r&&a.setFieldValue(r,e[r])}finally{a.enableControls()}return this},getRelativeRecord:function(e){return this.getRecord(this._recno+e)},isSameAsPrevious:function(e){var t=this,a=t.getRelativeRecord(-1);if(!a)return!1;var r=t.getRecord(),l=t.getFieldValueByRecord(a,e),i=t.getFieldValueByRecord(r,e),s=!1;if(l||0===l||l===!1||i||0===i||i===!1?l&&i&&(s=jslet.isDate(l)?l.getTime()===i.getTime():l===i):s=!1,!s)return s;var n=t.getField(e),o=n.mergeSameBy();if(o)for(var d,u=o.split(","),c=0,f=u.length;f>c;c++)if(d=jslet.trim(u[c]),a[d]!=r[d])return!1;return s},hasParent:function(){var e=this,t=e.parentField();if(!t||0===e.recno())return!1;for(var a=e.recno()-1,r=a;r>=0;r--){var l=e.getFieldValue(t),i=this.getRelativeRecord(r-a),s=this.getFieldValueByRecord(i,e.keyField());if(0===jslet.compareValue(l,s))return!0;var n=this.getFieldValueByRecord(i,e.parentField());if(0!==jslet.compareValue(l,n))return!1}return!1},hasChildren:function(){var e=this;return e._parentField?e._recno<e.recordCount()-1&&e.parentValue(e._recno+1)===e.keyValue():!1},iterateChildren:function(e){var t=this;if(!t._parentField)return this;var a=t.startSilenceMove(),r=t.keyValue(),l=r,i=[];try{t.next();for(var s,n;!t.isEof();){if(s=t.parentValue(),n=i.indexOf(s)>=0,0!==jslet.compareValue(s,r)||n||(i.push(r),n=!0),!n)return this;if(e){var o=e.call(t,0===jslet.compareValue(s,l));if(o)break}r=t.keyValue(),t.next()}}finally{t.endSilenceMove(a)}return this},editRecord:function(){var e=this;if(e._status==jslet.data.DataSetStatus.UPDATE||e._status==jslet.data.DataSetStatus.INSERT)return this;if(e.selection.removeAll(),e.hasRecord()){e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREUPDATE),e._aborted)return this}finally{e._aborted=!1}e._modiObject={},jQuery.extend(e._modiObject,e.getRecord());var t=e.masterDataset();t&&t.editRecord(),e.status(jslet.data.DataSetStatus.UPDATE),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERUPDATE)}else e.insertRecord();return this},deleteRecord:function(){var e=this,t=e.recordCount();if(0===t||e.changedStatus()===jslet.data.DataSetStatus.DELETE)return!1;e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREDELETE),e._aborted)return!1}finally{e._aborted=!1}if(e.selection.removeAll(),e._status===jslet.data.DataSetStatus.INSERT)return e.cancel(),!1;e._silence++;try{e.checkStatusByCancel()}finally{e._silence--}if(e.hasChildren())return jslet.showInfo(jsletlocale.Dataset.cannotDelParent),!1;var a=e.recno(),r=a==t-1,l=e._recno,i=!1;e.changedStatus()===jslet.data.DataSetStatus.INSERT?e._changeLog.unlog():(e.changedStatus(jslet.data.DataSetStatus.DELETE),e._changeLog.log(),i=!0),e.records().splice(l,1),e._refreshInnerRecno();var s=e.masterDataset();if(s&&s.editRecord(),e.status(jslet.data.DataSetStatus.BROWSE),r){e._silence++;try{e.prior()}finally{e._silence--}}else e._refreshProxyField(),e._contextRuleEnabled&&this.calcContextRule();e._calcAggregatedValueDebounce.call(e);var n=jslet.data.RefreshEvent.deleteEvent(a);e.refreshControl(n),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),e.refreshLookupHostDataset();var o=e._detailDatasetFields;if(o)for(var d,u,c=0,f=o.length;f>c;c++)d=o[c],u=d.detailDataset(),u&&u.refreshControl();return e.isBof()&&e.isEof()?i:(n=jslet.data.RefreshEvent.scrollEvent(e._recno),e.refreshControl(n),i)},deleteSelected:function(){var e,t=this,a=t.selectedRecords();t.disableControls();try{for(var r=a.length-1;r>=0;r--)e=a[r],t.moveToRecord(e),t.deleteRecord()}finally{t.enableControls()}return this},validateDataset:function(e,t){var a=this;return a.iterate(function(){a.validateRecord(e,t)}),this},validateRecord:function(e,t){var a=this;if(0===a.recordCount())return this;for(var r,l,i,s,n=0,o=a._normalFields.length;o>n;n++)r=a._normalFields[n],l=r.name(),t&&t.indexOf(l)>=0||e&&e.indexOf(l)<0||(s=null,i=a.getFieldValue(l),s=a._fieldValidator.checkValue(r,a.getFieldValue(l)),s?a.setFieldError(l,s):a.setFieldError(l,null));if(a._masterDataset&&a._masterField){var d=jslet.data.getDataset(a._masterDataset);d.getField(a._masterField);a.existRecordError()?d.addFieldError(a._masterField,jslet.formatMessage(jsletlocale.Dataset.detailDsHasError,[a.name()])):d.addFieldError(a._masterField,null)}return this},_innerValidateData:function(e,t){var a=this;if(a._status!=jslet.data.DataSetStatus.BROWSE&&0!==a.recordCount()){for(var r,l,i,s,n=0,o=a._normalFields.length;o>n;n++)r=a._normalFields[n],l=r.name(),a.existFieldError(l)||!r.visible()||r.disabled()||r.readOnly()||t&&t.indexOf(l)>=0||e&&e.indexOf(l)<0||(s=null,i=a.getFieldValue(l),s=a._fieldValidator.checkRequired(r,i),s&&a.setFieldError(l,s));if(a._masterDataset&&a._masterField){var d=jslet.data.getDataset(a._masterDataset);d.getField(a._masterField);a.existRecordError()?d.addFieldError(a._masterField,jslet.formatMessage(jsletlocale.Dataset.detailDsHasError,[a.name()])):d.addFieldError(a._masterField,null)}}},errorMessage:function(e){var t=jslet.data.RefreshEvent.errorEvent(e||"");this.refreshControl(t)},addFieldError:function(e,t,a,r){jslet.data.FieldError.put(this.getRecord(),e,t,a,r)},existRecordError:function(e,t,a){return jslet.data.FieldError.existRecordError(this.getRecord(e),t,a)},getRecordErrorInfo:function(e,t,a){var r=this.getRecord(e);if(!this.existRecordError())return"";var l=jslet.data.getRecInfo(r);if(!l)return null;var i,s="",n=l.error;if(n)for(var o in n)if(!(a&&a.indexOf(o)>=0||t&&t.indexOf(o)<0)){var d=jslet.data.FieldError.get(r,o).message;d&&(i=this.getField(o),s&&(s+=", "),s+=d)}return s},checkAndShowError:function(e,t,a){var r=this;return r.existDatasetError(e,t,a)?(r._autoShowError?jslet.showError(jsletlocale.Dataset.cannotConfirm,function(){r.focusFirstErrorField()},2e3):(console.warn(jsletlocale.Dataset.cannotConfirm),r.focusFirstErrorField()),!0):!1},existDatasetError:function(e,t,a){var r=this,l=!1,i=r.records();if(!i)return!1;if(a===jslet.data.RecordRange.CURRENT)return jslet.data.FieldError.existRecordError(r.getRecord(),e,t);a===jslet.data.RecordRange.SELECTED&&(i=r.selectedRecords()||[]);for(var s=0,n=i.length;n>s;s++)if(l=jslet.data.FieldError.existRecordError(i[s],e,t))return!0;return!1},confirm:function(e,t){var a=this;if(a._status===jslet.data.DataSetStatus.BROWSE)return!0;var r=a.records();if(!r||0===r.length)return a._status=jslet.data.DataSetStatus.BROWSE,!0;a._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECONFIRM),a._confirmDetailDataset(),a._innerValidateData(e,t),a.status()===jslet.data.DataSetStatus.UPDATE&&a.changedStatus(jslet.data.DataSetStatus.UPDATE);var l,i=a.existRecordError(a.recno(),e,t);a.getRecord();a._modiObject=null,a.status(jslet.data.DataSetStatus.BROWSE),i||a._changeLog.log(),a._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCONFIRM),a._calcAggregatedValueDebounce.call(a),l=jslet.data.RefreshEvent.updateRecordEvent(),a.refreshControl(l),i?a.errorMessage(jsletlocale.Dataset.cannotConfirm):(jslet.data.FieldError.clearRecordError(a.getRecord(),e,t),a.errorMessage());var s=a.masterDataset();if(s){var n=a.masterField();i?s.addFieldError(n,jslet.formatMessage(jsletlocale.Dataset.detailDsHasError,[a.name()])):s.addFieldError(n,null),s.refreshControl(l)}return a.refreshLookupHostDataset(),!i},_confirmDetailDataset:function(){var e,t,a,r=this,l=[],i=[];for(t=0,a=r._normalFields.length;a>t;t++)e=r._normalFields[t],e.getType()===jslet.data.DataType.DATASET&&(l.push(e.detailDataset()),i.push(e.name()));var s;for(t=0,a=l.length;a>t;t++)s=l[t],s&&(s.confirm(),s.existDatasetError()?r.addFieldError(i[t],jslet.formatMessage(jsletlocale.Dataset.detailDsHasError,[s.name()])):r.addFieldError(i[t],null))},cancel:function(){var e=this;if(e._status==jslet.data.DataSetStatus.BROWSE)return this;if(0===e.recordCount())return this;e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECANCEL),e._aborted)return this}finally{e._aborted=!1}e._cancelDetailDataset();var t,a=e._recno,r=e.records();if(e._status==jslet.data.DataSetStatus.INSERT){e.selection.removeAll();var l=e.recno();return r.splice(a,1),e.status(jslet.data.DataSetStatus.BROWSE),e._refreshInnerRecno(),l>=e.recordCount()&&(e._recno=e.recordCount()-1),e._refreshProxyField(),e._contextRuleEnabled&&this.calcContextRule(),e._calcAggregatedValueDebounce.call(e),t=jslet.data.RefreshEvent.deleteEvent(l),e.refreshControl(t),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),t=jslet.data.RefreshEvent.scrollEvent(e._recno),e.refreshControl(t),this}e._filteredRecnoArray&&(a=e._filteredRecnoArray[e._recno]);var i=r[a],s=e._modiObject;jQuery.extend(i,s);for(var n in i)void 0===s[n]&&delete i[n];return e._innerValidateData(),jslet.data.FieldValueCache.removeCache(i),e._modiObject=null,e._refreshProxyField(),e._calcAggregatedValueDebounce.call(e),e.status(jslet.data.DataSetStatus.BROWSE),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCANCEL),t=jslet.data.RefreshEvent.updateRecordEvent(),e.refreshControl(t),this},_cancelDetailDataset:function(){var e,t,a,r=this,l=[];for(t=0,a=r._normalFields.length;a>t;t++)e=r._normalFields[t],e.getType()===jslet.data.DataType.DATASET&&l.push(e.detailDataset());var i;for(t=0,a=l.length;a>t;t++)i=l[t],i.cancel()},logChanges:function(e){return void 0===e?this._logChanges:(this._logChanges=e,this)},auditLogEnabled:function(e){return void 0===e?this._auditLogEnabled:(this._auditLogEnabled=!!e,this)},validationEnabled:function(e){return void 0===e?this._validationEnabled:(this._validationEnabled=!!e,this)},disableControls:function(){this._lockCount++;for(var e,t,a=0,r=this._normalFields.length;r>a;a++)e=this._normalFields[a],t=e.detailDataset(),null!==t&&t.disableControls();return this},enableControls:function(e){this._lockCount>0&&this._lockCount--,e||this.refreshControl();for(var t,a,r=0,l=this._normalFields.length;l>r;r++)t=this._normalFields[r],a=t.detailDataset(),null!==a&&a.enableControls();return this},existFieldError:function(e,t){if(0===this.recordCount())return!1;var a=this.getRecord();return a?jslet.data.FieldError.existFieldError(a,e,t):!1},getFieldError:function(e,t){return this.getFieldErrorByRecno(null,e,t)},getFieldErrorByRecno:function(e,t,a){if(0===this.recordCount())return null;var r=this.getRecord(e);return r?jslet.data.FieldError.get(r,t,a):null},setFieldError:function(e,t,a,r){var l=this;if(0===l.recordCount())return l;var i=l.getRecord();return i?(jslet.data.FieldError.put(i,e,t,a,r),this):l},getFieldValueByRecno:function(e,t,a){var r=this.getRecord(e);return r?this.getFieldValueByRecord(r,t,a):null},getFieldValueByRecord:function(e,t,a){var r=this;e||(e=r.getRecord()),r._refreshProxyField(e,!0);var l,i,s,n=t.indexOf("."),o=null,d=r.getField(t);if(n>0){l=t.substr(0,n),d=r.getField(l);var u=d.lookup(),c=d.detailDataset();if(!u&&!c)throw new Error(jslet.formatMessage(jsletlocale.Dataset.lookupNotFound,[l]));u?(i=jslet.data.FieldRawValueAccessor.getRawValue(e,d),s=u.dataset(),o=null,(i||0===i)&&(s.findByField(s.keyField(),i)?o=s.getFieldValue(t.substr(n+1)):console.warn(jslet.formatMessage(jsletlocale.Dataset.valueNotFound,[s.description(),s.keyField(),i])))):o=c.getFieldValue(t.substr(n+1))}else{if(!d)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[t]));var f=d.formula();f&&void 0===e[t]?(o=r._calcFormula(e,t),jslet.data.FieldRawValueAccessor.setRawValue(e,d,o)):o=jslet.data.FieldRawValueAccessor.getRawValue(e,d)}return d.valueStyle()&&void 0!==a?jslet.getArrayValue(o,a):o},getFieldValue:function(e,t){var a=this.getRecord();return a?this.getFieldValueByRecord(a,e,t):null},_convertValueByType:function(e,t,a,r,l){if(!t||a===jslet.data.DataType.DATASET)return t;if(jslet.isArray(t)){for(var i=0,s=t.length;s>i;i++)t[i]=this._convertValueByType(e,t[i],a,r,l);return t}if(a===jslet.data.DataType.NUMBER){var n=t;if(t=r>0?parseFloat(t):parseInt(t),window.isNaN(t))throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidNumberFieldValue,[e,n]));return t}return l&&a===jslet.data.DataType.STRING&&jslet.isString(t)?t.trim():t},setFieldValue:function(e,t,a){var r=this,l=r.getField(e);if(null===l)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[e]));r._status==jslet.data.DataSetStatus.BROWSE&&r.editRecord();var i=r._logOldEditValue(e,l.label()),s=r.getRecord(),n=l.getType();if(t=r._convertValueByType(e,t,n,l.scale(),l.trimBlank()),r._validationEnabled){var o=r._fieldValidator.checkValue(l,t);o?r.setFieldError(e,o):r.setFieldError(e,null,a)}if(l.valueStyle()&&void 0!==a){var d=jslet.data.FieldRawValueAccessor.getRawValue(s,l);d&&jslet.isArray(d)||(d=[]);var u=d.length;if(u>a)d[a]=t;else{for(var c=u;a>c;c++)d.push(null);d.push(t)}jslet.data.FieldRawValueAccessor.setRawValue(s,l,d)}else if(jslet.data.FieldRawValueAccessor.setRawValue(s,l,t),n==jslet.data.DataType.DATASET)return this;if(r._onFieldChanged){var f=jslet.getFunction(r._onFieldChanged);f&&(f.call(r,e,t,a),t=r.getFieldValue(e,a))}if(r.isFireGlobalEvent()){var h=jslet.data.globalDataHandler.fieldValueChanged();h&&h.call(r,r,e,t,a)}l.valueFollow()&&(r._followedValues||(r._followedValues={}),r._followedValues[e]=t),r._refreshProxyField(s,!0),r._contextRuleEnabled&&r.calcContextRule(e),jslet.data.FieldValueCache.clear(s,e),r._logNewEditValue(e,i),r._updateLookupRelativeFields(l,t);var v=jslet.data.RefreshEvent.updateRecordEvent(e);return r.refreshControl(v),r.updateFormula(e),r._calcAggregatedValueDebounce.call(r),this},_logOldEditValue:function(e,t){var a=this;if(!a._auditLogEnabled||!a._logChanges)return null;var r=a.changedStatus()||a._status;if(r!==jslet.data.DataSetStatus.UPDATE)return null;var l=a.getRecord(),i=l[jslet.global.auditLogField];i||(i={},l[jslet.global.auditLogField]=i);var s=i[e];s||(s={},i[e]=s,s.l=t);var n=s.o;return n||(s.o=a.getFieldText(e)),s},_logNewEditValue:function(e,t){if(t){var a=this.getFieldText(e);if(a!=t.o)t.n=a;else{var r=this.getRecord(),l=r[jslet.global.auditLogField];delete l[e]}}},clearFollowedValues:function(){return this._followedValues=null,this},calcFocusedFields:function(){var e,t=this;t._focusedFields=null;for(var a=0,r=t._normalFields.length;r>a;a++)e=t._normalFields[a],e.focused()&&(t._focusedFields||(t._focusedFields=[]),t._focusedFields.push(e.name()));if(t.masterField()){var l=jslet.data.getDataset(t._masterDataset),i=l.getField(t._masterField);i.focused(t._focusedFields&&t._focusedFields.length>0)}},focusedFields:function(){return this._focusedFields},mergedFocusedFields:function(){var e,t,a=this._focusedFields,r=a,l=this._canFocusFields;if(a&&l)for(var i=a.length-1;i>=0;i--)e=a[i],t=this.getField(e),t.detailDataset()||l.indexOf(e)<0&&(r=a.slice(0),r.splice(i,1));return r},_updateLookupRelativeFields:function(e,t){if(t&&e.valueStyle()===jslet.data.FieldValueStyle.NORMAL){var a=e.lookup();if(a){var r=a.returnFieldMap();if(r){var l,i=a.dataset();if(0===jslet.compareValue(i.keyValue(),t)||i.findByKey(t)){var s=e.name();for(var n in r)s!=n&&(l=r[n],this.setFieldValue(n,i.getFieldValue(l)))}}}}},_calcFormulaRelation:function(){var e=this;if(e._innerFormularFields){var t,a,r={},l=0;for(var t in e._innerFormularFields){var i=e._innerFormularFields[t];a=i.mainFields(),r[t]=a,l++}e._innerFormulaRelation=l>0?r:null}},addInnerFormulaField:function(e,t){var a=this;if(t){a._innerFormularFields||(a._innerFormularFields={});var r=new jslet.data.Expression(a,t);a._innerFormularFields[e]=r,a._calcFormulaRelation()}},removeInnerFormulaField:function(e){this._innerFormularFields&&(delete this._innerFormularFields[e],this._calcFormulaRelation())},_calcFormula:function(e,t){var a=this,r=a._innerFormularFields[t],l=null;return r&&(r.context.dataRec=e,l=r.eval()),l},updateFormula:function(e){var t=this;if(t._innerFormulaRelation){var a,r,l=this.getRecord();for(var i in t._innerFormulaRelation)if(a=t._innerFormulaRelation[i],r=t.getField(i),a&&0!==a.length){for(var s,n=!1,o=0,d=a.length;d>o;o++)if(s=a[o],s==e||s.startsWith(e+".")){n=!0;break}n&&r.setValue(t._calcFormula(l,i))}else r.setValue(t._calcFormula(l,i))}},getFieldText:function(e,t,a){if(0===this.recordCount())return null;var r=this.getRecord();return r?this.getFieldTextByRecord(r,e,t,a):null},getFieldTextByRecno:function(e,t,a,r){var l=this.getRecord(e);return l?this.getFieldTextByRecord(l,t,a,r):null},getFieldTextByRecord:function(e,t,a,r){var l=this;if(0===l.recordCount())return"";var i,s=e;l._refreshProxyField(s,!0);var n,o=t.indexOf(".");if(o>0){var d=t.substr(0,o);if(t=t.substr(o+1),i=l.getField(d),!i)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[t]));var u=i.lookup(),c=i.detailDataset();if(!u&&!c)throw new Error(jslet.formatMessage(jsletlocale.Dataset.lookupNotFound,[t]));if(u){if(n=s[d],null===n||void 0===n)return"";var f=u.dataset();if(f.findByField(f.keyField(),n))return t.indexOf(".")>0?f.getFieldValue(t):f.getFieldText(t,a,r);throw new Error(jslet.formatMessage(jsletlocale.Dataset.valueNotFound,[f.description(),f.keyField(),n]))}return c.getFieldText(t,a,r)}if(i=l.getField(t),!i)throw new Error(jslet.formatMessage(jsletlocale.Dataset.lookupNotFound,[t]));if(i.getType()==jslet.data.DataType.DATASET)return"";var h=i.valueStyle();if(h===jslet.data.FieldValueStyle.NORMAL||void 0!==r){var v=jslet.data.FieldError.get(s,t,r);if(v&&v.message){var _=v.inputText;if(void 0!==_&&null!==_)return _}}var g=[];if(h==jslet.data.FieldValueStyle.BETWEEN&&void 0===r){var p=l.getFieldTextByRecord(s,t,a,0),F=l.getFieldTextByRecord(s,t,a,1);return a||p||F?(g.push(p),a?g.push(jslet.global.valueSeparator):g.push(jsletlocale.Dataset.betweenLabel),g.push(F),g.join("")):""}if(h==jslet.data.FieldValueStyle.MULTIPLE&&void 0===r){var j=l.getFieldValue(t),m=0;j&&jslet.isArray(j)&&(m=j.length-1);for(var y=0;m>=y;y++)g.push(l.getFieldTextByRecord(s,t,a,y)),m>y&&g.push(jslet.global.valueSeparator);return g.join("")}if(!a){var C=jslet.data.FieldValueCache.get(s,t,r);if(void 0!==C)return C}if(n=l.getFieldValueByRecord(s,t,r),null===n||void 0===n){var D=i.fixedValue();return D?D:""}var E=i.customValueConverter()||jslet.data.getValueConverter(i);if(!E)throw new Error("Can't find any field value converter!");var x=E.valueToText(i,n,a),R=i.encrypted();if(!a&&R&&x){var b=R.start||0,T=R.end;(void 0===T||null===T||b>T)&&(T=1e4);var S=x.length;T=T>S?S:T;var k=x;x=k.substring(0,b);for(var o=b;T>o;o++)x+="*";S>T&&(x+=k.substring(T))}return a||jslet.data.FieldValueCache.put(s,t,x,r),x},setFieldValueLength:function(e,t){if(e.valueStyle()){var a=this.getFieldValue(e.name());a&&jslet.isArray(a)&&(a.length=t)}},setFieldText:function(e,t,a){var r=this,l=r.getField(e);if(null===l)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[e]));var i=l.getType();if(i==jslet.data.DataType.DATASET)throw new Error(jslet.formatMessage(jsletlocale.Dataset.datasetFieldNotBeSetValue,[e]));var s=r._textToValue(l,t,a);return void 0!==s&&r.setFieldValue(e,s,a),this},_textToValue:function(e,t,a){var r,l=this;{if(e.valueStyle()!==jslet.data.FieldValueStyle.BETWEEN&&e.valueStyle()!==jslet.data.FieldValueStyle.MULTIPLE||void 0!==a){var i=e.customValueConverter()||jslet.data.getValueConverter(e);if(!i)throw new Error("Can't find any field value converter!");r=i.textToValue(e,t,a);var s=e.name();if(l.getFieldError(s,a)){var n=jslet.data.RefreshEvent.updateRecordEvent(s);l.refreshControl(n)}else l.setFieldError(s,null,a);return r}jslet.isArray(t)||(t=t.split(jslet.global.valueSeparator));for(var o=t.length,d=[],u=!1,c=0;o>c;c++)r=l._textToValue(e,t[c],c),void 0===r?u=!0:u||d.push(r);if(!u)return d}},keyValue:function(e){return this._keyField&&0!==this.recordCount()?this.getFieldValueByRecno(e,this._keyField):null},parentValue:function(e){return this._parentField&&0!==this.recordCount()?this.getFieldValueByRecno(e,this._parentField):null},find:function(e,t){var a=this;if(0===a.recordCount())return!1;if(a.confirm(),null===e||void 0===e)return a._findCondition=null,a._innerFindCondition=null,a._findPrevRecno=null,!1;jslet.Checker.test("find#condition",e).isString(),e!==a._findCondition&&(a._innerFindCondition=new jslet.data.Expression(this,e),a._findCondition=e,a._findPrevRecno=null),a._silence++;var r=-1,l=a._recno;try{for(t?a._findPrevRecno===l&&a.next():(a.first(),a._findPrevRecno=null);!a.isEof();){if(a._innerFindCondition.eval()){r=a._recno;break}a.next()}}finally{a._silence--,a._recno=l}return r>=0?(a._gotoRecno(r),t&&(a._findPrevRecno=r),!0):!1},findByField:function(e,t,a){function r(e,t,a){return 0===jslet.compareValue(t,a)?i:"first"==e?jslet.like(t,a+"%"):"any"==e?jslet.like(t,"%"+a+"%"):"last"==e?jslet.like(t,"%"+a):0}jslet.Checker.test("findByField#fieldNameOrFieldArray",e).required();var l=this;l.confirm();var i=1,s=0,n=!1,o=null,d=null,u=null;a&&(s=a.startRecno||0,n=a.findingByText||!1,o=a.matchType||null,d=a.extraFilter||null,d&&(u=new jslet.data.Expression(l,d)));var c=l._ignoreFilter?l.records():l.filteredRecords();if(!c||0===c.length)return!1;var f=e;jslet.isString(e)&&(f=e.split(","));var h,v,_,g=[],p=f.length;for(h=0;p>h;h++){if(v=f[h],_=l.getField(v),!_)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[v]));var F=!0;"N"!==_.getType()||_.lookup()||(F=!1),g[h]=F}var j,m,y,C=!l._ignoreFilter&&s?s:0,D=-1,E=!1,x=!1;for(h=C,y=c.length;y>h;h++)if(j=c[h],!u||u.eval(j)){for(var R=0;p>R;R++)if(v=f[R],m=n&&g[R]?l.getFieldTextByRecord(j,v):l.getFieldValueByRecord(j,v),x=r(o,m,t)){if(D=h,l._ignoreFilter)return l._ignoreFilterRecno=h,!0;E={},E.field=v,E.isEqual=x===i;break}if(D>=0)break}return D>=0?(l._gotoRecno(D),E):!1},findByKey:function(e){var t=this.keyField();return t?this.findByField(t,e):!1},lookup:function(e,t,a){return jslet.Checker.test("lookup#fldName",e).required().isString(),jslet.Checker.test("lookup#returnFieldName",a).required().isString(),e==a?t:this.findByField(e,t)?this.getFieldValue(a):null},lookupByKey:function(e,t){return this.findByKey(e)?this.getFieldValue(t):null},inChildrenAndSelf:function(e,t,a){jslet.Checker.test("inchildren#fldName",e).required().isString(),jslet.Checker.test("inchildren#parentValue",t).required();var r=this.getFieldValue(e);return 0===jslet.compareValue(r,t)?!0:this.inChildren(e,t,a)},inChildren:function(e,t,a){jslet.Checker.test("inchildren#fldName",e).required().isString(),jslet.Checker.test("inchildren#parentValue",t).required();var r=this,l=r.getField(e);if(!l)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNotFound,[e]));var i=l.lookup();if(!i)throw new Error(jslet.formatMessage(jsletlocale.Dataset.lookupFieldExpected,[e]));var s=i.dataset();if(jslet.Checker.test("inchildren#lookupDataset",s).required(),jslet.Checker.test("inchildren#lookupDataset.parentField",s.parentField()).required(),!s.findByKey(t))return!1;var n=r.getFieldValue(e),o=!1;return s.iterateChildren(function(e){var t=!1;return(!a||a&&e)&&0===jslet.compareValue(s.keyValue(),n)&&(t=!0,o=!0),t}),o},copyDataset:function(e){var t=this;if(0===t.recordCount())return null;var a=[];if(!e||!t._filtered)return t.records().slice(0);var r=t._recno,l=t._filtered;e||(t._filtered=!1),t._silence++;try{for(t.first();!t.isEof();)a.push(t.getRecord()),t.next()}finally{t._silence--,t._recno=r,e||(t._filtered=l)}return a},keyField:function(e){return void 0===e?this._keyField:(jslet.Checker.test("Dataset.keyField",e).isString(),this._keyField=e?jslet.trim(e):null,this)},codeField:function(e){return void 0===e?this._codeField||this.keyField():(jslet.Checker.test("Dataset.codeField",e).isString(),this._codeField=e?jslet.trim(e):null,this)},nameField:function(e){return void 0===e?this._nameField||this.codeField():(jslet.Checker.test("Dataset.nameField",e).isString(),this._nameField=e?jslet.trim(e):null,this)},parentField:function(e){return void 0===e?this._parentField:(jslet.Checker.test("Dataset.parentField",e).isString(),this._parentField=e?jslet.trim(e):null,this)},levelOrderField:function(e){return void 0===e?this._levelOrderField:(jslet.Checker.test("Dataset.levelOrderField",e).isString(),this._levelOrderField=e?jslet.trim(e):null,this)},selectField:function(e){return void 0===e?this._selectField:(jslet.Checker.test("Dataset.selectField",e).isString(),
this._selectField=e?jslet.trim(e):null,this)},statusField:function(e){return void 0===e?this._statusField:(jslet.Checker.test("Dataset.statusField",e).isString(),this._statusField=e?jslet.trim(e):null,this)},contextRules:function(e){var t=this;if(void 0===e)return t._contextRules;if(jslet.isString(e)&&(e=e?jslet.JSON.parse(e):null),jslet.Checker.test("Dataset.contextRules",e).isArray(),e&&0!==e.length){for(var a,r=0,l=e.length;l>r;r++)a=e[r],a.className&&a.className==jslet.data.ContextRule.className||(e[r]=new jslet.data.ContextRule(a));t._contextRules=e,t._contextRuleEngine=new jslet.data.ContextRuleEngine(t),t._contextRuleEngine.compile(),t.enableContextRule()}else t._contextRules=null,t._contextRuleEngine=null;return this},disableContextRule:function(){return this._contextRuleEnabled=!1,this},enableContextRule:function(){return this._contextRuleEnabled=!0,this.calcContextRule(),this},isContextRuleEnabled:function(){return this._contextRuleEnabled},calcContextRule:function(e){var t=this;if(t._contextRuleEnabled&&0!==t.recordCount()&&t._contextRuleEngine){t._inContextRule=!0;try{t._contextRuleEngine.evalRule(e)}finally{t._inContextRule=!1}}},_refreshProxyField:function(e,t){var a=this;if(a._proxyFields&&0!==a.recordCount()){e||(e=a.getRecord());for(var r,l=0,i=a._proxyFields.length;i>l;l++)r=a._proxyFields[l],r.changeProxyFieldName(e,t)}},checkSelectable:function(e){if(0===this.recordCount())return!1;if(this._onCheckSelectable){var t=jslet.getFunction(this._onCheckSelectable);if(t)return t.call(this,e)}return!0},selected:function(e){var t=this,a=t._selectField||jslet.global.selectStateField,r=t.getRecord();if(void 0===e)return r&&r[a];if(r&&t.checkSelectable()){t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESELECT),t._aborted)return t}finally{t._aborted=!1}r[a]=e,t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSELECT),this._contextRuleEngine&&this._contextRuleEngine.evalRule()}return t},selectedByRecno:function(e){var t=this,a=t._selectField||jslet.global.selectStateField,r=t.getRecord(e);return r&&r[a]},selectAll:function(e,t,a){var r=this;if(0===r.recordCount())return this;try{if(r._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESELECTALL),r._aborted)return this}finally{r._aborted=!1}jslet.Checker.test("Dataset.selectAll#onSelectAll",t).isFunction();var l=r.recno();try{for(var i=0,s=r.recordCount();s>i;i++)r.recnoSilence(i),r.selected(e)}finally{r.recnoSilence(l)}if(t&&t(this,e),r._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSELECTALL),!a){var n=jslet.data.RefreshEvent.selectAllEvent(e);r.refreshControl(n)}return this},selectByKeyValue:function(e,t,a){var r,l=this,i=l.recno(),s=l.recordCount(),n=[];try{for(var o=0;s>o;o++)if(l.recnoSilence(o),r=l.getFieldValue(l._keyField),r==t){l.selected(e),n.push(o);break}}finally{l.recnoSilence(i)}if(!a){var d=jslet.data.RefreshEvent.selectRecordEvent(n,e);l.refreshControl(d)}return this},select:function(e,t){var a=this;if(0===a.recordCount())return this;var r=[];if(t){var l,i=t.split(","),s=[],n=i.length;for(l=0;n>l;l++)s[l]=a.getFieldValue(i[l]);var o,d,u=a.recno();try{for(var c=0,f=a.recordCount();f>c;c++){for(a.recnoSilence(c),d=1,l=0;n>l;l++)if(o=a.getFieldValue(i[l]),o!=s[l]){d=0;break}d&&(a.selected(e),r.push(a.recno()))}}finally{a.recnoSilence(u)}}else a.selected(e),r.push(a.recno());var h=jslet.data.RefreshEvent.selectRecordEvent(r,e);return a.refreshControl(h),this},dataProvider:function(e){return void 0===e?this._dataProvider:(this._dataProvider=e,this)},_checkDataProvider:function(){if(!this._dataProvider)throw new Error("DataProvider required, use: yourDataset.dataProvider(yourDataProvider);")},selectedRecords:function(){var e=this;if(!e.hasRecord())return null;var t=e.recno(),a=[];try{for(var r=0,l=e.recordCount();l>r;r++)e.recnoSilence(r),e.selected()&&a.push(e.getRecord())}finally{e.recnoSilence(t)}return a},hasSelectedRecords:function(){var e=this,t=!1;return e.iterate(function(){return this.selected()?(t=!0,!0):void 0}),t},selectedKeyValues:function(){var e=this.recno(),t=[];try{for(var a=0,r=this.recordCount();r>a;a++){this.recnoSilence(a);var l=this.selected();l&&2!==l&&t.push(this.getFieldValue(this._keyField))}}finally{this.recnoSilence(e)}return t.length>0?t:null},queryUrl:function(e){return void 0===e?this._queryUrl:(jslet.Checker.test("Dataset.queryUrl",e).isString(),this._queryUrl=e?jslet.trim(e):null,this)},query:function(e){if(e&&e instanceof jslet.data.Dataset){var t=e;if(t.confirm(),t.checkAndShowError())return new jslet.EmptyPromise("fail");e=t.getRecord()}return this._queryCriteria=e,this.requery()},_doQuerySuccess:function(e,t){var a=t;if(!e)return a.records([]),void(e&&e.info&&jslet.showInfo(e.info));a._onDataQuerying&&a._onDataQuerying(e);var r=e.meta;r&&r.main&&a._createDatasetByMeta(a._name,r.main);var l=e.main;l&&a.records(l);var i=e.others;if(i){var s,n;for(s in i)r&&r[s]&&a._createDatasetByMeta(a._name,r[s]),n=jslet.data.getDataset(s),n?n.records(i[s]):console.warn(s+" is returned from server, but this datase does not exist!")}e.pageNo&&(a._pageNo=e.pageNo),e.pageCount&&(a._pageCount=e.pageCount),a._onDataQueried&&a._onDataQueried.call(a);var o=jslet.data.RefreshEvent.changePageEvent();a.refreshControl(o),e&&e.info&&jslet.showInfo(e.info)},_createDatasetByMeta:function(e,t){var a=jslet.data.getDataset(e),r=dsMetaFields;if(a){a.clearFields();for(var l,i=0,s=r.length;s>i;i++)l=r[i],a.createField(l)}else a=new jslet.data.Dataset({name:e,fields:r})},_doApplyError:function(e,t){var a=t,r=e.errorCode,l=e.errorMessage;if(jslet.global.serverErrorHandler){var i=jslet.global.serverErrorHandler(r,l);if(i)return}l=l+"["+r+"]",a.errorMessage(l),a._autoShowError&&jslet.showError(l)},requery:function(){var e=this;if(e._checkDataProvider(),!this._queryUrl)throw new Error(jslet.formatMessage(jsletlocale.Dataset.queryUrlRequired,[e.description()]));if(!e._querying){e._querying=!0;try{var t={};e._pageNo>0&&(t.pageNo=e._pageNo,t.pageSize=e._pageSize);var a=e._queryCriteria;a&&(jslet.isArray(a)?t.criteria=a:t.simpleCriteria=a),t=jslet.data.record2Json(t);var r=e._queryUrl;return e._dataProvider.sendRequest(e,r,t).done(e._doQuerySuccess).fail(e._doApplyError).always(function(){e._querying=!1})}catch(l){e._querying=!1}}},_setChangedState:function(e,t,a){if(t&&0!==t.length)for(var r=this._addRecordClassFlag(t,e,this._recordClass||jslet.global.defaultRecordClass),l=0,i=r.length;i>l;l++)a.push(r[l])},_addRecordClassFlag:function(e,t,a){var r,l,i,s=this.getFields(),n=null;for(l=0,i=s.length;i>l;l++)r=s[l],r.getType()===jslet.data.DataType.DATASET&&(n||(n={}),n[r.name()]=r.detailDataset().recordClass());var o,d,u,c,f=[];for(l=0,c=e.length;c>l;l++){o=e[l],d={},o[jslet.global.changeStateField]=t+l;var h;for(var v in o)h=o[v],h&&n&&(u=n[v],u&&(h=this._addRecordClassFlag(h,t,u))),d[v]=h;f.push(d)}return f},_doSaveSuccess:function(e,t){var a,r=t,l=!1;e&&e.main&&0!==e.main.length?(a=e.main,l=!0):a=r._pendingRecords,r._dataTransformer.refreshSubmittedData(a),l&&r._calcAggregatedValueDebounce.call(r),r.selection.removeAll(),r._onDataSubmitted&&r._onDataSubmitted.call(r),r.refreshControl(),r.refreshLookupHostDataset(),e&&e.info&&jslet.showInfo(e.info)},submitUrl:function(e){return void 0===e?this._submitUrl:(jslet.Checker.test("Dataset.submitUrl",e).isString(),this._submitUrl=e?jslet.trim(e):null,this)},hasChangedData:function(e){var t=this;e||t.confirm();var a,r=t.records();if(!r)return!1;for(var l=0,i=r.length;i>l;l++)if(a=r[l],t.recordChanged(a))return!0;return!1},recordChanged:function(e){if(!e)return!1;var t=jslet.data.getRecInfo(e);return!(!t||!t.status||t.status===jslet.data.DataSetStatus.BROWSE)},submit:function(e,t){return this._innerSubmit(e,t)},submitDeleted:function(e){return this._innerSubmit(e,options,!0)},_innerSubmit:function(e,t,a){var r=this,l=t&&t.range,i=t&&t.includeFields,s=t&&t.excludeFields;if(r.confirm(),r.checkAndShowError(i,s,l))return new jslet.EmptyPromise("fail");if(r._checkDataProvider(),!r._submitUrl)throw new Error(jslet.formatMessage(jsletlocale.Dataset.submitUrlRequired,[r.description()]));var n=t&&t.detailRange,o=r._dataTransformer.getSubmittingChanged(l,n);if(o&&a)for(var d=o.length-1;d>=0;d--)"d"!==o[d].rs[0]&&o.splice(d,1);if(!o||0===o.length)return jslet.showInfo(jsletlocale.Dataset.noDataSubmit),new jslet.EmptyPromise("fail");if(!r._submitting){r._submitting=!0;try{var u={},c=r.name();u.mainName=c,u.main=o;var f={};u.meta=f,r._getSubmitMeta(r,f,"main"),e&&(u.extraData=e),r._pendingRecords=o,u=jslet.data.record2Json(u,r._getExcludeFields(i,s));var h=r._submitUrl;return r._dataProvider.sendRequest(r,h,u).done(r._doSaveSuccess).fail(r._doApplyError).always(function(){r._submitting=!1,r._pendingRecords=null})}catch(v){console.error(v),r._submitting=!1,r._pendingRecords=null}}},_getSubmitMeta:function(e,t,a){var r,l,i,s=this,n=[],o={fields:n},d=s.recordClass();d&&(o.recordClass=d),a||(a=e.name()),t[a]=o;for(var u=e._fields,c=0,f=u.length;f>c;c++)if(r=u[c],i=r.dataType(),i!==jslet.data.DataType.DATE)if(i!==jslet.data.DataType.DATASET);else{l={name:r.name(),dataType:i};var h=r.detailDataset();l.detailDataset=h.name(),s._getSubmitMeta(h,o),n.push(l)}else l={name:r.name(),dataType:i},n.push(l)},_doSubmitSelectedSuccess:function(e,t){if(e){var a=e.main;if(!a||0===a.length)return void(e.info&&jslet.showInfo(e.info));var r,l,i,s=t,n=s._deleteOnSuccess_,o=s.selectedRecords()||[],d=s.records();if(s.selection.removeAll(),n){for(r=o.length;r>=0;r--)i=o[r],l=d.indexOf(i),d.splice(l,1);s._refreshInnerRecno()}else{s._dataTransformer.refreshSubmittedData(a)}s._calcAggregatedValueDebounce.call(s),s._onDataSubmitted&&s._onDataSubmitted.call(s),s.refreshControl(),s.refreshLookupHostDataset(),e&&e.info&&jslet.showInfo(e.info)}},submitSelected:function(e,t,a){var r=this;r.confirm();var l=a&&a.range,i=a&&a.includeFields,s=a&&a.excludeFields,n=a&&a.submitEmpty;if(void 0===l&&(l=jslet.data.RecordRange.SELECTED),r.checkAndShowError(i,s,l))return new jslet.EmptyPromise("fail");if(r._checkDataProvider(),jslet.Checker.test("Dataset.submitSelected#url",e).required().isString(),!r._submitting){r._submitting=!0;var o=!(!a||!a.deleteOnSuccess),d=a&&a.detailRange;try{var u=r._dataTransformer.getSubmittingSelected(l,d)||[];if(!(n||u&&0!==u.length))return jslet.showInfo(jsletlocale.Dataset.noDataSubmit),new jslet.EmptyPromise("fail");r._deleteOnSuccess_=o;var c={},f=r.name();c.mainName=f,c.main=u;var h={};return c.meta=h,r._getSubmitMeta(r,h,"main"),t&&(c.extraData=t),c=jslet.data.record2Json(c,r._getExcludeFields(i,s)),console.log(c),r._dataProvider.sendRequest(r,e,c).done(r._doSubmitSelectedSuccess).fail(r._doApplyError).always(function(){r._submitting=!1})}catch(v){r._submitting=!1}}},_getExcludeFields:function(e,t){if(!e||0===e.length)return t||null;for(var a,r,l,i,s=this,n=s.getNormalFields(),o=[],l=0,i=n.length;i>l;l++)r=a.name(),e.indexOf(r)<0&&o.push(r);if(t)for(l=0,i=t.length;i>l;l++)r=t[l],exFields.indexOf(r)<0&&o.push(r);return o},_refreshInnerControl:function(e){var t,a,r;if(e.eventType==jslet.data.RefreshEvent.UPDATEALL||e.eventType==jslet.data.RefreshEvent.CHANGEMETA)for(a=this._linkedLabels?this._linkedLabels.length:0,t=0;a>t;t++)r=this._linkedLabels[t],r.refreshControl&&r.refreshControl(e);for(a=this._linkedControls?this._linkedControls.length:0,t=0;a>t;t++)r=this._linkedControls[t],r&&r.refreshControl&&r.refreshControl(e)},focusEditControl:function(e){if(jslet.temp.focusing||!e)return this;var t,a=this,r=a.getField(e);if(!r)return console.warn("Not found field: "+e+" in dataset: "+a.name()),this;var l=r.detailDataset();if(l)return e=l.getFirstFocusField(),l.focusEditControl(e),this;for(var i=a._linkedControls.length-1;i>=0;i--)if(t=a._linkedControls[i],t.field&&t.field()==e){jslet.temp.focusing=!0;try{t.focus()}finally{jslet.temp.focusing=!1;break}}return this},focusFirstErrorField:function(){var e=jslet.data.FieldError.getFirstErrorField(this.getRecord());return e?(this.focusEditControl(e),this):this},refreshField:function(e){return this.refreshControl(jslet.data.RefreshEvent.updateColumnEvent(e)),this},refreshLookupField:function(e){var t=jslet.data.RefreshEvent.lookupEvent(e);return this.refreshControl(t),this},refreshControl:function(e,t){this._lockCount||(e||(e=jslet.data.RefreshEvent.updateAllEvent()),t&&jslet.data.FieldValueCache.removeAllCache(this),this._refreshInnerControl(e))},addLinkedControl:function(e){if(e.isLabel)this._linkedLabels.push(e);else{this._linkedControls.push(e);var t=null;e.field&&(t=e.field()),t&&e.canFocus()&&(this._canFocusFields||(this._canFocusFields=[]),this._canFocusFields.push(t))}},removeLinkedControl:function(e){var t=e.isLabel?this._linkedLabels:this._linkedControls;if(t){var a=t.indexOf(e);if(a>=0&&t.splice(a,1),!e.isLabel&&e.field){var r=e.field();r&&(a=this._canFocusFields.indexOf(r),a>=0&&this._canFocusFields.splice(a,1))}}},refreshLookupHostDataset:function(){this._autoRefreshHostDataset&&jslet.data.datasetRelationManager.refreshLookupHostDataset(this._name)},handleLookupDatasetChanged:function(e){var t=this;t._inContextRule||jslet.data.FieldValueCache.clearAll(t,e),t.refreshLookupField(e)},innerExportTextArray:function(e,t){function a(){g=[];for(var e=0;u>e;e++)if(c=v[e],f=c.name(),j=c.getType(),j!==jslet.data.DataType.DATASET){if(j!==jslet.data.DataType.NUMBER||c.lookup()){if(F=r.getFieldText(f),null!==F&&void 0!==F||(F=""),F&&j===jslet.data.DataType.STRING){var t=F.replace;t?F=jslet.removeHtmlTag(F):F+=""}}else F=c.getValue(),null===F||void 0===F?F="":F+="";g.push(F)}else g.push(c.detailDataset().innerExportTextArray({exportHeader:!1}));p.push(g)}var r=this;r.confirm(),r.existDatasetError()&&console.warn(jsletlocale.Dataset.cannotConfirm);var l=!0,i=!1,s=!1,n=jslet.data.RecordRange.ALL,o=null,d=null;e&&jQuery.isPlainObject(e)&&(void 0!==e.exportHeader&&(l=!!e.exportHeader),void 0!==e.recordRange&&(n=e.recordRange,s=n===jslet.data.RecordRange.CURRENT,i=n===jslet.data.RecordRange.SELECTED),void 0!==e.includeFields&&(o=e.includeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.includeFields",o).isArray()),void 0!==e.excludeFields&&(d=e.excludeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.excludeFields",d).isArray()));var u,c,f,h=null,v=jslet.temp.exportFields&&jslet.temp.exportFields[r.name()];if(!v){v=[],u=r._normalFields.length;for(var _=0;u>_;_++){if(c=r._normalFields[_],f=c.name(),o&&o.length>0){if(o.indexOf(f)<0)continue}else if(!c.visible())continue;d&&d.length>0&&d.indexOf(f)>=0||(t&&c.getType()===jslet.data.DataType.DATE&&(h||(h=[]),h.push(_)),v.push(c))}jslet.temp.exportFields&&(jslet.temp.exportFields[r.name()]=v)}var g,p=[];if(u=v.length,l){for(g=[],_=0;u>_;_++)c=v[_],f=c.label(),g.push(f);p.push(g)}var F,j;if(s)return a(),p;var m=r.startSilenceMove();try{for(r.first();!r.isEof();)!i||r.selected()?(a(),r.next()):r.next();return t?[p,h]:p}finally{r.endSilenceMove(m)}},exportTextArray:function(e){jslet.temp.exportFields={};try{return this.innerExportTextArray(e)}finally{delete jslet.temp.exportFields}},exportCsv:function(e){var t=this.innerExportTextArray(e,!0),a=t[1];if(t=t[0],0===t.length)return"";var r=!0;void 0!==e.escapeDate&&(r=!!e.escapeDate);for(var l,i=t[0],s=i.length,n=",",o='"',d=!1,u=0,c=t.length;c>u;u++){i=t[u];for(var f=0;s>f;f++){if(l=i[f]){l=l.replace(/"/g,'""');var h=!1;l.startsWith("0")?h=!0:(d=!1,r&&a&&u>0&&a.indexOf(f)>=0&&(d=!0)),l=o+l+o,(h||d)&&(l="="+l)}else l='""';i[f]=l}t[u]=i.join(n)}return t.join("\n")},exportCsvFile:function(e,t){jslet.Checker.test("Dataset.exportCsvFile#fileName",e).required().isString();var a=this.exportCsv(t),r=document.createElement("a"),l=new window.Blob([a],{type:"text/csv"});r.href=window.URL.createObjectURL(l),r.download=e,r.click()},filteredRecords:function(){var e=this,t=[],a=e.recnoSilence();e.confirm();try{for(var r=0,l=e.recordCount();l>r;r++)e.recnoSilence(r),t.push(e.getRecord())}finally{e.recnoSilence(a)}return t},filteredDataList:function(){return this.filteredRecords()},iterate:function(e,t,a){jslet.Checker.test("Dataset.iterate#callBackFn",e).required().isFunction();var r=this,l=r.startSilenceMove();try{t=t||0,0===a||a||(a=r.recordCount()-1);for(var i=t;a>=i&&(r.recno(i),!e||!e.call(r));i++);}finally{r.endSilenceMove(l)}return this},records:function(e){var t=this;if(void 0===e)return t._masterField?t.masterDataset().getFieldValue(t._masterField):t._records;if(t._isEnum&&e&&!jslet.isArray(e)){var a=[];if(jslet.isString(e))for(var r,l,i=jslet.trim(e),s=i.split(","),n=0,o=s.length;o>n;n++)r=jslet.trim(s[n]),l=r.split(":"),a[a.length]={code:jslet.trim(l[0]),name:jslet.trim(l[1])};else for(var d in e)a[a.length]={code:d,name:e[d]};return t._records=a,t._initialize(),this}jslet.Checker.test("Dataset.records",e).isArray(),t._masterField?(null===e&&(e=[]),t.masterDataset().setFieldValue(t._masterField,e)):t._records=e,t._initialize();var u=t._detailDatasetFields;if(u)for(var c,f,n=0,h=u.length;h>n;n++)c=u[n],f=c.detailDataset(),f&&(f.confirm(),f._initialize());return t.calcContextRule(),this},dataList:function(e){return this.records(e)},_initialize:function(e){var t=this;e||(jslet.data.FieldValueCache.removeAllCache(t),jslet.data.FieldError.clearDatasetError(t),t._changeLog.clear()),t.status(jslet.data.DataSetStatus.BROWSE),t._recno=-1,t.disableControls();try{t._sortByFields(),t.filter(null),t.filtered()||t.fixedFilter()?t._doFilterChanged():t.calcAggregatedValue(),t.first()}finally{t.enableControls()}t.refreshLookupHostDataset()},exportTextList:function(e,t){var a=this;a.confirm();var r,l,i,s,n,o,d=a.recno(),u=[];if(e||e){l=[];for(var c=0;r>c;c++)i=a._normalFields[c],s=i.name(),e&&e.indexOf(s)>=0&&l.push(i),!e&&t&&t.indexOf(s)<0&&l.push(i)}else l=a._normalFields;r=l.length;try{for(var f=0,h=a.recordCount();h>f;f++){a.recnoSilence(f),o={};for(var v=0;r>v;v++)i=l[v],s=i.name(),n=i.getType()===jslet.data.DataType.DATASET?i.detailDataset().exportTextList():a.getFieldText(s),o[s]=n;u.push(o)}return u}finally{this.recnoSilence(d)}},importTextList:function(e,t,a){var r=this;if(jslet.Checker.test("importTextList#textList",e).isArray(),e&&0!==e.length){t||(t=0),a||0===a||(a=e.length-1),r.disableControls(),r.clearFollowedValues();var l=r.valueFollowEnabled();r.valueFollowEnabled(!1);var i=r.readOnly();try{var s,n,o,d,u,c,f,h,v=r._normalFields.length,_={},g=r.recno();r.readOnly(!1);for(var p=t;a>=p;p++){s=e[p],r.appendRecord();for(var F=0;v>F;F++)if(n=r._normalFields[F],o=n.name(),d=s[o],void 0!==d&&""!==d&&null!==d)if(n.lookup())u=_[o],u?c=u[d]:(u={},_[o]=u,c=null),c?(f=c.value,h=c.error,r.setFieldValue(o,f),h&&r.setFieldError(o,h.message,null,h.inputText)):(r.setFieldText(o,d),f=r.getFieldValue(o),h=r.getFieldError(o),u[d]={value:f,error:h});else if(n.getType()===jslet.data.DataType.DATASET){if(0===d.length)continue;n.detailDataset().importTextList(d)}else r.setFieldText(o,d);r.confirm()}}finally{r._sortByFields(),r.readOnly(i),r.valueFollowEnabled(l),r.recno(g+1),r.enableControls()}}},exportSnapshot:function(){function e(t,a){var i,s=t._detailDatasetFields;if(s)for(var n,o,d=0,u=s.length;u>d;d++)n=s[d],o=n.detailDataset(),o&&(i={name:o.name(),recno:o.recno(),status:o.status()},r=o.indexFields(),r&&(o.indexFields=r),l=o.filter(),l&&(o.filter=l,o.filtered=o.filtered()),a.push(i),e(o,a))}var t=this;if(0===t.records())return null;if(t.masterDataset())throw new Error('Can not call this method on detail dataset! Call it on "'+t.masterDataset().name()+'"!');var a={name:t.name(),recno:t.recno(),status:t.status(),records:t.records(),changedRecords:t._changeLog._changedRecords},r=t.indexFields();r&&(a.indexFields=r);var l=t.filter();l&&(a.filter=l,a.filtered=t.filtered());var i={master:a},s=[];return e(t,s),i.details=s,i},importSnapshot:function(e){jslet.Checker.test("Dataset.importSnapshot#snapshot",e).required().isPlanObject();var t=e.master;jslet.Checker.test("Dataset.importSnapshot#snapshot.master",t).required().isPlanObject();var a=this,r=t.name;if(a.masterDataset())throw new Error('Can not call this method on detail dataset! Call it on "'+a.masterDataset().name()+'"!');if(r!=a._name)throw new Error(jslet.formatMessage(jsletlocale.Dataset.cannotImportSnapshot,[r,a._name]));if(a._records=t.records||null,a._changeLog._changedRecords=t.changedRecords,void 0!==t.indexFields&&a.indexFields(t.indexFields),void 0!==t.filter&&(a.filter(t.filter),a.filtered(t.filtered)),t.recno>=0){a._silence++;try{a.recno(t.recno),t.status&&a.status(t.status)}finally{a._silence--}}a.calcAggregatedValue(),a.refreshControl();var l=e.details;if(l&&0!==l.length)for(var i,s,n=0,o=l.length;o>n;n++)if(i=l[n],s=jslet.data.getDataset(i.name)){if(void 0!==i.indexFields&&s.indexFields(i.indexFields),void 0!==i.filter&&(s.filter(i.filter),s.filtered(i.filtered)),i.recno>=0){s._silence++;try{s.recno(i.recno),i.status&&s.status(i.status)}finally{s._silence--}}s.refreshControl()}},createField:function(e,t,a){jslet.Checker.test("Dataset.createField#fieldConfig",e).required().isObject();var r=this,l=e.type||e.dataType;if(l===jslet.data.DataType.EXTEND)r._createExtendField(e,t);else{var i=new jslet.data.Field(r,e,t);r.addField(i,a)}return i},_createExtendField:function(e,t){jslet.Checker.test("createExtendField#extendFields",e.extendFields).required().isArray();var a=this,r=e.asChild;if(r){var l=t;t=new jslet.data.Field(a,e,t),l||a.addField(t)}for(var i,s,n={},o=e.extendFields,d=e.onCreatingExtendField,u=[],c="",f=e.name,h=!1,v=0,_=o.length;_>v;v++)n=o[v],d&&d(n),i=new jslet.data.Field(a,n,t),n.needSum&&(c+="+["+i.name()+"]",h||(s=n),h=!0),i.extendHostName(f),u.push(i);return h&&(n=s,n.name=e.name+"_sum",n.label=jslet.trim((r?"":e.label||e.name)+jsletlocale.Dataset.totalLabel),n.formula=c.substring(1),i=new jslet.data.Field(a,n,t),u.push(i)),t||a.addFields(u),u},createFields:function(e){if(e){jslet.Checker.test("Dataset.createFields#fieldConfigs",e).isArray();for(var t=0,a=e.length;a>t;t++)this.createField(e[t],null,!0);this.refreshDisplayOrder(),this.refreshAggregatedFields()}},destroy:function(){var e=this;e._masterDataset=null,e._masterField=null,e._fields=null,e._linkedLabels=null,e._linkedControls=null,e._innerFilter=null,e._innerFindCondition=null,e._sortingFields=null,e._innerFormularFields=null,e._aggregatedFields=null,jslet.data.dataModule[e._name]=null,delete jslet.data.dataModule[e._name],jslet.data.datasetRelationManager.removeDataset(e._name)}},jslet.data.createEnumDataset=function(e,t){return new jslet.data.Dataset({name:e,isEnum:!0,records:t})},jslet.data.createDynamicDataset=function(e,t,a){jslet.Checker.test("createDynamicDataset#dsName",e).required().isString();var r=jslet.data.getDataset(e);if(r)return r;t&&t.maxCreatingLevel&&jslet.data.defaultDatasetCreatingManager.setMaxCreateLevel(e,maxCreatingLevel);var l=t.datasetType,i=l&&l===jslet.data.DatasetType.LOOKUP;jslet.data.defaultDatasetCreatingManager.startCreateDataset(e,a,i),jslet.global.dataset.onDatasetCreating&&jslet.global.dataset.onDatasetCreating(e,t)},jslet.data.createDataset=function(e,t,a,r){jslet.Checker.test("createDataset#dsName",e).required().isString(),jslet.Checker.test("createDataset#fieldConfig",t).required().isArray(),jslet.Checker.test("Dataset.createDataset#datasetCfg",a).isPlanObject(),r&&jslet.data.defaultDatasetCreatingManager.setMaxCreateLevel(e,r);var l=new jslet.data.Dataset(jQuery.extend({name:e,fields:t},a));if(jslet.data.defaultDatasetCreatingManager.endCreateDataset(e),l.isFireGlobalEvent()){var i=jslet.data.globalDataHandler.datasetCreated();i&&i(l)}return l},jslet.data.ChangeLog=function(e){this._dataset=e,this._changedRecords=null},jslet.data.ChangeLog.prototype={changedRecords:function(e){return void 0===e?this._getChangedRecords():void(this._changedRecords=e)},log:function(e){if(this._dataset.logChanges()){e||(e=this._dataset.getRecord());var t=jslet.data.getRecInfo(e);if(t.status){var a=this._getChangedRecords();a.indexOf(e)<0&&a.push(e)}}},unlog:function(e){if(this._dataset.logChanges()){e||(e=this._dataset.getRecord());var t=this._getChangedRecords(),a=t.indexOf(e);a>=0&&t.splice(a,1)}},clear:function(){this._changedRecords=null},_getChangedRecords:function(){var e,t=this._dataset,a=t.masterDataset(),r=t.masterField();if(a&&r){var l=jslet.data.getRecInfo(a.getRecord());l.detailLog||(l.detailLog={}),e=l.detailLog[r],e||(e=[],l.detailLog[r]=e)}else this._changedRecords||(this._changedRecords=[]),e=this._changedRecords;return e}},jslet.data.DataTransformer=function(e){this._dataset=e},jslet.data.DataTransformer.prototype={hasChangedData:function(){var e=this._dataset._changeLog.changedRecords();return!(!e||0===e.length)},getSubmittingChanged:function(e,t){e&&e!==jslet.data.RecordRange.ALL||(e=jslet.data.RecordRange.CHANGED);var a=this._getRecords(this._dataset,e);if(e!==jslet.data.RecordRange.CHANGED){for(var r,l=[],i=this._dataset,s=0,n=a.length;n>s;s++)r=a[s],i.recordChanged(r)&&l.push(r);a=l}var o=this._convert(this._dataset,a,t);return o},getSubmittingSelected:function(e,t){e||e===jslet.data.RecordRange.ALL||(e=jslet.data.RecordRange.SELECTED);var a=this._getRecords(this._dataset,e),r=this._convert(this._dataset,a,t);return r},_getRecords:function(e,t){var a=null;switch(t){case jslet.data.RecordRange.ALL:a=e.records();break;case jslet.data.RecordRange.SELECTED:a=e.selectedRecords();break;case jslet.data.RecordRange.CURRENT:a=[e.getRecord()];break;case jslet.data.RecordRange.CHANGED:a=e._changeLog.changedRecords()}return a},_convertRecord:function(e,t,a,r,l){var i,s,n={};for(var o in t)if("_jl_"!==o)if(i=e.getField(o),i&&i.getType()===jslet.data.DataType.DATASET){s=r.detailLog;var d=i.detailDataset(),u=d.selectField()||jslet.global.selectStateField,c=a;jslet.isObject(a)&&(c=a[d.name()]);var f,h,v,_=[],g=t[o];if(c===jslet.data.RecordRange.ALL){if(g)for(f=0,h=g.length;h>f;f++)v=g[f],_.push(v);if(s=s?s[o]:null)for(f=0,h=s.length;h>f;f++){var p=s[f],F=jslet.data.getRecInfo(p);F&&F.status===jslet.data.DataSetStatus.DELETE&&_.push(p)}}else if(c===jslet.data.RecordRange.CHANGED)_=s?s[o]:null;else if(c===jslet.data.RecordRange.SELECTED&&g)for(f=0,h=g.length;h>f;f++)v=g[f],v[u]&&_.push(v);_=this._convert(d,_),_&&(n[o]=_)}else n[o]=t[o];return n},_convert:function(e,t,a){if(a||(a=jslet.data.RecordRange.ALL),!t||0===t.length)return null;for(var r,l,i,s=e._recordClass||jslet.global.defaultRecordClass,n=[],o=e.selectField()||jslet.global.selectStateField,d=0,u=t.length;u>d;d++){r=t[d],l=jslet.data.getRecInfo(r),r[jslet.global.changeStateField]=this._getStatusPrefix(l.status,r[o])+Math.round(1e4*Math.random());var i=this._convertRecord(e,r,a,l,s);n.push(i)}return n},_getStatusPrefix:function(e,t){return e===jslet.data.DataSetStatus.INSERT?"i":e===jslet.data.DataSetStatus.UPDATE?"u":e===jslet.data.DataSetStatus.DELETE?"d":t?"s":""},refreshSubmittedData:function(e){e&&0!==e.length&&this._refreshDataset(this._dataset,e)},_refreshDataset:function(e,t,a){if(t&&0!==t.length)for(var r,l=(e.getMasterFieldObject(),e._changeLog.changedRecords()),i=0,s=t.length;s>i;i++)r=t[i],r?this._refreshRecord(e,r,l):console.warn(jsletlocale.Dataset.serverReturnNullRecord)},_refreshRecord:function(e,t,a){var r=t[jslet.global.changeStateField];if(r){var l,i;if(a&&"d"==r.charAt(0)){for(l=0,i=a.length;i>l;l++)if(r==a[l][jslet.global.changeStateField]){a.splice(l,1);break}}else{var s,n,o=e.records()||[];for(l=o.length-1;l>=0;l--)if(s=o[l],s[jslet.global.changeStateField]==r){for(var d in t)d&&(n=e.getField(d),n&&n.detailDataset()?this._refreshDataset(n.detailDataset(),t[d],!0):s[d]=t[d]);if(a)for(l=0,i=a.length;i>l;l++)if(r==a[l][jslet.global.changeStateField]){a.splice(l,1);break}s[jslet.global.changeStateField]=null;var u=s[jslet.global.auditLogField];u&&delete s[jslet.global.auditLogField];var c=jslet.data.getRecInfo(s);c&&c.status&&(c.status=0),jslet.data.FieldValueCache.removeCache(s)}}}}},jslet.data.DatasetFactory=function(){this._maxCreatingLevels={},this._creatingDatasets=[],this._metaStores=[],this._doDatasetCreatedDebounce=jslet.debounce(this._doDatasetCreated,100)},jslet.data.DatasetFactory.prototype={addMetaStore:function(e){return jslet.Checker.test("DatasetFactory.addMetaStore",e).required(),jslet.Checker.test("DatasetMetaStore.getDatasetMeta",e.getDatasetMeta).required().isFunction(),this._metaStores.push(e),this},createDataset:function(e,t){function a(e,t){var a=jslet.data.getDataset(e);if(a)return null;console.log("Creating dataset: "+e);var r=null,i=null;if(t){var i=t.hostDatasetName;if(i&&!l._canCreatingDataset(i))return null;t.maxCreatingLevel&&(l._maxCreatingLevels[e]=t.maxCreatingLevel),r=t.datasetType,i=t.hostDatasetName}var s=r&&r===jslet.data.DatasetType.LOOKUP;return l._startCreateDataset(e,i,s),e}function r(e,t,a){var a=a||0;if(a>l._metaStores.length-1)return void l._innerCreateDataset(e,null,null,s);var i=l._metaStores[a],n=e;t&&t.realDatasetName&&(n=t.realDatasetName);var o=i.getDatasetMeta(e);o&&o.done?o.done(function(i){i?l._innerCreateDataset(e,i,t,s):r(e,t,a+1)}).fail(function(){r(e,t,a+1)}):o?l._innerCreateDataset(e,o,t,s):r(e,t,a+1)}var l=this;if(!l._metaStores||0===l._metaStores.length)throw new Error(jsletlocale.DatasetFactory.datasetMetaStoreRequired);jslet.Checker.test("createDataset#datasetNames",e).required();var i,s=jQuery.Deferred();if(jslet.isArray(e)){var n,o=[],d=e.length;for(n=0;d>n;n++)i=e[n],i=l._beforeCreateOneDataset(i,t),i&&o.push(i);for(d=o.length,n=0;d>n;n++)r(o[n],t)}else a(e,t)&&r(e,t);return s.promise()},_innerCreateDataset:function(e,t,a,r){if(!t)throw new Error(jslet.formatMessage(jsletlocale.DatasetFactory.metaNotFound,[e]));!t.isEnum&&a&&a.datasetType===jslet.data.DatasetType.LOOKUP&&(t=jQuery.extend({},t),this._filterOutLookupFields(t,a)),t.createdByFactory=!0;new jslet.data.Dataset(t);if(t.criteriaFields){var l={name:e+"_criteria",fields:t.criteriaFields};new jslet.data.Dataset(l)}this._doDatasetCreatedDebounce.call(this,r)},_filterOutLookupFields:function(e,t){var a=(!!t.onlyLookupFields,t.includeFields),r=t.excludeFields,l=t.visibleFields,i={},s=!1,n=e.codeField,o=e.nameField;t.onlyLookupFields&&(s=!0,e.keyField&&(i[e.keyField]=!0),n&&(i[n]=!0),o&&(i[o]=!0),e.parentField&&(i[e.parentField]=!0),e.statusField&&(i[e.statusField]=!0));var d,u,c;if(a)for(s=!0,d=0,u=a.length;u>d;d++)i[a[d]]=!0;if(r)for(s=!0,d=0,u=r.length;u>d;d++)c=r[d],i[c]&&(i[c]=!1);var f,h=e.fields,v=[];for(d=0,u=h.length;u>d;d++)f=h[d],c=f.name,(!s||s&&i[c])&&(f=jQuery.extend({},f),v.push(f),l&&l.indexOf(c)>=0?f.visible=!0:f.visible=c==n||c==o);e.fields=v},_startCreateDataset:function(e,t,a){var r;if(t){if(r=this._getDsCfg(t),r||(r={name:t,level:0,relative:[]},this._creatingDatasets.push(r)),!this._getDsCfg(e)){var l=r.relative;l||(r.relative=[],l=r.relative),l.push({name:e,level:a?r.level+1:0,parent:r})}console.debug(e+"->"+t)}},_canCreatingDataset:function(e){var t=this._getDsCfg(e);if(!t)return!0;for(var a=t,r=0;;){if(!a.parent){r=this._maxCreatingLevels[a.name];break}a=a.parent}return!r||t.level!==r},_checkAllCreated:function(e){for(var t,a=!0,r=e.relative,l=0,i=r.length;i>l;l++){if(t=r[l],!jslet.data.getDataset(t.name))return!1;if(t.relative&&(a=this._checkAllCreated(t),!a))return!1}return!0},_getDsCfg:function(e,t){if(!e)return null;var t,a;void 0===t&&(t=this._creatingDatasets);for(var r=0,l=t.length;l>r;r++){if(a=t[r],a.name==e)return a;if(a.relative&&(a=this._getDsCfg(e,a.relative)))return a}return null},_doDatasetCreated:function(e){for(var t,a,r=this._creatingDatasets,l=!0,i=r.length-1;i>=0;i--){if(t=r[i],a=t.name,!this._checkAllCreated(t)){l=!1;break}r.splice(i,1),delete this._maxCreatingLevels[a]}l&&e.resolve()}},jslet.data.datasetFactory=new jslet.data.DatasetFactory,jslet.data.DatasetMetaStore={getDatasetMeta:function(e){}},jslet.data.Expression=function(e,t){if(jslet.Checker.test("jslet.data.Expression#dataset",e).required(),jslet.Checker.test("jslet.data.Expression#expr",t).required().isString(),this._fields=[],this._otherDatasetFields=[],this._expr=t,this._parsedExpr="","string"==typeof e){if(this._dataset=jslet.data.getDataset(e),!this._dataset)throw new Error(jslet.formatMessage(jsletlocale.Dataset.datasetNotFound,[e]))}else jslet.Checker.test("jslet.data.Expression#dataset",e).isClass(jslet.data.Dataset.className),
this._dataset=e;this.context={mainds:e},this.parse()},jslet.data.Expression.prototype={_ParserPattern:/\[[_a-zA-Z][\.!\w]*(,\d){0,1}]/gim,parse:function(){var e,t,a,r,l,i,s,n=0,o=[],d=null;for(this._ParserPattern.lastIndex=0;null!==(i=this._ParserPattern.exec(this._expr));)if(r=i[0],r&&!r.endsWith("(")){if(a=null,r=r.substr(1,r.length-2),t=r.indexOf(","),t>0&&(d=parseInt(r.substr(t+1)),isNaN(d)&&(d=null),r=r.substr(0,t)),t=r.indexOf("!"),t>0&&(a=r.substr(0,t),r=r.substr(t+1)),e=i.index,s=this._dataset,a){if(l=jslet.data.dataModule[a],!l)throw new Error(jslet.formatMessage(jsletlocale.Dataset.datasetNotFound,[a]));this.context[a]=l,s=l}a?(o.push(this._expr.substring(n,e)),o.push("context."),o.push(a),o.push('.getFieldValue("'),this._otherDatasetFields.push({dataset:a,fieldName:r})):(o.push(this._expr.substring(n,e)),o.push('context.mainds.getFieldValueByRecord(context.dataRec, "'),this._fields.push(r)),o.push(r),o.push('"'),null!==d&&(o.push(","),o.push(d)),o.push(")"),n=e+i[0].length}o.push(this._expr.substr(n)),this._parsedExpr=o.join("")},mainFields:function(){return this._fields},otherDatasetFields:function(){return this._otherDatasetFields},eval:function(dataRec){var context=this.context;context.mainds=this._dataset,context.dataRec=dataRec;var like=jslet.like,between=jslet.between,inlist=jslet.inlist,inArray=jslet.inArray,inchildren=function(e,t,a){return context.mainds.inChildren(e,t,a)},inChildren=inchildren,inchildrenandself=function(e,t,a){return context.mainds.inChildrenAndSelf(e,t,a)},inChildrenAndSelf=inchildrenandself;return eval(this._parsedExpr)},destroy:function(){this._dataset=null,this._fields=null,this._otherDatasetFields=[],this._parsedExpr=null,this._expr=null,this.context=null}},jslet.data.Field=function(e,t,a){var r=this;r._dataset=null,r._datasetName=null,r._displayOrder=null,r._tabIndex=null,r._shortName=null,r._proxyHostFieldName=null,r._proxyFldObjs=null,r._proxyFieldChanged=null,r._currProxyFieldName=null,r._length=0,r._scale=0,r._unique=!1,r._defaultExpr=null,r._defaultValue=null,r._label=null,r._displayLabel=null,r._tip=null,r._displayWidth=0,r._editMask=null,r._displayFormat=null,r._dateFormat=null,r._formula=null,r._readOnly=!1,r._visible=!0,r._disabled=!1,r._unitConverted=!1,r._lookup=null,r._displayControl=null,r._editControl=null,r._detailDataset=null,r._urlExpr=null,r._innerUrlExpr=null,r._urlTarget=null,r._valueStyle=jslet.data.FieldValueStyle.NORMAL,r._valueCountLimit=0,r._valueCountRange=null,r._required=!1,r._nullText=jsletlocale.Dataset.nullText,r._dataRange=null,r._regularExpr=null,r._antiXss=!0,r._customValueAccessor=null,r._customValueConverter=null,r._customValidator=null,r._validChars=null,r._dateChar=null,r._dateRegular=null,r._parent=null,r._children=null,r._trueValue=!0,r._falseValue=!1,r._trueText=null,r._falseText=null,r._mergeSame=!1,r._mergeSameBy=null,r._fixedValue=null,r._valueFollow=!1,r._trimBlank=!0,r._focused=!1,r._encrypted=null,r._aggregated=!1,r._aggregatedBy=null,r._extendHostName=null,r._crossSource=null,r._dataset=e,r._create(t,a)},jslet.data.Field.className="jslet.data.Field",jslet.data.Field.prototype={className:jslet.data.Field.className,_create:function(e,t){function a(t){var a=e[t];void 0!==a&&i[t](a)}jslet.Checker.test("Field#fieldConfig",e).required().isObject();var r=jslet.trim(e.name);if(!r)throw new Error(jslet.formatMessage(jsletlocale.Dataset.fieldNameRequired));var l=e.type||e.dataType;null===l||void 0===l?l=jslet.data.DataType.STRING:(l=l.toUpperCase(),l!==jslet.data.DataType.STRING&&l!==jslet.data.DataType.NUMBER&&l!==jslet.data.DataType.DATE&&l!==jslet.data.DataType.BOOLEAN&&l!==jslet.data.DataType.CROSS&&l!==jslet.data.DataType.PROXY&&l!==jslet.data.DataType.ACTION&&l!==jslet.data.DataType.EDITACTION&&l!==jslet.data.DataType.DATASET&&(l=jslet.data.DataType.STRING));var i=this;if(i._fieldName=r,i._dataType=l,i.parent(t),t){var s=t.children();s||(s=[],t.children(s)),s.push(i)}if(a("tabIndex"),a("displayOrder"),a("label"),a("displayLabel"),a("shortName"),a("tip"),l===jslet.data.DataType.PROXY)return jslet.Checker.test("Field.proxyHostFieldName",e.proxyHostFieldName).required().isString(),jslet.Checker.test("Field.proxyFieldChanged",e.proxyFieldChanged).required().isFunction(),a("proxyHostFieldName"),void a("proxyFieldChanged");if(l===jslet.data.DataType.DATASET){var n=e.detailDataset||e.subDataset;if(!n)throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidDatasetField,[r]));return i.detailDataset(n),void i.visible(!1)}if(a("visible"),l===jslet.data.DataType.EDITACTION)return i._displayWidth=3,void(i._readOnly=!0);if(a("displayWidth"),a("fixedValue"),l===jslet.data.DataType.ACTION){if(!e.fixedValue)throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidActionField,[r]));return void(i._readOnly=!0)}a("formula"),a("unique"),a("required"),a("readOnly"),a("disabled"),a("length"),a("scale"),a("alignment"),a("defaultExpr"),a("defaultValue"),a("editMask"),a("displayFormat"),a("nullText"),a("unitConverted"),a("editControl"),a("urlExpr"),a("urlTarget"),a("valueStyle"),a("valueCountLimit"),a("valueCountRange"),a("dataRange"),a("customValidator"),a("customValueConverter"),a("customValueAccessor"),a("trueValue"),a("falseValue"),a("mergeSame"),a("mergeSameBy"),a(e.aggraded?"aggraded":"aggregated"),a(e.aggradedBy?"aggradedBy":"aggregatedBy"),a("valueFollow"),a("trimBlank"),a("focused"),a("encrypted"),a("antiXss"),a("validChars"),a("trueValue"),a("falseValue"),a("trueText"),a("falseText");var o=e.regularExpr,d=e.regularMessage;o&&i.regularExpr(o,d);var u=e.lookup;if(void 0===u){var c=e.lookupSource||e.lookupDataset,f=e.lookupParam,h=e.realSource||e.realDataset;c&&(u=f?jslet.isString(f)?jslet.JSON.parse(f):f:{},u.dataset=c,h&&(u.realDataset=h))}if(void 0!==u&&u&&i.lookup(u),e.children){for(var v,_,g=0,p=e.children.length;p>g;g++)_=e.children[g],v=new jslet.data.Field(i._dataset,_,i),void 0===_.displayOrder&&v.displayOrder(g);i.alignment("center")}},dataset:function(e){var t=this;if(void 0===e)return t._parent&&!t._dataset&&t.dataset(t._parent.dataset()),t._dataset;jslet.isString(e)?e=jslet.data.getDataset(e):jslet.Checker.test("Field.dataset",e).isClass(jslet.data.Dataset.className),e&&(t._datasetName=e.name()),t._removeRelation(),t._dataset=e,t._clearFieldCache(),t._addRelation();var a=t._children;if(a)for(var r,l=0,i=a.length;i>l;l++)r=a[l],r.dataset(t._dataset);return this},name:function(){return arguments.length>0&&console.error("Can't change field name!"),this._fieldName},shortName:function(e){var t=this;return void 0===e?t._shortName:(jslet.Checker.test("Field.shortName",e).isString(),t._shortName=e,this)},label:function(e){var t=this;return void 0===e?t._dataType===jslet.data.DataType.EDITACTION?"  ":t._label||t._fieldName:(jslet.Checker.test("Field.label",e).isString(),t._label=e,t._fireMetaChangedEvent("label"),t._fireGlobalMetaChangedEvent("label"),this)},displayLabel:function(e){var t=this;return void 0===e?t._dataType===jslet.data.DataType.EDITACTION?"  ":t._displayLabel||t.label():(jslet.Checker.test("Field.displayLabel",e).isString(),t._displayLabel=e,t._fireMetaChangedEvent("label"),t._fireGlobalMetaChangedEvent("label"),this)},fullLabel:function(e){if(!this.parent())return this.label();void 0===e&&(e="_");for(var t=[this.label()],a=this.parent();a;)t.push(a.label()),a=a.parent();return t.reverse().join(e)},tip:function(e){var t=this;return void 0===e?t._tip:(jslet.Checker.test("Field.tip",e).isString(),t._tip=e,t._fireMetaChangedEvent("tip"),t._fireGlobalMetaChangedEvent("tip"),this)},getType:function(){if(this._dataType==jslet.data.DataType.PROXY){var e=this._getProxyPropValue("dataType")||jslet.data.DataType.STRING;return e===jslet.data.DataType.DATASET?this._dataType:e}return this._dataType},dataType:function(e){if(void 0===e)return this._dataType;jslet.Checker.test("Field#dataType",e).isString().required();var t=e;return null===t?t=jslet.data.DataType.STRING:(t=t.toUpperCase(),t!=jslet.data.DataType.STRING&&t!=jslet.data.DataType.NUMBER&&t!=jslet.data.DataType.DATE&&t!=jslet.data.DataType.BOOLEAN&&t!=jslet.data.DataType.CROSS&&t!=jslet.data.DataType.PROXY&&t!=jslet.data.DataType.ACTION&&t!=jslet.data.DataType.EDITACTION&&t!=jslet.data.DataType.DATASET&&(t=jslet.data.DataType.STRING)),this._dataType=t,this},proxyHostFieldName:function(e){var t=this;return void 0===e?t._proxyHostFieldName:void(t._proxyHostFieldName=e)},proxyFieldChanged:function(e){var t=this;return void 0===e?t._proxyFieldChanged:(jslet.Checker.test("Field.proxyFieldChanged",e).required().isFunction(),t._proxyFieldChanged=e,this)},changeProxyFieldName:function(e,t){var a,r=this;if(a=e[r._proxyHostFieldName],a&&r._currProxyFieldName!=a){r._proxyFldObjs||(r._proxyFldObjs={});var l=(r._proxyFldObjs[r._currProxyFieldName],r._proxyFldObjs[a]);l||(l=new jslet.data.Field(r._dataset,{name:a,dataType:"S"}),r._proxyFieldChanged.call(r._dataset,e,a,l),r._proxyFldObjs[a]=l),r._currProxyFieldName=a,t||r._fireMetaChangedEvent("editControl")}},_getProxyPropValue:function(e){if(!this._proxyFldObjs)return null;var t=this._proxyFldObjs[this._currProxyFieldName];return t?t[e]():null},_setProxyPropValue:function(e,t){if(this._proxyFldObjs){var a=this._proxyFldObjs[this._currProxyFieldName];a&&a[e](t)}},parent:function(e){var t=this;return void 0===e?t._parent:(jslet.Checker.test("Field.parent",e).isClass(this.className),t._parent=e,this)},children:function(e){var t=this;if(void 0===e)return t._children;jslet.Checker.test("Field.children",e).isArray();for(var a=0,r=e.length;r>a;a++)jslet.Checker.test("Field.children#childField",e[a]).isClass(this.className);return t._children=e,this},displayOrder:function(e){var t=this;return void 0===e?t._displayOrder:(jslet.Checker.test("Field.displayOrder",e).isNumber(),t._displayOrder=parseInt(e),t._fireGlobalMetaChangedEvent("displayOrder"),this)},tabIndex:function(e){var t=this;return void 0===e?t._tabIndex:(jslet.Checker.test("Field.tabIndex",e).isNumber(),e=e?parseInt(e):null,t._tabIndex=NaN!==e?e:null,t._fireMetaChangedEvent("tabIndex"),t._fireGlobalMetaChangedEvent("tabIndex"),this)},length:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("length")||10:t._length||10:(jslet.Checker.test("Field.length",e).isGTEZero(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("length",parseInt(e)):t._length=parseInt(e),t._fireGlobalMetaChangedEvent("length"),this)},getEditLength:function(){var e=this,t=e.lookup(),a=e.length();if(t){var r=t.codeField(),l=t.nameField(),i=t.dataset();if(i&&r){var s=i.getField(r);return s&&(a=s.getEditLength()),l&&(s=i.getField(l),s&&(a=Math.max(a,s.getEditLength()))),a}}return e.getType()===jslet.data.DataType.NUMBER&&e.scale()>0?a+1:a>0?a:10},scale:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("scale")||0:t._scale:(jslet.Checker.test("Field.scale",e).isGTEZero(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("scale",parseInt(e)):t._scale=parseInt(e),t._fireGlobalMetaChangedEvent("scale"),this)},alignment:function(e){var t=this;if(void 0===e){var a=t._alignment;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("alignment")),a?a:t.lookup()?"left":t.getType()==jslet.data.DataType.NUMBER?"right":t.getType()==jslet.data.DataType.BOOLEAN?"center":"left"}return jslet.Checker.test("Field.alignment",e).isString(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("alignment",jslet.trim(e)):t._alignment=jslet.trim(e),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("alignment"),this},nullText:function(e){var t=this;return void 0===e?t._nullText:(jslet.Checker.test("Field.nullText",e).isString(),e=jslet.trim(e),t._nullText=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("nullText"),this)},displayWidth:function(e){var t=this;return void 0===e?t._displayWidth<=0?t.length()||12:t._displayWidth:(jslet.Checker.test("Field.displayWidth",e).isGTEZero(),t._displayWidth=parseInt(e),t._fireGlobalMetaChangedEvent("displayWidth"),this)},defaultExpr:function(e){var t=this;return void 0===e?t._defaultExpr:(jslet.Checker.test("Field.defaultExpr",e).isString(),t._defaultExpr=e,t._fireGlobalMetaChangedEvent("defaultExpr"),this)},displayFormat:function(e){var t=this;if(void 0===e){var a=t._displayFormat;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("displayFormat")),a?a:t.getType()==jslet.data.DataType.DATE?jsletlocale.Date.format:a}return jslet.Checker.test("Field.displayFormat",e).isString(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("displayFormat",jslet.trim(e)):t._displayFormat=jslet.trim(e),t._dateFormat=null,t._dateChar=null,t._dateRegular=null,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("displayFormat"),this},defaultValue:function(e){var t=this;return void 0===e?t._defaultValue:(jslet.Checker.test("Field.defaultValue",t.dftValue).isDataType(t._dateType),t._defaultValue=e,t._fireGlobalMetaChangedEvent("defaultValue"),this)},unique:function(e){var t=this;return void 0===e?t._unique:(t._unique=!!e,t._fireGlobalMetaChangedEvent("unique"),this)},required:function(e){var t=this;return void 0===e?t._required:(t._required=!!e,t._fireMetaChangedEvent("required"),t._fireGlobalMetaChangedEvent("required"),this)},editMask:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("editMask"):t._editMask:(e?jslet.isString(e)&&(e={mask:e,keepChar:!1}):e=null,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("editMask",e):t._editMask=e,t._clearFieldCache(),t._fireMetaChangedEvent("editMask"),t._fireGlobalMetaChangedEvent("required"),this)},dateFormat:function(){var e=this;if(e._dateFormat)return e._dateFormat;if(this.getType()!=jslet.data.DataType.DATE)return null;var t=this.displayFormat().toUpperCase();e._dateFormat="";for(var a,r=0,l=t.length;l>r;r++)a=t.charAt(r),"YMD".indexOf(a)<0||e._dateFormat.indexOf(a)<0&&(e._dateFormat+=a);return e._dateFormat},dateSeparator:function(){var e=this;if(e._dateChar)return e._dateChar;if(this.getType()!=jslet.data.DataType.DATE)return null;for(var t,a=this.displayFormat().toUpperCase(),r=0,l=a.length;l>r;r++)if(t=a.charAt(r),"YMD".indexOf(t)<0)return e._dateChar=t,t},dateRegular:function(){var e=this;if(e._dateRegular)return e._dateRegular;for(var t,a=this.dateFormat(),r=this.dateSeparator(),l=["^"],i=0;i<a.length;i++)i>0&&(l.push("\\"),l.push(r)),t=a.charAt(i),"Y"==t?l.push("(\\d{4}|\\d{2})"):"M"==t?l.push("(0?[1-9]|1[012])"):l.push("(0?[1-9]|[12][0-9]|3[01])");return l.push("(\\s+\\d{2}:\\d{2}:\\d{2}(\\.\\d{3}){0,1}){0,1}"),l.push("$"),e._dateRegular={expr:new RegExp(l.join(""),"gim"),message:jslet.formatMessage(jsletlocale.Dataset.invalidDate,[e._displayFormat])},e._dateRegular},formula:function(e){var t=this;if(void 0===e)return t._formula;jslet.Checker.test("Field.formula",e).isString(),t._formula=jslet.trim(e),t._readOnly=!0,t._clearFieldCache();var a=t.dataset();return a&&(a.removeInnerFormulaField(t._fieldName),a.addInnerFormulaField(t._fieldName,t._formula),t._fireColumnUpdatedEvent()),t._fireGlobalMetaChangedEvent("formula"),this},visible:function(e){var t=this;if(void 0===e){if(t._visible)for(var a=this.parent();a;){if(!a.visible())return!1;a=a.parent()}return t._visible}return t._visible=!!e,t._fireMetaChangedEvent("visible"),t._fireGlobalMetaChangedEvent("visible"),this},disabled:function(e){var t=this;return void 0===e?t._formula||t._dataType===jslet.data.DataType.DATASET||t._children?!1:t._disabled:(t._disabled=!!e,t._fireMetaChangedEvent("disabled"),t._fireGlobalMetaChangedEvent("disabled"),this)},readOnly:function(e){var t=this;if(void 0===e){if(t._dataType==jslet.data.DataType.DATASET)return!0;var a=t.children();return a&&0===a.length?!0:t._readOnly||t._dataset.readOnly()}return t._readOnly=!!e,t._fireMetaChangedEvent("readOnly"),t._fireGlobalMetaChangedEvent("readOnly"),this},fieldReadOnly:function(){var e=this;if(e._dataType==jslet.data.DataType.DATASET)return!0;var t=e.children();return t&&0===t.length?!0:e._readOnly},fieldDisabled:function(){return this._disabled},_fireGlobalMetaChangedEvent:function(e){var t=this.dataset();if(t&&t.designMode()&&t.isFireGlobalEvent()){var a=jslet.data.globalDataHandler.fieldMetaChanged();a&&a.call(this,t,this._fieldName,e)}},_fireMetaChangedEvent:function(e){var t=this.dataset();if(t){var a=jslet.data.RefreshEvent.changeMetaEvent(e,this._fieldName);t.refreshControl(a)}},_fireColumnUpdatedEvent:function(){var e=this.dataset();if(e){var t=jslet.data.RefreshEvent.updateColumnEvent(this._fieldName);e.refreshControl(t)}},unitConverted:function(e){var t=this;if(void 0===e)return t._dataType==jslet.data.DataType.NUMBER?t._unitConverted:!1;t._unitConverted=!!e;var a=this.dataset();return t._clearFieldCache(),t._dataType==jslet.data.DataType.NUMBER&&a&&1!=a.unitConvertFactor()&&t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("unitConverted"),this},valueStyle:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.DATASET||t._children&&t._children.length>0?jslet.data.FieldValueStyle.NORMAL:t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("valueStyle"):t._valueStyle:(e=e?parseInt(e):0,jslet.Checker.test("Field.valueStyle",e).isNumber().inArray([0,1,2]),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("valueStyle",e):t._valueStyle=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireMetaChangedEvent("valueStyle"),t._fireGlobalMetaChangedEvent("valueStyle"),this)},valueCountLimit:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("valueCountLimit"):t._valueCountLimit:(e?jslet.Checker.test("Field.valueCountLimit",e).isNumber():e=0,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("valueCountLimit",parseInt(e)):t._valueCountLimit=parseInt(e),t._fireGlobalMetaChangedEvent("valueCountLimit"),this)},valueCountRange:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("valueCountRange"):t._valueCountRange:(e&&(jslet.Checker.test("Field.valueCountRange",e).isObject(),jslet.Checker.test("Field.valueCountRange",e.min).isGTEZero(),jslet.Checker.test("Field.valueCountRange",e.max).isGTEZero()),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("valueCountRange",e):t._valueCountRange=e,t._fireGlobalMetaChangedEvent("valueCountRange"),this)},displayControl:function(e){var t=this;if(void 0===e){var a=t._displayControl;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("displayControl")),t.getType()!=jslet.data.DataType.BOOLEAN||a?a:{type:"dbcheckbox"}}return e=jslet.isString(e)?{type:e}:e,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("displayControl",e):t._displayControl=e,t._fireGlobalMetaChangedEvent("displayControl"),this},editControl:function(e){var t=this;if(void 0===e){var a=t._editControl;if(t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("editControl")),a)return a;var r=t.getType();return r==jslet.data.DataType.BOOLEAN?{type:"dbcheckbox"}:r==jslet.data.DataType.DATE?{type:"dbdatepicker"}:t.lookup()?{type:"dbselect"}:{type:"dbtext"}}jslet.isString(e)&&(e=jslet.trim(e),e=e?e.indexOf(":")>0?jslet.JSON.parse(e):{type:e}:null);var l=t._getProxyPropValue("editControl");return l&&e&&l.type==e.type?this:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("editControl",e):t._editControl=e,t._fireMetaChangedEvent("editControl"),t._fireGlobalMetaChangedEvent("editControl"),this)},_addRelation:function(){var e,t=this,a=t.lookup(),r=t._datasetName;if(r&&(t.getType()==jslet.data.DataType.DATASET||a)){var l,i=t._fieldName;if(t.getType()==jslet.data.DataType.DATASET){if(t._detailDataset){e=t._getDatasetName(t._detailDataset),l=jslet.data.DatasetType.DETAIL,jslet.data.datasetRelationManager.addRelation(r,i,e,l);var s=jslet.data.getDataset(t._detailDataset);s&&(s.masterDataset(r),s.masterField(i))}}else e=t._getDatasetName(a._dataset),l=jslet.data.DatasetType.LOOKUP,jslet.data.datasetRelationManager.addRelation(r,i,e,l)}},_removeRelation:function(){var e=this,t=e.lookup(),a=e._datasetName;if(a&&(e._detailDataset||t)){var r,l=e._fieldName;if(e._detailDataset){r=e._getDatasetName(e._detailDataset);var i=jslet.data.getDataset(e._detailDataset);i&&(i.masterDataset(null),i.masterField(null))}else r=e._getDatasetName(t._dataset);jslet.data.datasetRelationManager.removeRelation(a,l,r)}},lookup:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("lookup"):t._lookup:(e&&e.className!=jslet.data.FieldLookup.className&&(e=new jslet.data.FieldLookup(t,e)),t._removeRelation(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("lookup",e):t._lookup=e,e&&t._addRelation(),t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireLookupChangedEvent(),this)},_fireLookupChangedEvent:function(){var e=this;if(e._dataset){var t=this.name(),a=jslet.data.RefreshEvent.lookupEvent(t,!0);this._dataset.refreshControl(a)}},_getDatasetName:function(e){return jslet.isString(e)?e:e.name()},subDataset:function(e){return this.detailDataset(e)},detailDataset:function(e){var t=this;if(void 0===e){if(t._detailDataset&&jslet.isString(t._detailDataset)&&(t.detailDataset(t._detailDataset),jslet.isString(t._detailDataset)))throw new Error(jslet.formatMessage(jsletlocale.Dataset.datasetNotFound,[t._detailDataset]));return t._detailDataset}if(t._removeRelation(),!e)return t._detailDataset=null,this;if(jslet.isString(e)){var a=jslet.data.getDataset(e);if(!a){if(t._detailDataset=e,t._dataset.createdByFactory)jslet.data.datasetFactory.createDataset(e);else if(jslet.global.dataset.onDatasetCreating){var r=t._datasetName,l={datasetType:jslet.data.DatasetType.DETAIL};jslet.data.createDynamicDataset(e,l,r)}return t._addRelation(),this}e=a}else jslet.Checker.test("Field.detailDataset",e).isClass(jslet.data.Dataset.className);return t._detailDataset=e,t._addRelation(),this},urlExpr:function(e){var t=this;return void 0===e?t._urlExpr:(jslet.Checker.test("Field.urlExpr",e).isString(),t._urlExpr=jslet.trim(e),t._innerUrlExpr=null,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("urlExpr"),this)},urlTarget:function(e){var t=this;return void 0===e?t._urlTarget?t._urlTarget:jslet.data.Field.URLTARGETBLANK:(jslet.Checker.test("Field.urlTarget",e).isString(),t._urlTarget=jslet.trim(e),t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("urlTarget"),this)},calcUrl:function(){var e=this;return this.dataset()&&e._urlExpr?(e._innerUrlExpr||(e._innerUrlExpr=new jslet.data.Expression(this.dataset(),e._urlExpr)),e._innerUrlExpr.eval()):null},antiXss:function(e){var t=this;return void 0===e?t._antiXss:(t._antiXss=!!e,t._fireGlobalMetaChangedEvent("antiXss"),this)},dataRange:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("dataRange"):t._dataRange:(e&&jslet.isString(e)&&(e=jslet.JSON.parse(e)),e&&(jslet.Checker.test("Field.dataRange",e).isObject(),e.min&&jslet.Checker.test("Field.dataRange.min",e.min).isDataType(t._dateType),e.max&&jslet.Checker.test("Field.dataRange.max",e.max).isDataType(t._dateType)),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("dataRange",e):t._dataRange=e,t._fireGlobalMetaChangedEvent("dataRange"),this)},regularExpr:function(e,t){var a=this,r=arguments.length;return 0===r?a._dataType==jslet.data.DataType.PROXY?a._getProxyPropValue("regularExpr"):a._regularExpr:(r>1&&(e={expr:e,message:t}),a._dataType==jslet.data.DataType.PROXY?a._setProxyPropValue("regularExpr",e):a._regularExpr=e,a._fireGlobalMetaChangedEvent("regularExpr"),this)},customValueAccessor:function(e){var t=this;return void 0===e?t._customValueAccessor:(t._customValueAccessor=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("customValueAccessor"),this)},customValueConverter:function(e){var t=this;return void 0===e?t._customValueConverter:(t._customValueConverter=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("customValueConverter"),this)},customValidator:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("customValidator"):t._customValidator:(e&&jslet.Checker.test("Field.customValidator",e).isFunction(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("customValidator",e):t._customValidator=e,t._fireGlobalMetaChangedEvent("customValidator"),this)},validChars:function(e){var t=this;if(void 0===e){var a=t._validChars;if(t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("validChars")),a)return a;if(t.getType()==jslet.data.DataType.NUMBER)return t._scale?"+-0123456789.":"+-0123456789";if(t.getType()==jslet.data.DataType.DATE){var r=t.displayFormat();e="0123456789";for(var l=0,i=r.length;i>l;l++){var s=r.charAt(l);"y"!==s&&"M"!==s&&"d"!==s&&"h"!==s&&"m"!==s&&"s"!==s&&(e+=s)}return e}return null}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("validChars",e):t._validChars=e,t._fireGlobalMetaChangedEvent("validChars"),this},trueValue:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("trueValue"):t._trueValue:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("trueValue",e):t._trueValue=e,this)},falseValue:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("falseValue"):t._falseValue:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("falseValue",e):t._falseValue=e,this)},trueText:function(e){var t=this;if(void 0===e){var a=t._trueText;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("trueText")),a||jsletlocale.Dataset.trueText}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("trueText",e):t._trueText=e,this},falseText:function(e){var t=this;if(void 0===e){var a=t._falseText;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("falseText")),a||jsletlocale.Dataset.falseText}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("falseText",e):t._falseText=e,this},mergeSame:function(e){var t=this;return void 0===e?t._mergeSame:(t._mergeSame=!!e,t._fireGlobalMetaChangedEvent("mergeSame"),this)},mergeSameBy:function(e){var t=this;return void 0===e?t._mergeSameBy:(jslet.Checker.test("Field.mergeSameBy",e).isString(),t._mergeSameBy=jslet.trim(e),t._fireGlobalMetaChangedEvent("mergeSameBy"),this)},valueFollow:function(e){var t=this;return void 0===e?t._formula?!1:t._valueFollow:(t._valueFollow=!!e,!t._valueFollow&&t._dataset&&t._dataset.clearFollowedValues(),t._fireGlobalMetaChangedEvent("valueFollow"),this)},trimBlank:function(e){var t=this;return void 0===e?t._trimBlank:(t._trimBlank=!!e,t._fireGlobalMetaChangedEvent("_trimBlank"),this)},focused:function(e){var t=this;return void 0===e?t._focused:(e=!!e,e===t._focused?this:(t._focused=e,t._dataset&&t._dataset.calcFocusedFields(),t._fireGlobalMetaChangedEvent("focused"),this))},encrypted:function(e){var t=this;return void 0===e?t._encrypted:(jslet.Checker.test("Field.encrypted",e).isPlanObject(),e&&(jslet.Checker.test("Field.encrypted.start",e.start).isGTEZero(),jslet.Checker.test("Field.encrypted.end",e.end).isGTEZero()),t._encrypted=e,this)},aggregated:function(e){var t=this;return void 0===e?t._aggregated:(t._aggregated=!!e,t._dataset&&t._dataset.refreshAggregatedFields(),t._fireGlobalMetaChangedEvent("aggregated"),this)},aggraded:function(e){return this.aggregated(e)},aggregatedBy:function(e){var t=this;return void 0===e?t._aggregatedBy:(jslet.Checker.test("Field.aggregatedBy",e).isString(),t._aggregatedBy=jslet.trim(e),t._fireGlobalMetaChangedEvent("aggregatedBy"),this)},aggradedBy:function(e){return this.aggregatedBy(e)},extendHostName:function(e){var t=this;return void 0===e?t._extendHostName:(jslet.Checker.test("Field.extendHostName",e).isString(),t._extendHostName=e,this)},crossSource:function(e){var t=this;return void 0===e?t._crossSource:(jslet.Checker.test("Field.crossSource",e).isClass(jslet.data.CrossFieldSource.className),t._crossSource=e,this)},fixedValue:function(e){var t=this;return void 0===e?t._fixedValue:(jslet.Checker.test("Field.fixedValue",e).isString(),t._fixedValue=jslet.trim(e),t._fireGlobalMetaChangedEvent("fixedValue"),this)},getValue:function(e){return this._dataset.getFieldValue(this._fieldName,e)},setValue:function(e,t){return this._dataset.setFieldValue(this._fieldName,e,t),this},getTextValue:function(e,t){return this._dataset.getFieldText(this._fieldName,e,t)},setTextValue:function(e,t){return this._dataset.setFieldText(this._fieldName,e,t),this},clone:function(e,t){var a=this;jslet.Checker.test("Field.clone#fldName",e).required().isString();var r=new jslet.data.Field(t,{name:e,dataType:a._dataType,detailDataset:a._detailDataset});if(t=t||this.dataset(),r.dataset(t),r.visible(a._visible),a._parent&&r.parent(a._parent.clone(a._parent.name(),t)),a._children&&a._children.length>0){for(var l,i=[],s=0,n=a._children.length;n>s;s++)l=a._children[s],i.push(l.clone(l.name(),t));r.children(i)}return r.length(a._length),r.scale(a._scale),r.alignment(a._alignment),r.defaultExpr(a._defaultExpr),r.defaultValue(a._defaultValue),r.label(a._label),r.displayLabel(a._displayLabel),r.shortName(a._shortName),r.tip(a._tip),r.displayWidth(a._displayWidth),a._editMask&&r.editMask(a._editMask.clone()),r.displayOrder(a._displayOrder),r.tabIndex(a._tabIndex),r.displayFormat(a._displayFormat),r.formula(a._formula),r.unique(a._unique),r.required(a._required),r.readOnly(a._readOnly),r.disabled(a._disabled),r.unitConverted(a._underted),a._lookup&&r.lookup(a._lookup.clone(r)),r.displayControl(a._displayControl),r.editControl(a._editControl),r.urlExpr(a._urlExpr),r.urlTarget(a._urlTarget),r.valueStyle(a._valueStyle),r.valueCountLimit(a._valueCountLimit),r.valueCountRange(a._valueCountRange),r.nullText(a._nullText),r.dataRange(a._dataRange),a._regularExpr&&r.regularExpr(a._regularExpr),r.antiXss(a._antiXss),r.customValidator(a._customValidator),r.customValueConverter(a._customValueConverter),r.customValueAccessor(a._customValueAccessor),r.validChars(a._validChars),r.mergeSame(a._mergeSame),r.mergeSameBy(a._mergeSameBy),r.fixedValue(a._fixedValue),r.valueFollow(a._valueFollow),r.trimBlank(a._trimBlank),r.focused(a._focused),r.encrypted(a._encrypted),r.aggregated(a._aggregated),r.aggregatedBy(a._aggregatedBy),r.trueValue(a._trueValue),r.falseValue(a._falseValue),r.trueText(a._trueText),r.falseText(a._falseText),r._addRelation(),r},_clearFieldCache:function(){var e=this;e._dataset&&e._fieldName&&jslet.data.FieldValueCache.clearAll(e._dataset,e._fieldName)}},jslet.data.Field.URLTARGETBLANK="_blank",jslet.data.FieldLookup=function(e,t){jslet.Checker.test("FieldLookup#hostFldObj",e).required().isClass(jslet.data.Field.className),jslet.Checker.test("FieldLookup#lookupCfg",t).required(),jslet.isString(t)&&(t=t.trim(),t&&(t=t.trim().startsWith("{")?jslet.JSON.parse(t):{dataset:t})),jslet.Checker.test("FieldLookup#lookupCfg.dataset",t.dataset).required();var a=this;a._hostDatasetName=e.dataset().name(),a._hostField=e,a._dataset=null,a._realDataset=null,a._dsParsed=!1,a._keyField=null,a._codeField=null,a._nameField=null,a._codeFormat=null,a._displayFields=null,a._innerdisplayFields=null,a._parentField=null,a._onlyLeafLevel=!0,a._returnFieldMap=null,a._editFilter=null,a._editItemDisabled=!1,a._onlyLookupFields=!1,a._includeFields=null,a._excludeFields=null,a._visibleFields=null,a._create(t)},jslet.data.FieldLookup.className="jslet.data.FieldLookup",jslet.data.FieldLookup.prototype={className:jslet.data.FieldLookup.className,_create:function(e){var t=this;void 0!==e.realDataset&&t.realDataset(e.realDataset),void 0!==e.keyField&&t.keyField(e.keyField),void 0!==e.codeField&&t.codeField(e.codeField),void 0!==e.nameField&&t.nameField(e.nameField),void 0!==e.parentField&&t.parentField(e.parentField),void 0!==e.displayFields&&t.displayFields(e.displayFields),
void 0!==e.onlyLeafLevel&&t.onlyLeafLevel(e.onlyLeafLevel),void 0!==e.returnFieldMap&&t.returnFieldMap(e.returnFieldMap),void 0!==e.editFilter&&t.editFilter(e.editFilter),void 0!==e.editItemDisabled&&t.editItemDisabled(e.editItemDisabled),void 0!==e.onlyLookupFields&&t.onlyLookupFields(e.onlyLookupFields),void 0!==e.includeFields&&t.includeFields(e.includeFields),void 0!==e.excludeFields&&t.excludeFields(e.excludeFields),void 0!==e.visibleFields&&t.visibleFields(e.visibleFields),t.dataset(e.dataset)},clone:function(e){var t=this,a=new jslet.data.FieldLookup(e,{dataset:t._dataset});return a.keyField(t._keyField),a.codeField(t._codeField),a.nameField(t._nameField),a.displayFields(t._displayFields),a.parentField(t._parentField),a.onlyLeafLevel(t._onlyLeafLevel),a.returnFieldMap(t._returnFieldMap),a.editFilter(t._editFilter),a.editItemDisabled(t._editItemDisabled),a.onlyLookupFields(t._onlyLookupFields),a.includeFields(t._includeFields),a.excludeFields(t._excludeFields),a.visibleFields(t._visibleFields),a},toPlanObject:function(){var e=this,t={};return t.dataset=e._dataset,t.keyField=e._keyField,t.codeField=e._codeField,t.nameField=e._nameField,t.displayFields=e._displayFields,t.parentField=e._parentField,t.onlyLeafLevel=e._onlyLeafLevel,t.returnFieldMap=e._returnFieldMap,t.editFilter=e._editFilter,t.editItemDisabled=e._editItemDisabled,t.onlyLookupFields=e._onlyLookupFields,t.includeFields=e._includeFields,t.excludeFields=e._excludeFields,t.visibleFields=e._visibleFields,t},hostField:function(e){var t=this;return void 0===e?t._hostField:(jslet.Checker.test("FieldLookup.hostField",e).isClass(jslet.data.Field.className),t._hostField=e,this)},_fireLookupChangedEvent:function(){var e=this;e._hostField&&e._hostField._fireLookupChangedEvent()},dataset:function(e){var t=this;if(void 0===e){if(!t._dsParsed&&(t.dataset(t._dataset),!t._dsParsed))throw new Error("Not found lookup dataset: "+t._dataset);return t._dataset}var a;if(e&&(a="string"==typeof e?e:e.name(),a==t._hostDatasetName))throw new Error(jsletlocale.Dataset.LookupDatasetNotSameAsHost);var r=e;if("string"==typeof r&&(r=jslet.data.getDataset(r),!r)){var l={datasetType:jslet.data.DatasetType.LOOKUP,onlyLookupFields:void 0===t._onlyLookupFields||t._onlyLookupFields};t._includeFields&&(l.includeFields=t._includeFields),t._excludeFields&&(l.excludeFields=t._excludeFields),t._visibleFields&&(l.visibleFields=t._visibleFields),t._realDataset&&(l.realDatasetName=t._realDataset),t._hostField.dataset().createdByFactory?jslet.data.datasetFactory.createDataset(e,l):jslet.global.dataset.onDatasetCreating&&jslet.data.defaultDatasetCreatingManager.allowCreatingDataset(t._hostDatasetName)&&jslet.data.createDynamicDataset(e,l,t._hostDatasetName)}return r?(t._dataset=r,t._dataset.autoRefreshHostDataset(!0),t._dsParsed=!0,t._fireLookupChangedEvent()):(t._dataset=e,t._dsParsed=!1),this},realDataset:function(e){var t=this;return void 0===e?t._realDataset:(jslet.Checker.test("FieldLookup.realDataset",e).isString(),t._realDataset=e,this)},keyField:function(e){var t=this;return void 0===e?t._keyField||t.dataset().keyField():(jslet.Checker.test("FieldLookup.keyField",e).isString(),t._keyField=jslet.trim(e),t._fireLookupChangedEvent(),this)},codeField:function(e){var t=this;return void 0===e?t._codeField||t.dataset().codeField():(jslet.Checker.test("FieldLookup.codeField",e).isString(),t._codeField=jslet.trim(e),t._fireLookupChangedEvent(),this)},codeFormat:function(e){var t=this;return void 0===e?t._codeFormat:(jslet.Checker.test("FieldLookup.codeFormat",e).isString(),t._codeFormat=jslet.trim(e),t._fireLookupChangedEvent(),this)},nameField:function(e){var t=this;return void 0===e?t._nameField||t.dataset().nameField():(jslet.Checker.test("FieldLookup.nameField",e).isString(),t._nameField=jslet.trim(e),t._fireLookupChangedEvent(),this)},parentField:function(e){var t=this;return void 0===e?t._parentField||t.dataset().parentField():(jslet.Checker.test("FieldLookup.parentField",e).isString(),t._parentField=jslet.trim(e),t._fireLookupChangedEvent(),this)},displayFields:function(e){var t=this;return void 0===e?t._displayFields?t._displayFields:this.getDefaultDisplayFields():(jslet.Checker.test("FieldLookup.displayFields",e).isString(),e=jslet.trim(e),t._displayFields!=e&&(t._displayFields=e,t._innerdisplayFields=null,t._hostField&&t._hostField._clearFieldCache()),t._fireLookupChangedEvent(),this)},returnFieldMap:function(e){return void 0===e?this._returnFieldMap:(jslet.Checker.test("FieldLookup.returnFieldMap",e).isObject(),void(this._returnFieldMap=e))},getDefaultDisplayFields:function(){var e="["+(this.nameField()||this.codeField()||this.keyField())+"]";return e},getCurrentDisplayValue:function(){var e=this;return null===e._displayFields&&this.displayFields(this.getDefaultDisplayFields()),e._innerdisplayFields||(e._innerdisplayFields=new jslet.data.Expression(e.dataset(),e.displayFields())),e._innerdisplayFields.eval()},onlyLeafLevel:function(e){var t=this;return void 0===e?t._onlyLeafLevel:(t._onlyLeafLevel=!!e,t._fireLookupChangedEvent(),this)},editFilter:function(e){var t=this;return void 0===e?t._editFilter:(jslet.Checker.test("FieldLookup.editFilter",e).isString(),t._editFilter!=e&&(t._editFilter=e),t._fireLookupChangedEvent(),this)},editItemDisabled:function(e){var t=this;return void 0===e?t._editItemDisabled:(t._editItemDisabled=!!e,t._fireLookupChangedEvent(),this)},onlyLookupFields:function(e){var t=this;return void 0===e?t._onlyLookupFields:(t._onlyLookupFields=!!e,this)},includeFields:function(e){var t=this;return void 0===e?t._includeFields:(jslet.Checker.test("FieldLookup.includeFields",e).isArray(),t._includeFields=e,this)},excludeFields:function(e){var t=this;return void 0===e?t._excludeFields:(jslet.Checker.test("FieldLookup.excludeFields",e).isArray(),t._excludeFields=e,this)},visibleFields:function(e){var t=this;return void 0===e?t._visibleFields:(jslet.Checker.test("FieldLookup.visibleFields",e).isArray(),t._visibleFields=e,this)}},jslet.data.CrossFieldSource=function(){var e=this;e._sourceType=0,e._sourceField=null,e._lookupLevel=1,e._labels=null,e._values=null,e._matchExpr=null,e._hideEmptyValue=!1,e._hasSubtotal=!0,e._subtotalPosition=1,e._subtotalLabel=null},jslet.data.CrossFieldSource.className="jslet.data.CrossFieldSource",jslet.data.CrossFieldSource.prototype={className:jslet.data.CrossFieldSource.className,clone:function(){var e=this,t=new jslet.data.CrossFieldSource;return t.sourceType(e._sourceType),t.sourceField(e._sourceField),t.lookupLevel(e._lookupLevel),t.labels(e._labels),t.values(e._values),t.matchExpr(e._matchExpr),t.hideEmptyValue(e._hideEmptyValue),t.hasSubtotal(e._hasSubtotal),t.subtotalPosition(e._subtotalPosition),t.subtotalLabel(e._subtotalLabel),t},sourceType:function(e){var t=this;return void 0===e?t._sourceType:(jslet.Checker.test("CrossFieldSource.sourceType",e).isNumber(),t._sourceType=e,this)},sourceField:function(e){var t=this;return void 0===e?t._sourceField:(jslet.Checker.test("CrossFieldSource.sourceField",e).isString(),t._sourceField=e,this)},labels:function(e){var t=this;return void 0===e?t._labels:(jslet.Checker.test("CrossFieldSource.labels",e).isArray(),t._labels=e,this)},values:function(e){var t=this;return void 0===e?t._values:(jslet.Checker.test("CrossFieldSource.values",e).isArray(),t._values=e,this)},matchExpr:function(e){var t=this;return void 0===e?t._matchExpr:(jslet.Checker.test("CrossFieldSource.matchExpr",e).isString(),t._matchExpr=e,this)},hasSubtotal:function(e){var t=this;return void 0===e?t._hasSubtotal:(jslet.Checker.test("CrossFieldSource.hasSubtotal",e).isString(),t._hasSubtotal=e,this)},subtotalPosition:function(e){var t=this;return void 0===e?t._subtotalPosition:(jslet.Checker.test("CrossFieldSource.subtotalPosition",e).isNumber(),t._subtotalPosition=e,this)},subtotalLabel:function(e){var t=this;return void 0===e?t._subtotalLabel:(jslet.Checker.test("CrossFieldSource.subtotalLabel",e).isString(),t._subtotalLabel=e,this)}},jslet.data.createCrossFieldSource=function(e){var t=new jslet.data.CrossFieldSource,a=e.sourceType||0;return t.sourceType(a),void 0!==e.hasSubtotal&&t.hasSubtotal(e.hasSubtotal),void 0!==e.subtotalPosition&&t.subtotalPosition(e.subtotalPosition),void 0!==e.subtotalLabel&&t.subtotalLabel(e.subtotalLabel),0===a?t.sourceField(e.sourceField):(t.labels(e.labels),t.values(e.values),t.matchExpr(e.matchExpr)),t},jslet.data.FilterDataset=function(e){if(!jslet.data.getDataset("ds_logical_opr_")){var t=new jslet.data.Dataset({name:"ds_logical_opr_",isEnum:!0,records:{and:jsletlocale.FilterDataset.and,or:jsletlocale.FilterDataset.or}});t.isFireGlobalEvent(!1)}if(!jslet.data.getDataset("ds_operator_")){var a=[{name:"code",type:"S",length:10,label:"code"},{name:"name",type:"S",length:30,label:"name"},{name:"range",type:"S",length:30,label:"range"}],r=new jslet.data.Dataset({name:"ds_operator_",fields:a,keyField:"code",codeField:"code",nameField:"name",autoRefreshHostDataset:!0,isFireGlobalEvent:!1});r.records([{code:"==",name:jsletlocale.FilterDataset.equal,range:"NDSBLH"},{code:"!=",name:jsletlocale.FilterDataset.notEqual,range:"NDS"},{code:">",name:jsletlocale.FilterDataset.greatThan,range:"ND"},{code:">=",name:jsletlocale.FilterDataset.greatThanAndEqual,range:"ND"},{code:"<",name:jsletlocale.FilterDataset.lessThan,range:"ND"},{code:"<=",name:jsletlocale.FilterDataset.lessThanAndEqual,range:"ND"},{code:"likeany",name:jsletlocale.FilterDataset.likeany,range:"S"},{code:"likefirst",name:jsletlocale.FilterDataset.likefirst,range:"S"},{code:"likelast",name:jsletlocale.FilterDataset.likelast,range:"S"},{code:"between",name:jsletlocale.FilterDataset.between,range:"NDS"},{code:"select",name:jsletlocale.FilterDataset.select,range:"LH"},{code:"selfchildren0",name:jsletlocale.FilterDataset.selfchildren0,range:"H"},{code:"children0",name:jsletlocale.FilterDataset.children0,range:"H"},{code:"selfchildren1",name:jsletlocale.FilterDataset.selfchildren1,range:"H"},{code:"children1",name:jsletlocale.FilterDataset.children1,range:"H"}])}this._hostDataset=e,this._filterDataset=null,this._varValues=null},jslet.data.FilterDataset.prototype={filterDataset:function(){function e(e,a,r){if(a.endsWith(".Y")||a.endsWith(".M")||a.endsWith(".YM"))return r.dataType("N"),r.length(10),r.scale(0),r.editMask(null),r.displayFormat(null),r.dateFormat(null),r.displayControl(null),r.validChars(null),r.lookup(null),r.editControl("DBText"),void r.valueStyle(null);var l=jslet.data.getDataset(t._hostDataset).getField(a);if(r.dataType(l.dataType()),r.length(l.length()),r.scale(l.scale()),r.editMask(l.editMask()),r.displayFormat(l.displayFormat()),r.dateFormat(l.dateFormat()),r.displayControl(l.displayControl()),r.validChars(l.validChars()),l.lookup()){var i=l.lookup(),s=i.toPlanObject();s.onlyLeafLevel=!1,r.lookup(s),r.editControl("DBAutoComplete")}else{r.lookup(null);var n=l.editControl();0===jslet.compareValue(n.type,"DBTextArea")&&(n={type:"DBText"}),r.editControl(n)}var o=e.operator,d=jslet.data.FieldValueStyle.NORMAL;"between"==o?d=jslet.data.FieldValueStyle.BETWEEN:"select"==o&&(d=jslet.data.FieldValueStyle.MULTIPLE),r.valueStyle(d)}var t=this;if(t._filterDataset)return t._filterDataset;var a=jslet.nextId(),r=[{name:"name",type:"S",length:30,label:"Field Code"},{name:"label",type:"S",length:50,label:"Field Name"},{name:"dataType",type:"S",length:2,label:"Data Type"},{name:"parentName",type:"S",length:30,label:"Parent Field Code"}],l=jslet.data.createDataset("ds_fields_"+a,r,{keyField:"name",codeField:"name",nameField:"label",parentField:"parentName",autoRefreshHostDataset:!0,isFireGlobalEvent:!1}),i=[];t._appendFields(t._hostDataset,i),l.records(i);var s=[{name:"lParenthesis",type:"S",length:10,label:jsletlocale.FilterDataset.lParenthesis,validChars:"(",tabIndex:90980},{name:"hostField",type:"S",length:30,label:"Host Field",visible:!1},{name:"field",type:"S",length:200,displayWidth:30,label:jsletlocale.FilterDataset.field,tabIndex:90981,lookup:{dataset:l,onlyLeafLevel:!1},editControl:{type:"DBComboSelect",textReadOnly:!0},required:!0},{name:"dataType",type:"S",length:10,label:jsletlocale.FilterDataset.dataType,visible:!1},{name:"operator",type:"S",length:50,displayWidth:20,label:jsletlocale.FilterDataset.operator,lookup:{dataset:"ds_operator_"},required:!0,tabIndex:90982},{name:"value",type:"P",length:200,displayWidth:30,label:jsletlocale.FilterDataset.value,tabIndex:90983,proxyHostFieldName:"field",proxyFieldChanged:e,visible:!1},{name:"valueExpr",type:"S",length:30,visible:!1},{name:"valueExprInput",type:"S",length:2,label:" ",readOnly:!0,visible:!1,fixedValue:'<button class="btn btn-defualt btn-xs">...</button>',tabIndex:90984},{name:"rParenthesis",type:"S",length:10,label:jsletlocale.FilterDataset.rParenthesis,validChars:")",tabIndex:90985},{name:"logicalOpr",type:"S",length:10,label:jsletlocale.FilterDataset.logicalOpr,lookup:{dataset:"ds_logical_opr_"},required:!0,defaultValue:"and",tabIndex:90986}],n=new jslet.data.Dataset({name:"dsFilter_"+a,fields:s,isFireGlobalEvent:!1}),o={condition:"[field]",rules:[{field:"value",customized:function(e,a){var r=n.getFieldValue("field");if(r){var i,s=(n.getField("value",!0),jslet.data.getDataset(t._hostDataset).getField(r));if(s){var o=s.lookup();i=o?o.dataset().parentField()?"H":"L":s.getType()}else i=l.getFieldValue("dataType");a&&n.setFieldValue("dataType",i)}}}]},d={condition:"[dataType]",rules:[{field:"operator",customized:function(e,t){var a=n.getFieldValue("dataType");if(a){e=n.getField("operator");var r=e.lookup().dataset();if(r.filter('[range].indexOf("'+a+'") >= 0'),r.filtered(!0),r.first(),t){var l=r.getFieldValue("code");n.setFieldValue("operator",l)}}}}]},u={condition:"[operator]",rules:[{field:"value",customized:function(e,t){if(t){var a=n.getField("value").valueStyle(),r=n.getFieldValue("operator"),l=jslet.data.FieldValueStyle.NORMAL;"between"==r&&(l=jslet.data.FieldValueStyle.BETWEEN);var i=e.editControl().type;if("select"==r)l=jslet.data.FieldValueStyle.MULTIPLE,"DBComboSelect"!==i&&e.editControl("DBComboSelect");else{var s=n.getFieldValue("dataType");"L"!=s&&"H"!=s||"DBAutoComplete"===i||e.editControl("DBAutoComplete")}a!=l&&e.valueStyle(l)}}}]};return n.contextRules([o,d,u]),n.enableContextRule(),n.onFieldChanged(function(e,t){"field"!=e&&"operator"!=e||(this.setFieldValue("value",null),this.focusEditControl("value"))}),this._filterDataset=n,n},getFilterExprText:function(){var e=this,t=e._filterDataset;if(!t||0===t.recordCount())return null;this.validate();var a,r="",l=t.recordCount()-1;return t.iterate(function(){a=this.recno(),r+=this.getFieldValue("lParenthesis")||"",r+=this.getFieldText("field")+" ",r+=this.getFieldText("operator")+" ",r+=this.getFieldText("value"),r+=this.getFieldText("valueExpr"),r+=this.getFieldValue("rParenthesis")||"",a!=l&&(r+=" "+this.getFieldText("logicalOpr")+" ")}),r},getFilterExpr:function(){var e=this,t=e._filterDataset;if(!t||0===t.recordCount())return null;this.validate();var a,r="",l=t.recordCount()-1;return t.iterate(function(){a=this.recno();this.getFieldValue("dataType");r+=this.getFieldValue("lParenthesis")||"",r+=e._getFieldFilter(this),r+=this.getFieldValue("rParenthesis")||"",a!=l&&(r+=" "+("or"==this.getFieldValue("logicalOpr")?"||":"&&")+" ")}),r},_appendFields:function(e,t,a,r){for(var l,i=jslet.data.getDataset(e).getNormalFields(),s=0,n=i.length;n>s;s++)if(l=i[s],l.visible()&&!l.fixedValue()&&l.getType()!==jslet.data.Dataset.DATASET){var o=l.name(),d=l.label(),u=l.getType();a&&(o=a+"."+o,d=r+"."+d);var c={name:o,label:d,dataType:u};a&&(c.parentName=a),t.push(c),u===jslet.data.DataType.DATE&&(t.push({name:o+".Y",label:d+"."+jsletlocale.FilterDataset.year,dataType:"N",parentName:o}),t.push({name:o+".M",label:d+"."+jsletlocale.FilterDataset.month,dataType:"N",parentName:o}),t.push({name:o+".YM",label:d+"."+jsletlocale.FilterDataset.yearMonth,dataType:"N",parentName:o}));var f=l.lookup();f&&this._appendFields(f.dataset(),t,o,d)}},_getFieldFilter:function(e){function t(e,t){return"D"===e?"new Date("+t.getTime()+")":"S"===e?'"'+t+'"':t}var a=e.getFieldValue("field"),r=e.getFieldValue("dataType"),l=e.getFieldValue("operator"),i=e.getFieldValue("value"),s=(e.getFieldValue("valueExpr"),"");if("B"==r)return s="["+a+"]",i||(s="!"+s),s;var n="["+a+"]";if("N"===r&&(a.endsWith(".Y")?(n="["+a.substring(0,a.length-2)+"]",n="jslet.getYear("+n+")"):a.endsWith(".M")?(n="["+a.substring(0,a.length-2)+"]",n="jslet.getMonth("+n+")"):a.endsWith(".YM")&&(n="["+a.substring(0,a.length-3)+"]",n="jslet.getYearMonth("+n+")")),"=="==l||"!="==l||">"==l||">="==l||"<"==l||"<="==l)return"L"!==r&&"H"!==r||(r=this._hostDataset.getField(a).getType()),s="jslet.compareValue("+n+", "+t(r,i)+")",s+=l+"0";if("between"==l){var o=i[0],d=null;return i.length>1&&(d=i[1]),null!==o&&void 0!==o&&(s+="jslet.compareValue("+n+", "+t(r,o)+") >=0"),null!==d&&void 0!==d&&(s.length>0&&(s+=" && "),s+="jslet.compareValue("+n+", "+t(r,d)+") <=0"),"("+s+")"}if("likeany"==l||"likefirst"==l||"likelast"==l)return s="like("+n+', "',"likeany"!=l&&"likelast"!=l||(s+="%"),s+=i,"likeany"!=l&&"likefirst"!=l||(s+="%"),s+='")';if("select"==l){r=this._hostDataset.getField(a).getType(),s="inlist("+n;for(var u=0,c=i.length;c>u;u++)s+=","+t(r,i[u]);return s+=")"}if("selfchildren0"==l||"children0"==l||"selfchildren1"==l||"children1"==l){var f="inChildren";return"selfchildren0"==l||"selfchildren1"==l?f="inChildrenAndSelf":s="inChildren",r=this._hostDataset.getField(a).getType(),s=f+'("'+a+'", '+t(r,i)+",",s+="selfchildren0"==l||"children0"==l?"false)":"true)"}return s},_getFilterValue:function(e){return e.getFieldValue("value")},validate:function(){var e=this._filterDataset,t=0,a=null;return e.iterate(function(){return t=(this.getFieldValue("lParenthesis")||"").length-(this.getFieldValue("rParenthesis")||"").length,null===this.getFieldValue("value")&&null===this.getFieldValue("valueExpr")?(a=jsletlocale.FilterDataset.valueRequired,!0):void 0}),a||0===t||(a=jsletlocale.FilterDataset.parenthesisNotMatched),a&&console.error(a),a},destroy:function(){var e=this._filterDataset.getField("field").lookup().dataset();this._filterDataset.destroy(),e.destroy()}},jslet.data.FieldRawValueAccessor={getRawValue:function(e,t){var a=t.shortName()||t.name(),r=t.customValueAccessor(),l=t.getType(),i=null,s=t.extendHostName();if(s){var n=e[s];n&&(i=n[a])}else i=this._innerGetValue(e,a,r);if(void 0===i||null===i)return null;if(l===jslet.data.DataType.BOOLEAN)return i===t.trueValue();if(l===jslet.data.DataType.PROXY)return jslet.JSON.parse(i);if(l===jslet.data.DataType.DATE){var o=!1;if(jslet.isArray(i))for(var d=0,u=i.length;u>d;d++){var c=i[d];jslet.isDate(c)||(c=jslet.convertISODate(c),i[d]=c,o=!0)}else jslet.isDate(i)||(i=jslet.convertISODate(i),o=!0);o&&this._innerSetValue(e,a,i,r)}return i},setRawValue:function(e,t,a){var r=t.shortName()||t.name(),l=t.customValueAccessor(),i=t.getType();void 0===a&&(a=null),null!==a&&i===jslet.data.DataType.BOOLEAN&&(a=a?t.trueValue():t.falseValue()),null!==a&&i===jslet.data.DataType.PROXY&&(a=jslet.JSON.stringify(a));var s=t.extendHostName();if(s){var n=e[s];n||(n={},e[s]=n),n[r]=a}else this._innerSetValue(e,r,a,l)},_innerGetValue:function(e,t,a){return a?a.getValue(e,t):e[t]},_innerSetValue:function(e,t,a,r){return r?r.setValue(e,t,a):void(e[t]=a)}},jslet.data.FieldValueCache={put:function(e,t,a,r){var l=jslet.data.getRecInfo(e),i=l.cache;if(i||(i={},e._jl_.cache=i),r||0===r){var s=i[t];s&&jslet.isObject(s)||(s={},i[t]=s),s[r+""]=a}else i[t]=a},get:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.cache;if(l){if(a||0===a){var i=l[t];if(i&&jslet.isObject(i))return i[a+""];return}return l[t]}},clear:function(e,t){var a=jslet.data.getRecInfo(e),r=a.cache;if(r){var l;l=jslet.isString(t)?t.split(","):t;var i,s=l.length;for(i=0;s>i;i++)delete r[l[i]]}},clearAll:function(e,t){var a=e.records();if(a){var r;r=jslet.isString(t)?t.split(","):t;for(var l,i,s,n,o=r.length,d=0,u=a.length;u>d;d++)if(l=a[d],s=jslet.data.getRecInfo(l),i=s.cache)for(n=0;o>n;n++)delete i[r[n]]}},removeCache:function(e){var t=jslet.data.getRecInfo(e);delete t.cache},removeAllCache:function(e){var t=e.records();if(t)for(var a,r,l=0,i=t.length;i>l;l++)a=t[l],a&&(r=jslet.data.getRecInfo(a),delete r.cache)}},jslet.data.FieldValueConverter=jslet.Class.create({className:"jslet.data.FieldValueConverter",textToValue:function(e,t){var a=t;return a},valueToText:function(e,t,a){var r=t;return r},_addFieldLabel:function(e,t){return"["+e+"]: "+t}}),jslet.data.FieldValueConverter.className="jslet.data.FieldValueConverter",jslet.data.NumberValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{intRegular:{expr:/^(-)?[1-9]*\d+$/gi,message:jsletlocale.Dataset.invalidInt},floatRegular:{expr:/((^-?[1-9])|\d)\d*(\.[0-9]*)?$/gi,message:jsletlocale.Dataset.invalidFloat},textToValue:function(e,t){if(!t)return null;var a;a=e.scale()?this.floatRegular:this.intRegular;var r=a.expr;if(r.lastIndex=0,!r.test(t)){var l=this._addFieldLabel(e.label(),a.message);return void e.dataset().setFieldError(e.name(),l,null,t)}var i=void 0,s=e.scale()||0,n=e.length();if(0===s)i=parseInt(t);else{var o=t.indexOf("."),d=o>0?o:t.length,u=n-s;if(d>u){var l=this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.invalidIntegerPart,[u,d]));e.dataset().setFieldError(e.name(),l,null,t)}else if(d=o>0?t.length-o-1:0,d>s){var l=this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.invalidDecimalPart,[s,d]));e.dataset().setFieldError(e.name(),l,null,t)}else i=parseFloat(t)}return i},valueToText:function(e,t,a){var r=e.dataset();if(e.unitConverted()&&(t*=r._unitConvertFactor),a)return t;var l=jslet.formatNumber(t,e.displayFormat());return e.unitConverted()&&r._unitName&&(l+=r._unitName),l}}),jslet.data.DateValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){if(!t)return null;var a=e.dateRegular(),r=a.expr;if(r.lastIndex=0,!r.test(t)){var l=this._addFieldLabel(e.label(),a.message);return void e.dataset().setFieldError(e.name(),l,null,t)}var i=void 0;try{i=jslet.parseDate(t,e.displayFormat())}catch(s){var l=this._addFieldLabel(e.label(),s.message);e.dataset().setFieldError(e.name(),l,null,t),i=void 0}return i},valueToText:function(e,t,a){if(!(t instanceof Date))throw new Error(jslet.formatMessage(jsletlocale.Dataset.invalidDateFieldValue,[e.name(),t]));return t?jslet.formatDate(t,e.displayFormat()):""}}),jslet.data.StringValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){if(!t)return t;var a=e.regularExpr();if(a){var r=a.expr;if(r.lastIndex=0,!r.test(t)){var l=this._addFieldLabel(e.label(),a.message);return void e.dataset().setFieldError(e.name(),l,null,t)}}var i=t;return e.antiXss()&&(i=jslet.htmlEncode(i)),i},valueToText:function(e,t,a){var r=(e.dataset(),e.displayFormat());return!a&&r?jslet.formatString(t,r):t}}),jslet.data.BooleanValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){return t?"true"==t.toLowerCase():!1},valueToText:function(e,t,a){return t?e.trueText():e.falseText()}}),jslet.data.LookupValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t,a){if(!t)return null;var r="",l=e.lookup(),i=l.dataset(),s=l.keyField(),n=l.codeField(),o=l.nameField(),d=l.editFilter(),u=i.fixedFilter();if(d?u&&(d="("+d+") && ("+u+")"):d=u,r=this._convertFieldValue(i,n,t,s,d),null===r&&(o!==n&&(r=this._convertFieldValue(i,o,t,s,d)),null===r)){var c=jslet.formatMessage(jsletlocale.Dataset.valueNotFound,[e.displayLabel()]);return e.dataset().setFieldError(e.name(),c,a,t),void i.first()}return r},valueToText:function(e,t,a){var r,l=e.lookup(),i=l.dataset();return r=a?this._convertFieldValue(i,l.keyField(),t,"["+l.codeField()+"]"):this._convertFieldValue(i,l.keyField(),t,l.displayFields())},_convertFieldValue:function(e,t,a,r,l){if(null===r)throw new Error("NOT set destFields in method: ConvertFieldValue");var i=r.indexOf("[")>-1;i&&r!=e._convertDestFields&&(e._innerConvertDestFields=new jslet.data.Expression(e,r),e._convertDestFields=r),"string"!=typeof a&&(a+="");var s=jslet.global.valueSeparator,n=a.split(s),o=n.length-1;e._ignoreFilter=!0;var d=e.startSilenceMove();try{var u=l?{extraFilter:l}:null;if(0===o)return e.findByField(t,n[0],u)?i?e._innerConvertDestFields.eval():e.getFieldValue(r):null;for(var c="",f=0;o>=f;f++)c+=e.findByField(t,n[f],u)?i?e._innerConvertDestFields.eval():e.getFieldValue(r):jslet.formatMessage(jsletlocale.Dataset.notFound,n[f]),f!=o&&(c+=s);return c}finally{e._ignoreFilter=!1,e.endSilenceMove(d)}}}),jslet.data._valueConverters={},jslet.data._valueConverters[jslet.data.DataType.NUMBER]=new jslet.data.NumberValueConverter,jslet.data._valueConverters[jslet.data.DataType.STRING]=new jslet.data.StringValueConverter,jslet.data._valueConverters[jslet.data.DataType.DATE]=new jslet.data.DateValueConverter,jslet.data._valueConverters[jslet.data.DataType.BOOLEAN]=new jslet.data.BooleanValueConverter,jslet.data._valueConverters.lookup=new jslet.data.LookupValueConverter,jslet.data.getValueConverter=function(e){if(e.lookup())return jslet.data._valueConverters.lookup;var t=e.getType();return jslet.data._valueConverters[t]},jslet.data.FieldError={put:function(e,t,a,r,l){if(e){if(!a)return void jslet.data.FieldError.clear(e,t,r);var i=jslet.data.getRecInfo(e),s=i.error;s||(s={},i.error=s);var n=s[t];n||(n={},s[t]=n);var o={message:a};void 0!==l&&(o.inputText=l),r||(r=0),n[r+""]=o}},get:function(e,t,a){if(!e)return null;var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];return i?(a||(a=0),i[a+""]):null}return null},clear:function(e,t,a){if(e){var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];if(!i)return;a||(a=0),delete i[a+""];var s=!1;for(var n in i){s=!0;break}s||delete l[t]}}},existFieldError:function(e,t,a){if(!e)return!1;var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];return i?(a||(a=0),!!i[a+""]):!1}return!1},existRecordError:function(e,t,a){if(!e)return!1;var r=jslet.data.getRecInfo(e);if(!r)return!1;var l=r.error;if(l)for(var i in l)if(!(a&&a.indexOf(i)>=0||t&&t.indexOf(i)<0)&&l[i])return!0;return!1},getFirstErrorField:function(e,t,a){if(!e)return null;var r=jslet.data.getRecInfo(e);if(!r)return null;var l=r.error;if(l)for(var i in l)if(!(a&&a.indexOf(i)>=0||t&&t.indexOf(i)<0)&&l[i])return i;return null},clearFieldError:function(e,t){var a=e.records();if(a)for(var r,l,i,s=0,n=a.length;n>s;s++)r=a[s],i=jslet.data.getRecInfo(r),l=i.error,l&&delete l[t]},clearRecordError:function(e,t,a){var r=jslet.data.getRecInfo(e);if(r)if(jslet.isEmpty(t)&&jslet.isEmpty(a))delete r.error;else{var l=r.error;for(var i in l)a&&a.indexOf(i)>=0||t&&t.indexOf(i)<0||delete l[i]}},clearDatasetError:function(e){var t=e.records();if(t)for(var a,r,l=0,i=t.length;i>l;l++)a=t[l],r=jslet.data.getRecInfo(a),r&&delete r.error}},jslet.data.DataSelection=function(e){this._dataset=e,this._selection=[],this._onChanged=null},jslet.data.DataSelection.prototype={selectAll:function(e,t){if(jslet.Checker.test("DataSelection.add#fields",e).isArray(),this.removeAll(),!e){var a,r=this._dataset.getNormalFields();e=[];for(var l=0,i=r.length;i>l;l++)a=r[l].name(),e.push(a)}this.add(0,this._dataset.recordCount()-1,e,t)},removeAll:function(){this._selection=[]},add:function(e,t,a,r){jslet.Checker.test("DataSelection.add#startRecno",e).required().isNumber(),jslet.Checker.test("DataSelection.add#endRecno",t).required().isNumber(),jslet.Checker.test("DataSelection.add#fields",a).required().isArray(),void 0===t&&(t=e);for(var l,i,s=this._dataset,n=[],o=0,d=a.length;d>o;o++)l=a[o],i=s.getField(l).dataType(),i!==jslet.data.DataType.ACTION&&i!==jslet.data.DataType.EDITACTION&&n.push(l);for(var u=e;t>=u;u++)for(var c=0,f=n.length;f>c;c++)l=n[c],this._selectCell(u,l,!0);r&&this._onChanged&&this._onChanged(e,t,a,!0)},remove:function(e,t,a,r){if(jslet.Checker.test("DataSelection.remove#startRecno",e).required().isNumber(),jslet.Checker.test("DataSelection.remove#endRecno",t).required().isNumber(),jslet.Checker.test("DataSelection.remove#fields",a).required().isArray(),void 0===t&&(t=e),e>t){var l=e;e=t,t=l}for(var i,s=e;t>=s;s++)for(var n=0,o=a.length;o>n;n++)i=a[n],this._selectCell(s,i,!1);r&&this._onChanged&&this._onChanged(e,t,a,!1)},onChanged:function(e){return void 0===e?this._onChanged:(jslet.Checker.test("DataSelection.onChanged",e).isFunction(),void(this._onChanged=e))},isSelected:function(e,t){jslet.Checker.test("DataSelection.isSelected#recno",e).required().isNumber(),jslet.Checker.test("DataSelection.isSelected#fldName",t).required().isString();for(var a,r=0,l=this._selection.length;l>r;r++)if(a=this._selection[r],a._recno_===e&&a[t])return!0;return!1},getSelectionText:function(e,t,a){a||(a="	");var r=this;e=e?e:"",t=!!t;var l,i,s,n,o,d,u,c,f=r._dataset,h=[],v=f.startSilenceMove(),_=f.getNormalFields(),g=_.length,p=[];try{f.iterate(function(){o=[];for(var v=0;g>v;v++)if(d=_[v],n=d.name(),r.isSelected(f.recno(),n)){if(i=d.displayOrder(),s=p.length,i>s)for(var F=s;i>F;F++)p[F]=null;if(p[i]||(l=d.label(),p.push(jslet.removeHtmlTag(l)||" ")),c=d.getType(),"N"!==c||d.lookup())if(u=f.getFieldText(n),null===u||void 0===u)u='""';else{u=u.replace(/"/g,'""');var j=!1;u.startsWith("0")&&(j=!0),u=e+u+e,t&&(j||c===jslet.data.DataType.DATE)&&(u="="+u)}else u=d.getValue(),null!==u&&void 0!==u||(u=""),u=e+u+e;o.push(u)}o.length>0&&h.push(o.join(a))})}finally{f.endSilenceMove(v)}if(h.length>0){for(var F,j="",m=!0,y=0,C=p.length;C>y;y++)F=p[y],F&&(j+=(m?"":a)+F,m=!1);return j+"\n"+h.join("\n")}return null},_selectCell:function(e,t,a){for(var r,l=!1,i=0,s=this._selection.length;s>i;i++)r=this._selection[i],r._recno_===e&&(l=!0,r[t]=a);a&&!l&&(r={_recno_:e},r[t]=!0,this._selection.push(r))}},jslet.data.FieldValidator=function(){},jslet.data.FieldValidator.prototype={intRegular:{expr:/^(-)?[1-9]*\d+$/gi},floatRegular:{expr:/((^-?[1-9])|\d)\d*(\.[0-9]*)?$/gi},checkInputChar:function(e,t,a,r){var l=e.validChars(),i=!0;if(l&&t){var s=t.charAt(0);i=l.indexOf(s)>=0}if(a&&i&&e.getType()==jslet.data.DataType.NUMBER){var n=e.scale(),o=a.lastIndexOf(".");if("."==t)return!(o>=0);if(n>0&&o>=0&&a.length-o-1===n&&r-1>o)return!1}return i},_addFieldLabel:function(e,t){return"["+e+"]: "+t},checkRequired:function(e,t){if(e.required()){var a=!0;return null!==t&&void 0!==t||(a=!1),a&&jslet.isString(t)&&0===jslet.trim(t).length&&(a=!1),a&&jslet.isArray(t)&&0===t.length&&(a=!1),a?null:this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.fieldValueRequired))}return null},checkMultiple:function(e,t){var a=e.valueStyle();if(a!==jslet.data.FieldValueStyle.MULTIPLE||null===t||void 0===t)return null;var r=e.valueCountRange();if(!r)return null;var l=r.min,i=r.max,s=t.length,n=null;if(i&&s>i?n=jslet.formatMessage(jsletlocale.Dataset.lessThanCount,[i]):l&&l>s&&(n=jslet.formatMessage(jsletlocale.Dataset.lessThanCount,[l])),n)return this._addFieldLabel(e.label(),n);var o=e.dataRange();if(o)for(var d=0,u=s;u>d;d++)if(n=this.checkDataRange(e,t[d]))return n;return null},checkBetween:function(e,t){var a=e.valueStyle();if(a!==jslet.data.FieldValueStyle.BETWEEN||null===t||void 0===t)return null;var r=null,l=null;t&&t.length>0&&(r=t[0],t.length>1&&(l=t[1]));var i=null;return null!==r&&void 0!==r&&(i=this.checkDataRange(e,r)),i||null===l||void 0===l||this.checkDataRange(e,l),!i&&r&&l?((jslet.isDate(r)&&r.getTime()>l.getTime()||r>l)&&(i=jsletlocale.Dataset.betwwenInvalid),i):i},checkDataRange:function(e,t){var a=e.getType(),r=e.dataRange();if(!r||null===t||void 0===t)return null;var l=!!e.lookup();if(l){var i=e.lookup().dataset();t=i.lookup(i.keyField(),t,i.codeField())}var s=r.min,n=s,o=r.max,d=o,u=e.displayFormat();return a==jslet.data.DataType.DATE&&(s&&(n=jslet.formatDate(s,u)),o&&(d=jslet.formatDate(o,u))),l||a!=jslet.data.DataType.NUMBER||(n=jslet.formatNumber(s,u),d=jslet.formatNumber(o,u)),void 0!==s&&void 0!==o&&(s>t||t>o)?this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.notInRange,[n,d])):void 0!==s&&void 0===o&&s>t?this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.moreThanValue,[n])):void 0===s&&void 0!==o&&t>o?this._addFieldLabel(e.label(),jslet.formatMessage(jsletlocale.Dataset.lessThanValue,[d])):null;
},checkUnique:function(e,t){if(!e.unique()||null===t||void 0===t)return null;var a=e.dataset(),r=a.records();if(null!==t&&void 0!==t&&r&&r.length>1)for(var l,i=a.getRecord(),s=e.name(),n=0,o=r.length;o>n;n++)if(l=r[n],l!==i&&l[s]==t)return this._addFieldLabel(e.label(),jsletlocale.Dataset.notUnique);return null},checkValue:function(e,t){if(!e.visible()||e.disabled()||e.readOnly())return null;var a=this.checkRequired(e,t);if(a)return a;if(a=e.valueStyle()?this.checkMultiple(e,t)||this.checkBetween(e,t):this.checkDataRange(e,t)||this.checkUnique(e,t))return a;if(e.customValidator()){var r=e.customValidator().call(e.dataset(),e,t,jslet.data.serverValidator);if(r)return this._addFieldLabel(e.label(),r)}return null}},jslet.data.serverValidator=function(e,t){var a;jslet.global.beforeSubmit&&(a=jslet.global.beforeSubmit({url:e})),a||(a={}),a.type="POST",a.async=!1,a.contentType="application/json",a.mimeType="application/json",a.dataType="json","object"==typeof t&&(t=jslet.JSON.stringify(t)),a.data=t;var r=null;return jQuery.ajax(e,a).done(function(e,t,a){if(e){var l=e.errorCode;r=l?e.errorMessage:jslet.isString(e)?e:e.result}else r=null}).fail(function(e,t,a){var r,l=e.responseJSON;if(l&&l.errorCode)r=l.errorMessage;else{var i=t,s=t;"error"==t&&(i="0000",s=jsletlocale.Common.ConnectError),r=s}}),r},jslet.data||(jslet.data={}),jslet.data.ApplyAction={QUERY:"query",SAVE:"save",SELECTED:"selected"},jslet.data.DataProvider=function(){this.sendRequest=function(e,t,a){var r;if(jslet.global.beforeSubmit&&(r=jslet.global.beforeSubmit({url:t})),r||(r={}),r.type="POST",r.contentType="application/json",r.mimeType="application/json",r.dataType="json",r.data=a,r.context=e,e.csrfToken){var l=r.headers||{};l.csrfToken=e.csrfToken,r.headers=l}var i=jQuery.Deferred();return jQuery.ajax(t,r).done(function(e,t,a){if(e){e.csrfToken&&(this.csrfToken=e.csrfToken);var r=e.errorCode;if(r)return void i.reject(e,this)}i.resolve(e,this)}).fail(function(e,t,a){var r,l=e.responseJSON;if(l&&l.errorCode)r={errorCode:l.errorCode,errorMessage:l.errorMessage};else{var s=t,n=t;"error"==t&&(s="0000",n=jsletlocale.Common.ConnectError),r={errorCode:s,errorMessage:n}}i.reject(r,this)}).always(function(e,t,a){if(e&&jslet.isFunction(e.done)){var r,l=e.responseJSON;r=l&&l.errorCode?{errorCode:l.errorCode,errorMessage:l.errorMessage}:{errorCode:t,errorMessage:a},i.always(r,this)}else i.always(e,this)}),i.promise()}},jslet.data||(jslet.data={}),jslet.data.XLSXXPorter={importData:function(e,t){function a(e){var t=[];if(e["!ref"]){var a,r=XLSX.utils.decode_range(e["!ref"]),l=r.s.r;for(a=r.s.c;a<=r.e.c;++a){var i=e[XLSX.utils.encode_cell({c:a,r:l})],s="UNKNOWN "+a;i&&i.t&&(s=XLSX.utils.format_cell(i)),t.push(s)}return t}}if(!XLSX)throw new Error("js-xlsx.js(https://github.com/SheetJS/js-xlsx) NOT loaded!");var r=XLSX.read(t,{type:"binary"}),l={};if(0===r.SheetNames.length)return null;var i=r.SheetNames[0],s=r.Sheets[i],n=a(s),o=XLSX.utils.sheet_to_row_object_array(s);return l.data=o,l.header=n,l},exportData:function(e,t,a){function r(){function e(e){for(var t=e.length,a=new ArrayBuffer(t),r=new Uint8Array(a),l=0;l!=t;++l)r[l]=255&e.charCodeAt(l);return a}D.r=p.endRow,j["!ref"]=XLSX.utils.encode_range({s:C,e:D});var a="Sheet1",r={SheetNames:[],Sheets:{}};r.SheetNames.push(a),r.Sheets[a]=j;var l={bookType:"xlsx",bookSST:!0,type:"binary"},i=XLSX.write(r,l);saveAs(new Blob([e(i)],{type:"application/octet-stream"}),t),c&&c()}if(!XLSX)throw new Error("js-xlsx.js(https://github.com/SheetJS/js-xlsx) NOT loaded!");e.confirm(),e.existDatasetError()&&console.warn(jsletlocale.Dataset.cannotConfirm);var l=!0,i=!1,s=null,n=null,o=!1,d=!0,u=null,c=null;a&&jQuery.isPlainObject(a)&&(void 0!==a.exportHeader&&(l=!!a.exportHeader),void 0!==a.onlySelected&&(i=!!a.onlySelected),void 0!==a.exportAggregated&&(o=!!a.exportAggregated),void 0!==a.includeFields&&(s=a.includeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.includeFields",s).isArray()),void 0!==a.excludeFields&&(n=a.excludeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.excludeFields",n).isArray()),void 0!==a.onExporting&&(jslet.Checker.test("Dataset.exportCsv#exportOption.onExporting",u).isFunction(),u=a.onExporting),void 0!==a.onExported&&(jslet.Checker.test("Dataset.exportCsv#exportOption.onExported",c).isFunction(),c=a.onExported),void 0!==a.onlyOnce&&(d=!!a.onlyOnce));var f,h,v,_,g=this._getExportFields(e,s,n),p=g.datasets,F=g.fields,j={},m=0,y=F.length,C={r:0,c:0},D={r:0,c:y-1};if(l){for(_=0;y>_;_++){v=F[_];var E=v.label;E=E?jslet.removeHtmlTag(E):"",this._convertToXLSXFormat(j,m,_,"s",E)}m++,f=0,h=y-1}p.endRow=m-1;var x=e.recordCount();if(0===x)return void r();var R=this;new jslet.StepProcessor(e.recordCount(),function(e,t,a){R._innerExportData(j,p,F,i,d,o,e,t),u&&u(a),100===a&&r()}).run()},_convertToXLSXFormat:function(e,t,a,r,l){var i=XLSX.utils.encode_cell({c:a,r:t}),s={t:r,v:l};e[i]=s},_innerExportData:function(e,t,a,r,l,i,s,n){var o,d,u,c,f=t.dataset,h=f.startSilenceMove(),v=t.endRow+1,_=a.length;v=t.master?t.master.endRow:t.endRow+1;try{var g,p,F=!1;!!t.master;s||(s=0);var j=f.recordCount()-1;n||0===n||(n=j);for(var m=jslet.data.DataType.STRING,y=jslet.data.DataType.NUMBER,C=s;n>=C;C++)if(f.recno(C),!r||f.selected()){for(var D=0;_>D;D++){if(u=a[D],c=u.field,g=f,f!==u.dataset){if(l)continue;p=!1;for(var E=t.master;;){if(!E)break;if(E.dataset===u.dataset){p=!0,g=E.dataset;break}E=E.master}if(!p)continue}if(d=u.dataType,d!==y||u.hasLookup){if(o=g.getFieldText(c),null===o||void 0===o||""===o)continue;if(d===m){var x=o.replace;x?o=jslet.removeHtmlTag(o):o+=""}this._convertToXLSXFormat(e,v,D,"s",o)}else{if(o=g.getFieldValue(c),null===o||void 0===o)continue;this._convertToXLSXFormat(e,v,D,"n",o)}}t.endRow=v;var R=t.details;if(R&&R.length>0){for(var b=0,T=R.length;T>b;b++)this._innerExportData(e,R[b],a,!1,l,i);v=t.endRow+1}else v++;var S=f.aggregatedValues();if(i&&C===j&&S){var k;for(D=0;_>D;D++)u=a[D],c=u.field,k=S[c],k&&(d=u.dataType,k=d===y?k.sum:k.count,k&&this._convertToXLSXFormat(e,v,D,"n",k));t.endRow=v}F=!0}var V=t.master;V&&V.endRow<t.endRow&&(V.endRow=t.endRow)}finally{f.endSilenceMove(h)}},_getExportFields:function(e,t,a){function r(e,t){if(e.dataset==t)return e;for(var e,a=topDsCfg.details,l=0,i=a.length;i>l;l++)if(e=a[l],e=r(e,t),!e)return e;return null}function l(e,t,a){var l,i=e.details;i||(i=[],e.details=i);var s=!1,n=r(e,t);i=n.details;for(var o=0,d=i.length;d>o;o++)if(l=i[o],l.dataset===a){s=!0;break}s||i.push({master:n,dataset:a})}var i,s,n,o,d,u,c,f,h=[],v={dataset:e};if(t&&t.length>0)for(d=0,u=t.length;u>d;d++){if(i=t[d],f={},i.indexOf(".")<0)f.dataset=e,f.field=i,s=e.getField(i);else{c=i.split(".");for(var _=e,g=0,p=c.length-1;p>g;g++)n=_.getField(c[g]),o=n.detailDataset(),l(v,_,o),_=o;i=c[p],f.dataset=o,f.field=i,s=o.getField(i)}f.label=s.label(),f.dataType=s.getType(),f.hasLookup=!!s.lookup(),h.push(f)}else{var F=e.getNormalFields();for(d=0,u=F.length;u>d;d++)s=F[d],s.visible()&&(i=s.name(),a&&a.length>0&&a.indexOf(i)>=0||(f={dataset:e,field:i},f.label=s.label(),f.dataType=s.getType(),f.hasLookup=!!s.lookup(),h.push(f)))}return{datasets:v,fields:h}}},jslet.data||(jslet.data={}),jslet.data.XPorter=function(){this._excelXPorter=null},jslet.data.XPorter.prototype={excelXPorter:function(e){return void 0===e?this._excelXPorter||jslet.data.XLSXXPorter:void(this._excelXPorter=e)}},jslet.data.defaultXPorter=new jslet.data.XPorter,jslet.data.IndexedDBMetaStore=function(e){var t=this;t._dbName=e,t._db=null},jslet.data.IndexedDBMetaStore.prototype={openDatabase:function(){var e=this,t=jQuery.Deferred(),a=indexedDB.open(this._dbName,1);return a.onsuccess=function(r){e._db=a.result,t.resolve()},a.onerror=function(e){console.error(e),t.reject()},a.onupgradeneeded=function(e){e.currentTarget.result.createObjectStore("datasetMeta",{keyPath:"name"})},t.promise()},getDatasetMeta:function(e){function t(){var t=jQuery.Deferred(),r=a._db.transaction("datasetMeta","readonly"),l=r.objectStore("datasetMeta").get(e);return l.onsuccess=function(e){t.resolve(e.target.result)},l.onerror=function(e){console.error(e),t.reject(null)},t.promise()}var a=this;if(a._db)return t();var r=jQuery.Deferred();return a.openDatabase().done(function(){t().done(function(e){r.resolve(e)}).fail(function(){r.reject()})}).fail(function(){r.reject()}),r.promise()},addDatasetMeta:function(e,t){jslet.Checker.test("addDatasetMeta#datasetName",e).required().isString(),jslet.Checker.test("addDatasetMeta#datasetMeta",t).required().isObject();var a=this;if(a._db){a._db.transaction("datasetMeta","readwrite");var r=transaction.objectStore("datasetMeta");r.put(e,t)}else a.openDatabase().done(function(){var r=a._db.transaction("datasetMeta","readwrite").objectStore("datasetMeta");t.name=e,r.add(t)});return this},addDatasetMetas:function(e){jslet.Checker.test("addDatasetMetas#datasetMetas",e).required().isArray();var t,a,r=this,l=e.length;for(t=l-1;t>=0;t--)a=e[t],a?jslet.Checker.test("addDatasetMeta#datasetName",a.name).required().isString():e.splice(t,1);if(r._db){r._db.transaction("datasetMeta","readwrite");var i=transaction.objectStore("datasetMeta");for(t=0;l>t;t++)a=e[t],i.put(a.name,a)}else r.openDatabase().done(function(){var i=r._db.transaction("datasetMeta","readwrite").objectStore("datasetMeta");for(t=0;l>t;t++)a=e[t],i.add(a)});return this}},jslet});
//# sourceMappingURL=jslet-data.min.js.map
